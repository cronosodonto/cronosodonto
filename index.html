<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cronos CRM</title>
<!-- build: v49 -->
  <style>
    /* =========================
       Cronos CRM (single-file)
       Phase 1: localStorage
       ========================= */

    :root{
      --bg:#0b0f14;
      --panel:#0f1621;
      --panel2:#111b2a;
      --text:#e8eef6;
      --muted:#a9b4c2;
      --brand:#7c5cff;
      --brand2:#2ee59d;
      --danger:#ff4d6d;
      --warn:#ffcc00;
      --ok:#2ee59d;
      --info:#46a7ff;
      --line:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color-scheme: dark;
    }

    /* Light theme overrides */
    :root.light{
      --bg:#f6f9ff;
      --panel:#ffffff;
      --panel2:#eff4ff;
      --text:#111827;
      --muted:#4b5563;
      --brand:#2563eb;
      --brand2:#06b6d4;
      --danger:#e11d48;
      --warn:#d97706;
      --ok:#16a34a;
      --info:#2563eb;
      --line:rgba(17,24,39,.12);
      --shadow: 0 10px 30px rgba(17,24,39,.10);
      color-scheme: light;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--font);
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(124,92,255,.18), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(46,229,157,.12), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    a{color:inherit}
    button,input,select,textarea{font:inherit}
    .hidden{display:none!important}
    .muted{color:var(--muted)}
    .nowrap{white-space:nowrap}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    /* Fix select options visibility on Windows */
    select{ color-scheme: light dark; }
    select option{ background: var(--panel2); color: var(--text); }

    .app{
      display:grid;
      grid-template-columns: 300px 1fr;
      min-height:100vh;
    }
    @media(max-width: 980px){
      .app{grid-template-columns: 1fr}
      .sidebar{position:sticky; top:0; height:auto}
    }

    .sidebar{
      border-right:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 60%), var(--panel);
      padding:16px;
      position:sticky; top:0; height:100vh; overflow:auto;
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(124,92,255,.16), rgba(46,229,157,.10));
      box-shadow: var(--shadow);
      margin-bottom:12px;
    }
    :root.light .brand{
      background: linear-gradient(135deg, rgba(37,99,235,.14), rgba(6,182,212,.10));
    }

    .logoBox{
      width:44px; height:44px; border-radius:14px;
      background: rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.14);
      display:grid; place-items:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    :root.light .logoBox{
      background: rgba(17,24,39,.04);
      border:1px solid rgba(17,24,39,.14);
    }
    .logoBox svg{width:30px;height:30px;display:block}
    .brand h1{font-size:15px; margin:0; line-height:1.1}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted)}

    .topTools{
      display:flex; gap:8px; margin-top:10px;
    }
    .iconBtn{
      width:42px; height:42px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      display:grid; place-items:center;
      transition:.15s ease;
    }
    .iconBtn:hover{transform:translateY(-1px); background: rgba(255,255,255,.06)}
    .iconBtn small{font-size:16px; line-height:1}

    .nav{
      display:flex; flex-direction:column; gap:8px;
      margin-top:12px;
    }
    .nav button{
      width:100%;
      text-align:left;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      display:flex; align-items:center; justify-content:space-between;
      cursor:pointer;
      transition: .15s ease;
    }
    .nav button:hover{transform: translateY(-1px); background: rgba(255,255,255,.05)}
    .nav button.active{
      border-color: rgba(124,92,255,.6);
      background: rgba(124,92,255,.14);
      box-shadow: 0 8px 20px rgba(124,92,255,.15);
    }
    :root.light .nav button.active{
      border-color: rgba(37,99,235,.55);
      background: rgba(37,99,235,.10);
      box-shadow: 0 10px 22px rgba(37,99,235,.12);
    }

    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      padding:2px 8px; border-radius:999px;
      background: rgba(0,0,0,.10);
    }
    :root.light .pill{ background: rgba(17,24,39,.04); }

    .sideFooter{
      margin-top:14px;
      padding-top:12px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
    }
    .sideFooter .row{display:flex; gap:8px; margin-top:10px}
    .sideFooter button{
      flex:1;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
    }
    .sideFooter button:hover{background: rgba(255,255,255,.06)}
    .danger{border-color: rgba(255,77,109,.45)!important}
    .danger:hover{background: rgba(255,77,109,.12)!important}

    .main{
      padding:18px;
      overflow:auto;
    }

    .topbar{
      display:flex; flex-wrap:wrap;
      gap:12px; align-items:center; justify-content:space-between;
      margin-bottom:12px;
    }
    .titleBlock h2{margin:0; font-size:18px}
    .titleBlock p{margin:3px 0 0; color:var(--muted); font-size:13px}

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition:.15s ease;
      display:inline-flex; gap:8px; align-items:center;
    }
    .btn:hover{transform:translateY(-1px); background: rgba(255,255,255,.06)}
    .btn.primary{
      border-color: rgba(124,92,255,.55);
      background: linear-gradient(135deg, rgba(124,92,255,.22), rgba(124,92,255,.08));
    }
    :root.light .btn.primary{
      border-color: rgba(37,99,235,.45);
      background: rgba(37,99,235,.10);
    }
    .btn.ok{
      border-color: rgba(46,229,157,.55);
      background: rgba(46,229,157,.10);
    }
    :root.light .btn.ok{
      border-color: rgba(22,163,74,.35);
      background: rgba(22,163,74,.10);
    }
    .btn.small{padding:8px 10px; border-radius:12px; font-size:13px}
    .btn.ghost{background:transparent}

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 45%), var(--panel);
      box-shadow: var(--shadow);
      padding:14px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media(min-width: 1100px){
      .grid.cols2{grid-template-columns: 1.15fr .85fr}
      .grid.cols3{grid-template-columns: 1fr 1fr 1fr}
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:12px;
    }
    @media(min-width: 900px){.kpis{grid-template-columns: repeat(4, 1fr)}}
    .kpi{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.03);
      padding:12px;
    }
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .value{font-size:20px; font-weight:800; margin-top:6px}
    .kpi .hint{font-size:12px; color:var(--muted); margin-top:4px}

    /* Sticky filter bar */
    .stickyFilters{
      position: sticky;
      top: 0;
      z-index: 20;
      background: color-mix(in srgb, var(--panel) 85%, transparent);
      backdrop-filter: blur(8px);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding:10px;
      margin-bottom:12px;
    }
    :root.light .stickyFilters{
      background: color-mix(in srgb, var(--panel) 95%, transparent);
    }
    .filtersRow{
      display:flex; flex-wrap:wrap; gap:10px; align-items:end;
    }
    .filtersRow > *{min-width: 180px}
    .filtersRow .grow{flex: 1 1 260px; min-width: 240px}

    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input,select,textarea{
      width:100%;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      outline:none;
    }
    textarea{min-height: 90px; resize: vertical}

    .tableWrap{overflow:auto; border-radius: var(--radius2); border:1px solid var(--line)}
    table{width:100%; border-collapse:collapse; min-width: 1200px; background: rgba(0,0,0,.10)}
    th,td{padding:10px 10px; border-bottom:1px solid var(--line); vertical-align:top; font-size:13px}
    th{position:sticky; top:0; background: color-mix(in srgb, var(--panel2) 92%, transparent); backdrop-filter: blur(8px); text-align:left; font-size:12px; color:var(--muted); z-index:1}
    tr:hover td{background: rgba(255,255,255,.03)}

    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:3px 8px; border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;
      background: rgba(255,255,255,.03);
    }
    .dot{width:8px; height:8px; border-radius:999px; background: var(--muted)}
    .dot.hot{background: var(--danger)}
    .dot.warm{background: var(--warn)}
    .dot.ok{background: var(--info)}
    :root.light .dot.ok{background: var(--brand)} /* stays blue */

    .actionsCell{display:flex; gap:8px; justify-content:flex-end; align-items:center; flex-wrap:wrap;}
    .miniBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size:13px;
    }
    .miniBtn:hover{background: rgba(255,255,255,.06)}
    .miniBtn.danger{border-color: rgba(255,77,109,.45)}
    .miniBtn.ok{border-color: rgba(46,229,157,.45)}

    /* Modal */
    .modalBg{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index: 50;
    }
    .modalBg.show{display:flex}
    .modal{
      width:min(980px, 100%);
      border:1px solid var(--line);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent 45%), var(--panel2);
      box-shadow: 0 20px 60px rgba(0,0,0,.6);
      padding:14px;
    
  max-height: 92vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
    .modalHead{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      margin-bottom:10px;
    }
    .modalHead h3{margin:0; font-size:15px}
    .x{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      width:38px; height:38px; border-radius: 14px;
      cursor:pointer;
    }
    .modalFoot{
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      margin-top:12px; padding-top:12px; border-top:1px solid var(--line);
    }
    .twoCol{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width: 900px){.twoCol{grid-template-columns: 1fr 1fr}}
    .threeCol{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width: 1100px){.threeCol{grid-template-columns: 1fr 1fr 1fr}}

    
/* Modal scroll (lead form) */
#modalBody{
      -webkit-overflow-scrolling: touch;
  overflow:auto;
  padding-right:6px;
  max-height: calc(92vh - 150px);
}

/* Kanban */
.kanbanWrap{
  display:grid;
  grid-template-columns: repeat(1, 1fr);
  gap:12px;
}
@media(min-width: 1100px){
  .kanbanWrap{grid-template-columns: repeat(5, 1fr);}
}
.kanCol{
  border:1px solid var(--line);
  border-radius: var(--radius2);
  background: rgba(255,255,255,.03);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  min-height: 320px;
}
.kanHead{
  padding:10px 10px;
  border-bottom:1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  background: color-mix(in srgb, var(--panel2) 92%, transparent);
  position:sticky;
  top:0;
  z-index:2;
}
.kanHead b{font-size:13px}
.kanList{
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
  overflow:auto;
}
.kanCard{
  border:1px solid var(--line);
  border-radius: 14px;
  padding:10px;
  background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 50%), var(--panel);
  cursor:grab;
}
.kanCard:active{cursor:grabbing}
.kanDropHint{
  border:1px dashed rgba(124,92,255,.55);
  background: rgba(124,92,255,.10);
}

.kanCard.kanSelected{
  outline:2px solid rgba(46,229,157,.65);
  box-shadow: 0 0 0 4px rgba(46,229,157,.14);
}
.kanCard.kanDragging{ opacity:.65; }

/* Tasks */
.taskBad{border-color: rgba(255,77,109,.55)!important}
.taskOk{border-color: rgba(46,229,157,.55)!important}
/* Autocomplete */
    .suggest{
      position: relative;
    }
    .suggestBox{
      position:absolute;
      top: calc(100% + 6px);
      left:0; right:0;
      border:1px solid var(--line);
      border-radius: 14px;
      background: var(--panel2);
      box-shadow: var(--shadow);
      max-height: 240px;
      overflow:auto;
      display:none;
      z-index: 60;
    }
    .suggestBox.show{display:block}
    .suggestItem{
      padding:10px 12px;
      cursor:pointer;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .suggestItem:hover{background: rgba(255,255,255,.06)}
    .suggestItem b{display:block; font-size:13px}
    .suggestItem small{display:block; color:var(--muted); margin-top:2px}

    /* Auth */
    .auth{
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:18px;
    }
    .authCard{
      width:min(520px, 100%);
      border:1px solid var(--line);
      border-radius: 26px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent 42%), var(--panel);
      box-shadow: var(--shadow);
      padding:16px;
    }

    /* Toast */
    .toast{
      position:fixed; right:16px; bottom:16px;
      border:1px solid var(--line);
      border-radius: 16px;
      background: color-mix(in srgb, var(--panel2) 92%, transparent);
      backdrop-filter: blur(8px);
      padding:10px 12px;
      box-shadow: var(--shadow);
      display:none;
      max-width: 420px;
      z-index: 80;
      font-size:13px;
      color: var(--text);
    }
    .toast.show{display:block}
    .toast .small{color:var(--muted); font-size:12px; margin-top:4px}

    .tagPill{
      display:inline-flex; align-items:center; gap:6px;
      padding:2px 8px;
      border-radius: 999px;
      border:1px dashed rgba(255,255,255,.18);
      color:var(--muted);
      font-size:12px;
      background: rgba(255,255,255,.02);
    }

  
/* Leads: scrollbar horizontal no topo + colunas fixas (Lead e Ações) */
.hscrollTop{overflow-x:auto;overflow-y:hidden;height:14px;border-radius:10px;margin:10px 0 8px 0;background:rgba(255,255,255,.03);}
.hscrollTop::-webkit-scrollbar{height:10px}
.hscrollTopInner{height:1px}
.leadsTableWrap .tableWrap{overflow-x:auto; position:relative;}
/* sticky primeira e última coluna (evita “sumir nome” ou “sumir ações”) */
.leadsTableWrap table thead th:first-child,
.leadsTableWrap table tbody td:first-child{
  position:sticky; left:0; z-index:4; background:rgba(10,14,22,.96);
  box-shadow: 8px 0 16px rgba(0,0,0,.35);
}
.leadsTableWrap table thead th:last-child,
.leadsTableWrap table tbody td:last-child{
  position:sticky; right:0; z-index:5; background:rgba(10,14,22,.96);
  box-shadow: -8px 0 16px rgba(0,0,0,.35);
}

/* Status dots — cores por status (Leads) */
.dot.st-yellow{background: #facc15;}
.dot.st-blue{background: #38bdf8;}
.dot.st-green{background: #22c55e;}
.dot.st-purple{background: #6366f1;}
.dot.st-orange{background: #fb923c;}
.dot.st-red{background: #ef4444;}
.dot.st-gray{background: #9ca3af;}

/* Leads: sem scroll horizontal + ações em linha + layout mais denso */
.leadsTableWrap .hscrollTop{display:none!important;}
.leadsTableWrap .tableWrap{overflow-x:visible!important;}
.leadsTableWrap table{min-width:0!important; width:100%!important; table-layout:fixed;}
.leadsTableWrap th, .leadsTableWrap td{word-break:break-word;}
.leadsTableWrap .nowrap{white-space:normal!important;}
.leadsTableWrap .actionsCell{display:flex; gap:8px; justify-content:flex-end; align-items:center; flex-wrap:nowrap; white-space:nowrap;}
/* Ajuste sutil de densidade */
.leadsTableWrap th, .leadsTableWrap td{padding:6px 8px!important; vertical-align:middle!important;}

/* === PATCH: Leads (scroll & actions) === */
#view-leads .tableWrap{overflow-x:auto; position:relative; border-radius:14px;}
#view-leads .tableWrap::-webkit-scrollbar{height:0px;}
#view-leads .tableWrap{scrollbar-width:none;}
#view-leads .tableWrap table{min-width:0 !important; width:100% !important; table-layout:fixed !important;}
#view-leads table thead th:first-child,
#view-leads table tbody td:first-child{
  position:sticky; left:0; z-index:3;
  background:linear-gradient(180deg, rgba(9,14,20,.96), rgba(9,14,20,.86));
}
#view-leads table thead th:last-child,
#view-leads table tbody td:last-child{
  position:sticky; right:0; z-index:4;
  background:linear-gradient(180deg, rgba(9,14,20,.96), rgba(9,14,20,.86));
}
#view-leads table thead th:last-child{z-index:6;}

/* Light theme: keep sticky columns consistent (no dark gradient blocks) */
.light #view-leads table thead th:first-child,
.light #view-leads table tbody td:first-child,
.light #view-leads table thead th:last-child,
.light #view-leads table tbody td:last-child{
  background: var(--panel2) !important;
}
.actionsCell{display:flex; flex-direction:row; flex-wrap:nowrap !important; gap:10px; justify-content:flex-end; align-items:center;}
.actionsCell .miniBtn{width:40px; height:40px;}
/* top horizontal scroller (always accessible) */
#leadsTopScroll{position:sticky; top:0; z-index:8; height:14px; margin:0 0 10px 0; border-radius:999px;
  background:rgba(255,255,255,.06); overflow-x:auto; overflow-y:hidden;}
#leadsTopScroll::-webkit-scrollbar{height:12px;}
#leadsTopScroll > .inner{height:1px;}


/* === PATCH: Charts spacing === */
#view-dashboard .card h3{margin:0 0 8px 0;}
#view-dashboard .chartTitle{margin-top:0;}
.chartNote{margin-top:0;}


/* ===== Patch v20-fix5: Leads actions overlap + tasks scroll + chart height ===== */
#leads .tableWrap table{width:100%; table-layout:fixed;}
#leads .tableWrap th, #leads .tableWrap td{overflow:hidden; text-overflow:ellipsis; white-space:normal;}
#leads .tableWrap th:nth-child(10), #leads .tableWrap td:nth-child(10){width:160px;} /* Datas */
#leads .tableWrap th:nth-child(11), #leads .tableWrap td:nth-child(11){width:150px;} /* Ações */
#leads .tableWrap td:nth-child(2){white-space:nowrap;} /* Contato */
#leads .tableWrap td:nth-child(3){white-space:nowrap;} /* Status pill */

.actionsCell{flex-wrap:nowrap !important; justify-content:flex-end; gap:10px;}
.actionsCell .btnIcon{flex:0 0 auto;}

#view-tasks .tableWrap table{width:100% !important; table-layout:fixed;}
#view-tasks .tableWrap th, #view-tasks .tableWrap td{overflow:hidden; text-overflow:ellipsis; white-space:normal;}
#view-tasks .tableWrap th:nth-child(1), #view-tasks .tableWrap td:nth-child(1){width:120px;} /* Status */
#view-tasks .tableWrap th:nth-child(3), #view-tasks .tableWrap td:nth-child(3){width:180px;} /* Lead */
#view-tasks .tableWrap th:nth-child(4), #view-tasks .tableWrap td:nth-child(4){width:130px;} /* Vencimento */
#view-tasks .tableWrap th:nth-child(6), #view-tasks .tableWrap td:nth-child(6){width:160px;} /* Ação */
#view-tasks .tableWrap th:nth-child(2), #view-tasks .tableWrap td:nth-child(2){width:auto;} /* Tarefa (wrap) */

.chartRow canvas{height:320px !important;}



/* ===== Patch v20-fix7: Leads overlap (actions x dates) + Tasks horizontal bar ===== */
#view-leads .tableWrap{
  overflow-x:auto !important;
}
#view-leads .tableWrap::-webkit-scrollbar{height:0 !important;}
#view-leads .tableWrap{scrollbar-width:none !important;}
/* Force the Leads table to scroll instead of squeezing columns (prevents overlap) */
#view-leads .tableWrap table{
  table-layout:auto !important;
  min-width: 1180px !important; /* enough for Dates + Actions */
  width: max(1180px, 100%) !important;
}
#view-leads th, #view-leads td{
  white-space: nowrap;
}
#view-leads td:first-child, #view-leads th:first-child{
  white-space: normal; /* lead name can wrap */
}
#view-leads th:nth-last-child(2), #view-leads td:nth-last-child(2){ /* Datas */
  width: 180px !important;
}
#view-leads th:last-child, #view-leads td:last-child{ /* Ações */
  width: 190px !important;
}
#view-leads .actionsCell{
  display:flex;
  flex-direction:row !important;
  flex-wrap:nowrap !important;
  gap:10px;
  justify-content:flex-end;
  align-items:center;
  min-width: 190px;
}
#view-leads .actionsCell .btnIcon,
#view-leads .actionsCell .miniBtn{
  flex: 0 0 auto;
}

/* Tasks: remove horizontal scrollbar by making the layout truly fixed-width */
#view-tasks .tableWrap{
  overflow-x:hidden !important;
}
#view-tasks table{
  width:100% !important;
  table-layout: fixed !important;
}
#view-tasks th, #view-tasks td{
  word-break: break-word;
}
#view-tasks th:nth-child(1), #view-tasks td:nth-child(1){width:110px !important;} /* Status */
#view-tasks th:nth-child(2), #view-tasks td:nth-child(2){width:340px !important;} /* Tarefa */
#view-tasks th:nth-child(3), #view-tasks td:nth-child(3){width:220px !important;} /* Lead */
#view-tasks th:nth-child(4), #view-tasks td:nth-child(4){width:130px !important;} /* Vencimento */
#view-tasks th:nth-child(5), #view-tasks td:nth-child(5){width:220px !important;} /* Obs */
#view-tasks th:nth-child(6), #view-tasks td:nth-child(6){width:160px !important;} /* Ação */


/* === Leads: layout em 2 linhas (Lead + Ações em cima; detalhes embaixo) === */
.leadsTableWrap table thead{ display:none; } /* os labels ficam no card */
.leadsTableWrap .leadsTable{ table-layout: auto; }
.leadsTableWrap .leadsTable th,
.leadsTableWrap .leadsTable td{ position: static !important; left:auto !important; right:auto !important; box-shadow:none !important; background:transparent !important; }
.leadCardRow > td{ padding: 10px 0 !important; border-bottom: none !important; }
.leadCard{
  background: var(--card);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 16px;
  padding: 14px 14px;
}
:root.light .leadCard{
  border-color: rgba(0,0,0,.10);
}
.leadCardTop{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:14px;
}
.leadCardLead{ min-width: 0; }
.leadCardName{
  font-weight: 800;
  font-size: 16px;
  line-height: 1.15;
  letter-spacing: .2px;
  word-break: break-word;
}
.leadCardSub{ margin-top: 6px; font-size: 12.5px; line-height: 1.2; }
.leadCardTags{ margin-top: 8px; display:flex; flex-wrap:wrap; gap:6px; }
.leadCardActions{ text-align:right; flex: 0 0 auto; }
.leadCardActionsTitle{
  font-size: 12px;
  margin-bottom: 8px;
}
.leadCardActions .actionsCell{
  display:flex !important;
  flex-direction: row !important;
  gap: 8px;
  justify-content: flex-end;
  align-items: center;
  flex-wrap: wrap;
}
.leadReadOnly{ margin-left: 8px; font-size: 12px; }
.leadCardBottom{
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid rgba(255,255,255,.08);
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 10px 12px;
}
:root.light .leadCardBottom{ border-top-color: rgba(0,0,0,.10); }
.leadField .lbl{
  font-size: 11px;
  letter-spacing: .12em;
  text-transform: uppercase;
  margin-bottom: 6px;
  opacity: .75;
}
:root.light .leadField .lbl{ opacity: .9; }
/* evita “sombra”/sobreposição visual no modo claro */
:root.light .leadCardActionsTitle,
:root.light .leadCardSub .muted,
:root.light .leadField .lbl{ color: rgba(0,0,0,.65) !important; }

/* --- Leads 2-row layout (no horizontal scroll) --- */
.leadsTable2row{table-layout:fixed;width:100%;}
.leadsTable2row th,.leadsTable2row td{white-space:normal;overflow-wrap:anywhere;}
.leadsTable2row thead th{font-weight:700;letter-spacing:.02em;}
.leadsTable2row .leadRowMain td{padding:14px 14px 10px;}
.leadsTable2row .leadRowSub td{padding:0 14px 14px;}
.leadsTable2row .leadRowSub td:first-child{border-bottom-left-radius:16px;}
.leadsTable2row .leadRowSub td:last-child{border-bottom-right-radius:16px;}
.leadsTable2row .leadRowMain td:first-child{border-top-left-radius:16px;}
.leadsTable2row .leadRowMain td:last-child{border-top-right-radius:16px;}

.leadsTableWrap .tableWrap{overflow-x:hidden;}
.leadsTable2row thead th:first-child,
.leadsTable2row tbody td:first-child,
.leadsTable2row thead th:last-child,
.leadsTable2row tbody td:last-child{position:static;left:auto;right:auto;box-shadow:none;}
/* Fix: no dark blocks on first/last columns in 2-row Leads layout */
.leadsTable2row tbody td:first-child,
.leadsTable2row tbody td:last-child{
  background: transparent !important;
}


.leadContactBox{display:flex;flex-direction:column;gap:6px;min-width:0;}
.leadName{font-size:18px;font-weight:800;line-height:1.15;}
.leadMetaRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
/* Tighter spacing in Lead/Contato (removes that '???' empty gap) */
.leadContactBox{gap:3px;}
.leadMetaRow{margin-top:2px;}
.leadName{line-height:1.1;}
.leadPhone{line-height:1.1;}

.leadPhone{opacity:.9;font-weight:700;}

.leadSubCell{display:flex;align-items:center;gap:12px;justify-content:center;}
.leadSubActions{justify-content:flex-end;}
.subLabel{font-size:12px;letter-spacing:.12em;opacity:.7;font-weight:800;}
.leadActionsRow{display:flex;gap:10px;align-items:center;flex-wrap:nowrap;}
.iconBtn{width:40px;height:40px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);display:inline-flex;align-items:center;justify-content:center;cursor:pointer;}
.iconBtn:hover{background:rgba(255,255,255,.08);}
.iconBtnOk{border-color:rgba(59,130,246,.35);}
.iconBtnDanger{border-color:rgba(239,68,68,.35);}

.statusPill{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10);font-weight:800;}
.emptyCell{padding:28px;text-align:center;opacity:.7;}

:root.light .leadsTable2row thead th{background:rgba(0,0,0,.04);color:rgba(0,0,0,.85);}
:root.light .iconBtn{border-color:rgba(0,0,0,.12);background:rgba(0,0,0,.03);}
:root.light .iconBtn:hover{background:rgba(0,0,0,.06);}
:root.light .statusPill{background:rgba(0,0,0,.03);border-color:rgba(0,0,0,.10);}


/* Summary (Dashboard) */
.summaryTable{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px;
  background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08);}
.summaryTable thead th{padding:12px 14px; font-size:12px; letter-spacing:.08em; text-transform:uppercase;
  background:rgba(255,255,255,.04); border-bottom:1px solid rgba(255,255,255,.07); color:rgba(255,255,255,.78);}
.summaryTable tbody td{padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.06); color:rgba(255,255,255,.86); font-size:14px;}
.summaryTable tbody tr:last-child td{border-bottom:none;}
.summaryTable .right{text-align:right;}
:root.light .summaryTable{background:rgba(0,0,0,.03); border-color:rgba(0,0,0,.08);}
:root.light .summaryTable thead th{background:rgba(0,0,0,.04); border-bottom-color:rgba(0,0,0,.08); color:rgba(0,0,0,.62);}
:root.light .summaryTable tbody td{border-bottom-color:rgba(0,0,0,.06); color:rgba(0,0,0,.82);}

/* Tasks action buttons — keep fully visible */
.tasksTable th:last-child, .tasksTable td:last-child{min-width:260px; width:260px;}
.tasksTable .actionsRow{display:flex; align-items:center; justify-content:flex-end; gap:10px; flex-wrap:nowrap;}
.tasksTable td:last-child{overflow:visible;}
.tasksTable td:last-child{padding-right:18px;}
.tasksTable{table-layout:fixed;}
.tasksTable th, .tasksTable td{white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.tasksTable td:nth-child(2){white-space:normal;} /* tarefa text can wrap a bit */

/* Better column sizing: keep actions inside, allow task to wrap instead of squeezing */
.tasksTable{width:100%;}
.tasksTable th, .tasksTable td{white-space:normal;} /* allow wrapping by default */
.tasksTable th:nth-child(1), .tasksTable td:nth-child(1){width:110px;}
.tasksTable th:nth-child(2), .tasksTable td:nth-child(2){width:28%;} /* tarefa */
.tasksTable th:nth-child(3), .tasksTable td:nth-child(3){width:22%;} /* lead */
.tasksTable th:nth-child(4), .tasksTable td:nth-child(4){width:120px;} /* vencimento */
.tasksTable th:nth-child(5), .tasksTable td:nth-child(5){width:auto;} /* obs */
.tasksTable th:nth-child(6), .tasksTable td:nth-child(6){width:230px; min-width:230px;}
.tasksTable td:nth-child(6){padding-right:26px;}
.tasksTable .actionsRow{justify-content:flex-end; gap:10px;}
.tasksTable .actionsRow{flex-wrap:nowrap;}
.tasksTable td:nth-child(6) .btn{flex:0 0 auto;}
/* Keep 'Abrir lead' below icons */
.tasksTable td:nth-child(6) .actionsCol{display:flex; flex-direction:column; align-items:flex-end; gap:8px;}

/* Leads 2-row header contrast in light mode */
:root.light .leadsTable2row thead th{background:rgba(0,0,0,.06); color:rgba(0,0,0,.75); border-bottom-color:rgba(0,0,0,.08);}
:root.light .leadsTable2row{background:rgba(0,0,0,.03); border-color:rgba(0,0,0,.08);}


/* --- FIX15: Leads table (2-row layout) - evita quebra/colunas fantasmas --- */
#view-leads .tableWrap{ overflow-x:hidden !important; }
#view-leads table{ width:100% !important; table-layout:fixed; }
#view-leads thead th{ font-weight:700; letter-spacing:.06em; text-transform:uppercase; font-size:.78rem; opacity:.9; }
#view-leads tbody td{ vertical-align:middle; }
#view-leads .leadCell .leadName{ white-space:normal; overflow:visible; text-overflow:clip; }
#view-leads .row2 .actionsCell{ justify-content:flex-end; }
@media (max-width: 900px){
  #view-leads table{ table-layout:auto; }
}



/* === FIX layout dashboard resumo/leads filtrados === */

/* Evita 'Resumo por Status' engolir a tela e esconder os Leads filtrados */
#dashByStatus .tableWrap{max-height:none; overflow:visible;}
#dashPreview{max-height:none; overflow:visible;}
    /* ===== Dashboard: Resumo por Status + Leads filtrados ===== */
    .dashSplit{display:grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); gap:14px; align-items:start;}
    .dashSplit > .card{min-width:0;}

@media (max-width:900px){.dashSplit{grid-template-columns: 1fr;}}
#dashByStatusTable{ table-layout: fixed; width: 100%; }
#dashByStatusTable th:nth-child(1), #dashByStatusTable td:nth-child(1){ width:55%; text-align:left; }
#dashByStatusTable th:nth-child(2), #dashByStatusTable td:nth-child(2){ width:15%; text-align:right; }
#dashByStatusTable th:nth-child(3), #dashByStatusTable td:nth-child(3){ width:30%; text-align:right; }

#dashByStatusTable td, #dashByStatusTable th{color:inherit;}

/* Status grid fallback (more robust than table in some environments) */
.statusGrid{
  display:grid;
  grid-template-columns: 1.6fr .6fr 1fr;
  width:100%;
  border:1px solid var(--line);
  border-radius:14px;
  overflow:hidden;
  background:rgba(255,255,255,.02);
}

/* cells (headers + body) */
.statusGrid > div,
.statusGrid .sgRow > div{
  padding:14px 20px;
  border-bottom:1px solid rgba(255,255,255,.08);
  color:inherit;
}

:root.light .statusGrid > div,
:root.light .statusGrid .sgRow > div{
  border-bottom:1px solid rgba(17,24,39,.10);
}

.statusGrid > div.sgHead{
  font-weight:700;
  letter-spacing:.06em;
  text-transform:uppercase;
  font-size:.78rem;
  opacity:.9;
  background:rgba(255,255,255,.03);
}

:root.light .statusGrid > div.sgHead{background:rgba(17,24,39,.03);}

.statusGrid .right{text-align:right;}
.statusGrid .center{text-align:center;}
.statusGrid .sgRow{display:contents;}
.statusGrid .sgRow:last-child > div{border-bottom:none;}
:root.light .statusGrid{background:rgba(17,24,39,.02);}
:root.light .statusGrid > div.sgHead{background:rgba(17,24,39,.04);}

:root.light #dashByStatusTable th{ color: rgba(0,0,0,.75); }

/* --- Summary table fit (no horizontal scroll) --- */
.tableWrap.noX{overflow-x:hidden;}
.summaryTable{width:100%; table-layout:fixed;}
.summaryTable th,.summaryTable td{padding:10px 12px;}
.summaryTable th:nth-child(2), .summaryTable td:nth-child(2){text-align:center;}
.summaryTable th:nth-child(3), .summaryTable td:nth-child(3){text-align:right;}
.summaryTable th,.summaryTable td{overflow:hidden; text-overflow:ellipsis;}
.summaryTable th:first-child,.summaryTable td:first-child{white-space:normal;}

    @media (max-width: 900px){ .dashSplit{grid-template-columns: 1fr;} }
    #dashStatusCard .tableWrap{overflow:visible; max-height:none;}
    #dashStatusCard table{width:100%; table-layout:fixed;}
    #dashStatusCard th:nth-child(1), #dashStatusCard td:nth-child(1){width:58%; text-align:left;}
    #dashStatusCard th:nth-child(2), #dashStatusCard td:nth-child(2){width:14%; text-align:center;}
    #dashStatusCard th:nth-child(3), #dashStatusCard td:nth-child(3){width:28%; text-align:right;}
    #dashStatusCard th, #dashStatusCard td{white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    #dashPreview{max-height:none; overflow:visible;}

/* Em telas menores, empilha bonito */
@media (max-width: 980px){
  .cols2{grid-template-columns:1fr;}
  #dashByStatus .tableWrap, #dashPreview{max-height:none;}
}



/* === FIX layout dashboard resumo/leads filtrados === */
html, body{overflow-x:hidden;}


/* === FIX layout dashboard resumo/leads filtrados === */

/* Light mode: garante fundos coerentes em tabelas/cartões */
html.light .tableWrap{background:var(--panel);}
html.light .tableWrap th{background:var(--panel2); color:var(--text);}
html.light .tableWrap td{background:transparent; color:var(--text);}
html.light .card, html.light .panel{background:var(--panel); color:var(--text);}



/* =========================
   PATCH: Dashboard (Resumo por Status + Leads filtrados) side-by-side
   ========================= */
#view-dashboard .grid.cols2{
  grid-template-columns: 50% 50%;
  gap: 12px;
  align-items: start;
}
@media (max-width: 980px){
  #view-dashboard .grid.cols2{ grid-template-columns: 1fr; }
}
#view-dashboard #dashStatusCard,
#view-dashboard #dashPreviewCard{ min-width: 0; }

/* Resumo por Status: sem scroll + colunas alinhadas */
#view-dashboard #dashStatusCard,
#view-dashboard #dashStatusCard .kpiCard,
#view-dashboard #dashStatusCard .tableWrap{
  overflow: hidden !important;
}
#view-dashboard #dashStatusCard .tableWrap{
  max-height: none !important;
  scrollbar-width: none; /* Firefox */
}
#view-dashboard #dashStatusCard .tableWrap::-webkit-scrollbar{
  width: 0; height: 0; /* Chrome/Edge */
}
#view-dashboard #dashStatusCard table{
  width: 100%;
  max-width: 100%;
  table-layout: fixed;
}
#view-dashboard #dashStatusCard th,
#view-dashboard #dashStatusCard td{
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
#view-dashboard #dashStatusCard th:nth-child(1){ width: 45%; text-align:left; }
#view-dashboard #dashStatusCard th:nth-child(2),
#view-dashboard #dashStatusCard td:nth-child(2){ width: 15%; text-align: center; }
#view-dashboard #dashStatusCard th:nth-child(3),
#view-dashboard #dashStatusCard td:nth-child(3){ width: 40%; text-align: right; }
#view-dashboard #dashPreview{max-height:520px; overflow-y:auto; overflow-x:hidden; padding-right:4px;}

/* Prevent horizontal scroll caused by wide KPI/graph content */
html, body{ overflow-x: hidden; }


#dashByStatus table{ table-layout: fixed; width: 100%; }
#dashByStatus th:nth-child(1), #dashByStatus td:nth-child(1){ width:50%; text-align:left; }
#dashByStatus th:nth-child(2), #dashByStatus td:nth-child(2){ width:20%; text-align:center; }
#dashByStatus th:nth-child(3), #dashByStatus td:nth-child(3){ width:30%; text-align:right; }


/* ===== Parcelamentos ===== */
.instRow{border:1px solid var(--line); border-radius:14px; padding:12px; margin:10px 0; background:rgba(255,255,255,.02);}
.instHead{display:flex; gap:10px; align-items:flex-start; justify-content:space-between;}
.instName{font-weight:800;}
.instMeta{display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;}
.chip{display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid var(--line); font-size:12px; color:var(--muted);}
.chip b{color:var(--text); font-weight:800;}
.instBtns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
.instBody{margin-top:10px; border-top:1px dashed var(--line); padding-top:10px; display:none;}
.instRow.open .instBody{display:block;}
.instTable{width:100%; border-collapse:collapse; font-size:13px;}
.instTable th,.instTable td{padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.06); vertical-align:top;}
.badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line);}
.badge.ok{color:var(--ok);}
.badge.late{color:var(--danger);}
.badge.pending{color:var(--warn);}
.miniLink{color:var(--info); text-decoration:none; font-weight:700;}


/* v23: dashboard/cards responsivo em telas grandes (sem sobrepor) */
.kpiGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;}
.topbar{flex-wrap:wrap;}
.topbar .actions{flex-wrap:wrap;}

/* ===== Tooltips (gráficos) ===== */
#chartTooltip{
  position:fixed; z-index:99999; pointer-events:none;
  background:rgba(0,0,0,0.82); color:#fff;
  padding:8px 10px; border-radius:10px;
  font-size:12px; line-height:1.25;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
  transform: translate(-50%, -120%);
  max-width: 260px;
  display:none;
}
:root.light #chartTooltip{background:rgba(30,30,30,0.9);}
#chartTooltip .ttTitle{font-weight:700; margin-bottom:4px;}
#chartTooltip .ttRow{display:flex; gap:8px; justify-content:space-between;}
#chartTooltip .ttDot{width:8px; height:8px; border-radius:99px; margin-top:4px;}


/* KPI clicável */
.kpi[data-kpi]{cursor:pointer; user-select:none;}
.kpi[data-kpi]:hover{transform: translateY(-1px); box-shadow: 0 12px 30px rgba(0,0,0,.18);}
.kpi.kpiActive{outline:2px solid rgba(124,92,255,.9); box-shadow: 0 12px 30px rgba(124,92,255,.20);}
.tagList{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;}
.tagPill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:rgba(255,255,255,.05);}
:root.light .tagPill{background:rgba(17,24,39,.05);}
:root.light .kpi[data-kpi]:hover{box-shadow: 0 12px 30px rgba(0,0,0,.12);}


/* ===== Leads (aba) em formato de cards ===== */

#view-leads .badge{
  display:inline-flex; align-items:center; gap:6px;
  font-size:12px; font-weight:800;
  padding:6px 10px; border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  white-space:nowrap;
}
#view-leads .badge.hot{border-color: rgba(255,82,82,.35); background: rgba(255,82,82,.10);}
#view-leads .badge.warm{border-color: rgba(255,200,87,.35); background: rgba(255,200,87,.10);}
#view-leads .badge.cold{border-color: rgba(90,184,255,.35); background: rgba(90,184,255,.10);}
#view-leads .badge.neutral{opacity:.8;}

#view-leads .leadsCards{display:flex; flex-direction:column; gap:12px;}
#view-leads .leadCard{
  background: linear-gradient(180deg, rgba(255,255,255,.035), transparent 55%), var(--panel2);
  border:1px solid rgba(255,255,255,.07);
  border-radius:16px;
  padding:14px;
  box-shadow: 0 8px 26px rgba(0,0,0,.25);
}
#view-leads .leadCard:hover{border-color: rgba(124,92,255,.55); transform: translateY(-1px);}
#view-leads .leadCardTop{display:flex; align-items:flex-start; justify-content:space-between; gap:12px;}
#view-leads .leadTitle{display:flex; flex-direction:column; gap:6px; min-width:0;}
#view-leads .leadNameRow{display:flex; gap:10px; align-items:center; min-width:0;}
#view-leads .leadNameRow .name{font-weight:800; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
#view-leads .leadMeta{font-size:12px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap;}
#view-leads .leadGrid{display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; margin-top:12px;}
#view-leads .kv{background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:10px;}
#view-leads .kv .k{font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:rgba(255,255,255,.7);}
:root.light #view-leads .kv .k{color:rgba(17,24,39,.70);}
:root.light .leadCard .kv .k{color:rgba(17,24,39,.78)!important;}

#view-leads .kv .v{margin-top:4px; font-weight:700; color:var(--text); word-break:break-word;}
#view-leads .leadCardBottom{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:12px;}
#view-leads .leadActionsRow{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
#view-leads .leadActionsRow .iconBtn{border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.04);}
#view-leads .leadActionsRow .iconBtn:hover{border-color: rgba(124,92,255,.55);}
@media (max-width: 1100px){
  #view-leads .leadGrid{grid-template-columns: repeat(2, minmax(0,1fr));}
}
@media (max-width: 640px){
  #view-leads .leadGrid{grid-template-columns: 1fr;}
  #view-leads .leadCardBottom{flex-direction:column; align-items:stretch;}
}


/* ===== Tasks: action buttons alignment ===== */
.taskActionsCell{display:flex;flex-direction:column;gap:8px;align-items:flex-end;padding-right:16px;}
.taskActionsCell .miniBtn{flex:0 0 auto;}
.taskActionsCell .taskOpenLead{align-self:flex-end;}

.taskActionsRow{display:flex;gap:10px;justify-content:flex-end;flex-wrap:nowrap;}
.taskActionsRow .miniBtn{min-width:36px;}
#view-tasks td:last-child{padding-right:16px;}

/* =========================
   v52 – Refinos de layout
   - Resumo por Status com respiro e alinhamento financeiro
   - Tarefas com colunas balanceadas e quebra de linha na Tarefa
   ========================= */

/* Resumo por Status (Status | Total | Valor) */
.summaryTable{width:100%; border-collapse:separate; border-spacing:0;}
.summaryTable thead th, .summaryTable tbody td{padding:14px 20px;}
.summaryTable thead th:first-child, .summaryTable tbody td:first-child{padding-left:22px;}
.summaryTable thead th:last-child, .summaryTable tbody td:last-child{padding-right:22px;}
.summaryTable thead th:nth-child(2), .summaryTable tbody td:nth-child(2){text-align:center; width:90px;}
.summaryTable thead th:nth-child(3), .summaryTable tbody td:nth-child(3){text-align:right; width:170px;}

/* Tarefas – colunas e ações */
.tasksTable{width:100%; table-layout:fixed;}
.tasksTable th, .tasksTable td{vertical-align:top;}
.tasksTable th:nth-child(1), .tasksTable td:nth-child(1){width:140px;} /* Status */
.tasksTable th:nth-child(4), .tasksTable td:nth-child(4){width:130px;} /* Vencimento */
.tasksTable th:nth-child(6), .tasksTable td:nth-child(6){width:260px; min-width:260px;} /* Ação */
.tasksTable th:nth-child(2), .tasksTable td:nth-child(2){width:36%;} /* Tarefa */
.tasksTable th:nth-child(3), .tasksTable td:nth-child(3){width:24%;} /* Lead */
.tasksTable th:nth-child(5), .tasksTable td:nth-child(5){width:auto;} /* Obs */

.tasksTable td:nth-child(2){
  white-space:normal;
  word-break:break-word;
  overflow-wrap:anywhere;
  line-height:1.35;
}
.tasksTable td:nth-child(3), .tasksTable td:nth-child(5){white-space:normal;}

/* Aproxima Lead de Tarefa sem esmagar o resto */
.tasksTable th:nth-child(2), .tasksTable td:nth-child(2){padding-right:10px;}
.tasksTable th:nth-child(3), .tasksTable td:nth-child(3){padding-left:10px;}

/* Ações: ícones em cima, Abrir lead embaixo, sem cortar */
.tasksTable td:last-child{padding-right:28px; overflow:visible;}
.tasksTable td:last-child .actionsCol{align-items:flex-end;}
.tasksTable td:last-child .actionsRow{gap:8px; justify-content:flex-end; flex-wrap:nowrap;}



/* =========================
   v53 – Ajustes finos (pedido André)
   - Resumo por Status: mais respiro, colunas equilibradas, alinhamento financeiro
   - Tarefas: coluna Ação sem corte, quebra de linha na Tarefa sem esmagar o resto
   ========================= */

/* Dashboard: Resumo por Status (grid) — alinhado tipo "tabela limpa" */
#dashByStatusGrid.statusGrid{
  grid-template-columns: 1.55fr .65fr 1fr !important;
}
#dashByStatusGrid.statusGrid > div.sgHead{
  padding:14px 20px !important;
}
#dashByStatusGrid.statusGrid > div.sgHead:nth-child(1){ text-align:left !important; }
#dashByStatusGrid.statusGrid > div.sgHead:nth-child(2){ text-align:center !important; }
#dashByStatusGrid.statusGrid > div.sgHead:nth-child(3){ text-align:right !important; }

#dashByStatusGrid.statusGrid .sgRow > div{
  padding:14px 20px !important;
}
#dashByStatusGrid.statusGrid .sgRow > div:nth-child(1){ text-align:left !important; }
#dashByStatusGrid.statusGrid .sgRow > div:nth-child(2){ text-align:center !important; }
#dashByStatusGrid.statusGrid .sgRow > div:nth-child(3){ text-align:right !important; }

/* Tarefas: evita cortar ações e melhora distribuição */
#view-tasks .tableWrap{ overflow-x:hidden !important; }
#view-tasks .tasksTable{ table-layout:fixed !important; width:100% !important; }
#view-tasks .tasksTable th:nth-child(6),
#view-tasks .tasksTable td:nth-child(6){
  width:300px !important;
  min-width:300px !important;
}
#view-tasks .tasksTable td:nth-child(6){
  padding-right:42px !important;
  overflow:visible !important;
}
#view-tasks .tasksTable th:nth-child(2),
#view-tasks .tasksTable td:nth-child(2){
  width:40% !important;
}
#view-tasks .tasksTable th:nth-child(3),
#view-tasks .tasksTable td:nth-child(3){
  width:22% !important;
}
#view-tasks .tasksTable td:nth-child(2){
  white-space:normal !important;
  word-break:break-word !important;
  overflow-wrap:anywhere !important;
  line-height:1.35 !important;
}
#view-tasks .tasksTable td:nth-child(3),
#view-tasks .tasksTable td:nth-child(5){
  white-space:normal !important;
}


.chart-inline-value{margin-left:10px;font-weight:800;letter-spacing:0.2px;color:rgba(235,240,255,0.95);} 
</style>
</head>
<body>

<script>

// ===== SAFE PATCH: debounce fallback =====
function debounce(fn, delay){
  let t;
  return function(...args){
    clearTimeout(t);
    t = setTimeout(()=>fn.apply(this,args), delay||300);
  };
}
// ==========================================

(function(){
  // Error handler:
  // - BEFORE boot: show auth fallback + message.
  // - AFTER boot: keep the current screen, only show a toast with the error (não derruba a sessão).
  function showToast(title, message, type = 'info') {
    // Produção: sem notificações visuais (evita "tag" no canto).
    try {
      const prefix = type ? `[${String(type).toUpperCase()}]` : '[INFO]';
      console.log(prefix, title || '', message || '');
    } catch (e) {}
  }

  function fallbackBeforeBoot(msg){
    try{
      var a=document.getElementById('authView');
      var b=document.getElementById('appView');
      if(a) a.classList.remove('hidden');
      if(b) b.classList.add('hidden');
      showToast(msg || 'Falha ao iniciar.');
    }catch(e){}
  }

  function handleErr(msg){
    // If already booted, do NOT change screens—just report.
    if(window.__CRONOS_BOOTED){
      showToast(msg || 'Erro inesperado.');
      return;
    }
    fallbackBeforeBoot(msg);
  }

  window.addEventListener('error', function(e){ handleErr(e && e.message); });
  window.addEventListener('unhandledrejection', function(e){
    var r = e && e.reason;
    handleErr(r && (r.message || r) );
  });

  // If nothing shows after 1s, force auth visible (only if not booted).
  setTimeout(function(){
    if(window.__CRONOS_BOOTED) return;
    var a=document.getElementById('authView');
    var b=document.getElementById('appView');
    if(a && b && a.classList.contains('hidden') && b.classList.contains('hidden')){
      fallbackBeforeBoot('Boot não exibiu nenhuma tela (fallback automático).');
    }
  }, 1000);
})();

/* =========================
   Parcelamentos (v20+)
   - guarda por entry.installPlan + entry.installments[]
   - lista por paciente no view-installments
   ========================= */

function parseMoney(v){
  const n = Number(v);
  return (isFinite(n) && !isNaN(n)) ? n : 0;
}
function isoDate(d){ return (d instanceof Date) ? d.toISOString().slice(0,10) : String(d||"").slice(0,10); }
function addMonthsISO(iso, k){
  const [y,m,d] = iso.split("-").map(x=>parseInt(x,10));
  const dt = new Date(y, (m-1)+k, d||1);
  // keep day stable-ish (JS auto rolls)
  return isoDate(dt);
}
function monthKeyOf(iso){ return (iso||"").slice(0,7); }

function ensureInstallmentsForEntry(entry){
  // garante que exista um "plano" + parcelas geradas (compat v20)
  entry.installments = entry.installments || [];

  // Se tem plano mas ainda não tem parcelas, gera agora
  if(entry.installPlan && (!Array.isArray(entry.installments) || entry.installments.length===0)){
    try{ buildInstallments(entry); }catch(e){ console.warn("buildInstallments falhou:", e); }
  }

  // Normaliza chaves legadas e status
  (entry.installments||[]).forEach(p=>{
    if(p.due && !p.dueDate) p.dueDate = p.due;
    if(p.paid && !p.paidAt) p.paidAt = p.paid;
    if(!p.payMethod && entry.installPlan?.payMethod) p.payMethod = entry.installPlan.payMethod;
    if(!p.total && entry.installPlan?.n) p.total = parseInt(entry.installPlan.n||0,10) || p.total || 0;
    if(!p.status){
      p.status = p.paidAt ? "PAGA" : "PENDENTE";
    }
    // Se já pagou, força status
    if(p.paidAt && p.status!=="PAGA") p.status="PAGA";
  });
}

function buildInstallments(entry){
  // uses entry.installPlan
  const plan = entry.installPlan;
  if(!plan) return;
  const amt = parseMoney(plan.amount);
  const n = Math.max(1, parseInt(plan.n||1,10));
  const each = n ? (amt / n) : 0;
  let first = plan.firstDue;
  if(!first){
    const today = new Date();
    const next = new Date(today.getFullYear(), today.getMonth()+1, today.getDate());
    first = isoDate(next);
  }
  entry.installments = [];
  for(let i=1;i<=n;i++){
    entry.installments.push({
      number:i,
      total:n,
      amount: Number(each.toFixed(2)),
      dueDate: addMonthsISO(first, i-1),
      status:"PENDENTE",
      paidAt:"",
      payMethod: plan.payMethod || ""
    });
  }
}

function syncInstallmentTasks(db, actor){
  // cria/atualiza tarefas de inadimplência (apenas para atrasos)
  const today = todayISO();
  const masterId = actor?.masterId;
  if(!masterId) return;

  const contactsById = new Map((db.contacts||[]).filter(c=>c.masterId===masterId).map(c=>[c.id,c]));
  const entries = (db.entries||[]).filter(e=>e.masterId===masterId);
  const tasks = db.tasks || (db.tasks=[]);

  function taskKey(entryId, dueDate, number){
    return `INST:${entryId}:${dueDate}:${number}`;
  }

  // mark all existing installment tasks as not seen; we'll reconcile
  const seen = new Set();

  entries.forEach(e=>{
    if(!e.installPlan) return;
    ensureInstallmentsForEntry(e);
    (e.installments||[]).forEach(p=>{
      const due = p.dueDate;
      const isPaid = !!p.paidAt || p.status==="PAGA";
      const isLate = due && due < today && !isPaid;
      if(!isLate) return;

      const key = taskKey(e.id, due, p.number);
      seen.add(key);

      let t = tasks.find(x=>x.masterId===masterId && x.key===key);
      const c = contactsById.get(e.contactId) || {name:"(sem nome)", phone:""};
      const title = `Inadimplente: ${c.name} • Parcela ${p.number}/${p.total}`;
      const desc = `Venc: ${fmtBR(due)} • ${moneyBR(p.amount)} • ${p.payMethod||e.installPlan.payMethod||"—"}`;
      if(!t){
        t = { id: uid("t"), masterId, key, entryId: e.id, title, action:"WhatsApp", notes: desc, done:false, createdAt:new Date().toISOString(), dueDate: due, phone:c.phone, wa: true };
        tasks.push(t);
      }else{
        t.title = title;
        t.notes = desc;
        if(!t.action) t.action = "WhatsApp";
        if(!t.entryId) t.entryId = e.id;
        t.dueDate = due;
        t.phone = c.phone;
        if(isPaid) t.done = true;
      }
    });
  });

  // optional: we don't delete tasks, just keep.
}

function installmentsKPIs(db, actor, monthKey){
  const today = todayISO();
  const masterId = actor?.masterId;
  const entries = (db.entries||[]).filter(e=>e.masterId===masterId && e.installPlan);
  let monthSum=0, monthN=0, lateSum=0, lateN=0, futureSum=0, futureN=0;

  entries.forEach(e=>{
    ensureInstallmentsForEntry(e);
    (e.installments||[]).forEach(p=>{
      const due = p.dueDate;
      const paid = !!p.paidAt || p.status==="PAGA";
      if(paid) return;
      if(due && monthKeyOf(due)===monthKey){ monthSum += p.amount; monthN++; }
      if(due && due < today){ lateSum += p.amount; lateN++; }
      if(due && due > today){ futureSum += p.amount; futureN++; }
    });
  });
  return {monthSum, monthN, lateSum, lateN, futureSum, futureN};
}

function entryInstallmentSummary(entry){
  ensureInstallmentsForEntry(entry);
  const today = todayISO();
  const pending = (entry.installments||[]).filter(p=>!(p.paidAt||p.status==="PAGA"));
  const paidCount = (entry.installments||[]).length - pending.length;
  let nextDue = "";
  pending.sort((a,b)=> (a.dueDate||"").localeCompare(b.dueDate||""));
  if(pending.length) nextDue = pending[0].dueDate || "";
  const lateCount = pending.filter(p=>p.dueDate && p.dueDate < today).length;
  return {paidCount, total:(entry.installments||[]).length, nextDue, lateCount};
}

function renderInstallmentsView(){
  const actor = currentActor();
  if(!actor){ showAuth(); return; }
  const db = loadDB();

    // normalize legacy tasks/payments (compat)
    (db.tasks||[]).forEach(t=>{
      if(!t.masterId) t.masterId = actor.masterId;
      if(!t.entryId && typeof t.key==="string" && t.key.startsWith("INST:")){
        const parts = t.key.split(":");
        if(parts.length>=3) t.entryId = parts[1];
      }
      if(!t.title && t.name) t.title = t.name;
      if(!t.notes && t.desc) t.notes = t.desc;
      if(!t.action && t.wa) t.action = "WhatsApp";
      if(t.done==null && t.status!=null){
        t.done = (String(t.status).toLowerCase().includes("feito") || String(t.status).toLowerCase().includes("done") || String(t.status).toLowerCase().includes("concl"));
      }
      if(t.done==null) t.done = false;
    });
    (db.payments||[]).forEach(p=>{
      if(!p.masterId) p.masterId = actor.masterId;
      if(!p.date && p.at) p.date = String(p.at).slice(0,10);
    });

  // default month
  const mm = el("instMonth");
  const nowMK = new Date().toISOString().slice(0,7);
  if(mm && !mm.value) mm.value = nowMK;

  // KPIs
  const mk = mm?.value || nowMK;
  const k = installmentsKPIs(db, actor, mk);
  el("kpiInstMonth").textContent = moneyBR(k.monthSum);
  el("kpiInstMonthN").textContent = `${k.monthN} parcelas`;
  el("kpiInstLate").textContent = moneyBR(k.lateSum);
  el("kpiInstLateN").textContent = `${k.lateN} parcelas`;
  el("kpiInstFuture").textContent = moneyBR(k.futureSum);
  el("kpiInstFutureN").textContent = `${k.futureN} parcelas`;

  // pills
  const pill = el("pillInst");
  if(pill) pill.textContent = String(k.lateN || 0);

  const q = (el("instSearch")?.value||"").trim().toLowerCase();
  const filter = (el("instFilter")?.value||"all");
  const today = todayISO();

  const contactsById = new Map((db.contacts||[]).filter(c=>c.masterId===actor.masterId).map(c=>[c.id,c]));
  const entries = (db.entries||[]).filter(e=>e.masterId===actor.masterId && e.installPlan);

  // group by contact (show one row per lead entry; if multiple months exist, show most recent with plan)
  const rows = [];
  entries.forEach(e=>{
    ensureInstallmentsForEntry(e);
    const c = contactsById.get(e.contactId) || {name:"(sem nome)", phone:""};
    const hay = `${c.name} ${c.phone}`.toLowerCase();
    if(q && !hay.includes(q)) return;

    const sum = entryInstallmentSummary(e);
    // compute per lead for month/late/future (pending only)
    let mSum=0, lSum=0, fSum=0;
    (e.installments||[]).forEach(p=>{
      const paid = !!p.paidAt || p.status==="PAGA";
      if(paid) return;
      if(p.dueDate && monthKeyOf(p.dueDate)===mk) mSum += p.amount;
      if(p.dueDate && p.dueDate < today) lSum += p.amount;
      if(p.dueDate && p.dueDate > today) fSum += p.amount;
    });

    if(filter==="dueMonth" && mSum<=0) return;
    if(filter==="late" && lSum<=0) return;
    if(filter==="open" && fSum<=0) return;

    rows.push({e,c,sum,mSum,lSum,fSum});
  });

  // sort: late first, boleto first, next due soon
  rows.sort((A,B)=>{
    const aLate = A.sum.lateCount>0 ? 1:0;
    const bLate = B.sum.lateCount>0 ? 1:0;
    if(aLate!==bLate) return bLate-aLate;
    const aBol = ((A.e.installPlan?.payMethod||"")==="Boleto")?1:0;
    const bBol = ((B.e.installPlan?.payMethod||"")==="Boleto")?1:0;
    if(aBol!==bBol) return bBol-aBol;
    return (A.sum.nextDue||"9999").localeCompare(B.sum.nextDue||"9999");
  });

  const list = el("instList");
  if(!list) return;
  list.innerHTML = rows.map(({e,c,sum,mSum,lSum,fSum})=>{
    const pm = e.installPlan?.payMethod || "—";
    const each = e.installPlan?.each ? moneyBR(e.installPlan.each) : moneyBR((parseMoney(e.installPlan.amount)||0)/Math.max(1,parseInt(e.installPlan.n||1,10)));
    const next = sum.nextDue ? fmtBR(sum.nextDue) : "—";
    const lateBadge = sum.lateCount>0 ? `<span class="badge late">⚠️ ${sum.lateCount} atraso</span>` : `<span class="badge ok">✅ em dia</span>`;
    const rowId = `instrow_${e.id}`;
    return `
      <div class="instRow" id="${rowId}">
        <div class="instHead">
          <div style="min-width:0">
            <div class="instName">${escapeHTML(c.name)} <span class="muted" style="font-weight:600">• ${escapeHTML(c.phone||"")}</span></div>
            <div class="instMeta">
              <span class="chip">Parcelas: <b>${sum.paidCount}/${sum.total}</b></span>
              <span class="chip">Forma: <b>${escapeHTML(pm)}</b></span>
              <span class="chip">Próx.: <b>${escapeHTML(next)}</b></span>
              <span class="chip">Parcela: <b>${each}</b></span>
              ${lateBadge}
            </div>
            <div class="instMeta">
              <span class="chip">Mês: <b>${moneyBR(mSum)}</b></span>
              <span class="chip">Atrasado: <b>${moneyBR(lSum)}</b></span>
              <span class="chip">Futuro: <b>${moneyBR(fSum)}</b></span>
            </div>
          </div>
          <div class="instBtns">
            <button class="btn" onclick="openLeadEntry('${e.id}')">Abrir lead</button>
            <button class="btn primary" onclick="toggleInstRow('${e.id}')">Ver parcelas</button>
          </div>
        </div>
        <div class="instBody">
          ${renderInstallmentTable(e,c)}
        </div>
      </div>
    `;
  }).join("");

  // restore open states
  try{
    window.__instOpen = window.__instOpen || {};
    Object.keys(window.__instOpen).forEach(id=>{
      if(window.__instOpen[id]){
        const rr = el(`instrow_${id}`);
        if(rr) rr.classList.add("open");
      }
    });
  }catch(e){} 

  if(!rows.length){
    list.innerHTML = `<div class="muted">Nenhum parcelamento encontrado. Cadastre no lead (Entrada / Valor para parcelar / Vezes / 1º vencimento).</div>`;
  }
}

function toggleInstRow(entryId){
  window.__instOpen = window.__instOpen || {};
  const row = el(`instrow_${entryId}`);
  if(!row) return;
  row.classList.toggle("open");
  window.__instOpen[entryId] = row.classList.contains("open");
}

function renderInstallmentTable(entry, contact){
  ensureInstallmentsForEntry(entry);
  const today = todayISO();
  const pmDefault = entry.installPlan?.payMethod || "";
  const rows = (entry.installments||[]).map(p=>{
    const paid = !!p.paidAt || p.status==="PAGA";
    const late = !paid && p.dueDate && p.dueDate < today;
    const st = paid ? `<span class="badge ok">PAGO</span>` : (late ? `<span class="badge late">ATRASADO</span>` : `<span class="badge pending">PENDENTE</span>`);
    const action = paid
      ? `<a class="miniLink" href="javascript:void(0)" onclick="undoInstallmentPay('${entry.id}', ${p.number})">Desfazer</a>`
      : `<button class="btn ok" onclick="payInstallment('${entry.id}', ${p.number})">Dar baixa</button>`;
    const wa = !paid ? `<a class="miniLink" href="${waChargeLink(contact.phone, contact.name, entry, p)}" target="_blank">Cobrar</a>` : "";
    return `
      <tr>
        <td class="mono">${p.number}/${p.total}</td>
        <td class="mono">${p.dueDate?fmtBR(p.dueDate):"—"}</td>
        <td class="mono">${moneyBR(p.amount)}</td>
        <td>${escapeHTML(p.payMethod||pmDefault||"—")}</td>
        <td>${st} ${p.paidAt?`<div class="muted" style="font-size:12px">em ${fmtBR(p.paidAt)}</div>`:""}</td>
        <td style="white-space:nowrap; display:flex; gap:10px; align-items:center">${action} ${wa}</td>
      </tr>
    `;
  }).join("");

  return `
    <table class="instTable">
      <thead><tr>
        <th>Parcela</th><th>Venc.</th><th>Valor</th><th>Forma</th><th>Status</th><th>Ações</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function waChargeLink(phone, nome, entry, parcela){
  const clean = String(phone||"").replace(/\D/g,"");
  const p = parcela || {};
  const db = loadDB();
  const tplDefault = `Oi {nome}! 😊\nSó pra lembrar: a parcela {parcela}/{total} de {valor} vence em {vencimento}. Posso te ajudar por aqui?`;
  const tpl = (db.settings && db.settings.waChargeTemplate) ? String(db.settings.waChargeTemplate) : tplDefault;

  const msg = tpl
    .replaceAll("{nome}", String(nome||""))
    .replaceAll("{parcela}", String(p.number||""))
    .replaceAll("{total}", String(p.total||""))
    .replaceAll("{valor}", moneyBR(p.amount||0))
    .replaceAll("{vencimento}", p.dueDate?fmtBR(p.dueDate):"");

  return `https://wa.me/55${clean}?text=${encodeURIComponent(msg)}`;
}

function payInstallment(entryId, number){
  window.__instOpen = window.__instOpen || {};
  window.__instOpen[entryId] = true;
  const actor = currentActor();
  const db = loadDB();
  const entry = (db.entries||[]).find(e=>e.id===entryId);
  if(!entry) return toast("Erro", "Entrada não encontrada");
  ensureInstallmentsForEntry(entry);
  const p = (entry.installments||[]).find(x=>x.number===number);
  if(!p) return toast("Erro", "Parcela não encontrada");
  if(p.paidAt || p.status==="PAGA") return toast("Já foi", "Essa parcela já está baixada.");
  const payDate = todayISO();
  p.paidAt = payDate;
  p.status = "PAGA";

  // soma no valuePaid
  entry.valuePaid = parseMoney(entry.valuePaid) + parseMoney(p.amount);
  entry.valueClosed = (entry.status==="Fechou") ? entry.valuePaid : null;

  // registra pagamento no caixa (opcional)
  db.payments = db.payments || [];
  db.payments.push({ id: uid("p"), masterId: actor.masterId, entryId, contactId: entry.contactId, at: new Date().toISOString(), date: payDate, value: p.amount, method: p.payMethod || entry.installPlan?.payMethod || "", desc: `Parcela ${p.number}/${p.total}` });

  saveDB(db);
  toast("Baixa feita ✅", `Parcela ${number}/${p.total} • ${moneyBR(p.amount)}`);
  // re-sync tasks + rerender
  try{ syncInstallmentTasks(db, actor); saveDB(db);}catch{}
  renderAll();
}

function undoInstallmentPay(entryId, number){
  const actor = currentActor();
  const db = loadDB();
  const entry = (db.entries||[]).find(e=>e.id===entryId);
  if(!entry) return toast("Erro", "Entrada não encontrada");
  ensureInstallmentsForEntry(entry);
  const p = (entry.installments||[]).find(x=>x.number===number);
  if(!p) return toast("Erro", "Parcela não encontrada");
  if(!(p.paidAt || p.status==="PAGA")) return toast("Nada a desfazer", "Essa parcela não está paga.");
  // remove payment record (best effort)
  const amt = parseMoney(p.amount);
  entry.valuePaid = Math.max(0, parseMoney(entry.valuePaid) - amt);
  p.paidAt = "";
  p.status = "PENDENTE";
  // remove one matching payment
  db.payments = db.payments || [];
  const idx = db.payments.findIndex(x=>x.entryId===entryId && x.value===amt && (x.desc||"").includes(`Parcela ${number}/`));
  if(idx>=0) db.payments.splice(idx,1);

  saveDB(db);
  toast("Baixa desfeita", `Parcela ${number}/${p.total} voltou para pendente.`);
  try{ syncInstallmentTasks(db, actor); saveDB(db);}catch{}
  renderAll();
}

/* Hook renderAll to also render installments safely */
const __renderAll = renderAll;
renderAll = function(){
  try{
    const actor = currentActor();
    const db = loadDB();
    // ensure installments normalized
    (db.entries||[]).forEach(e=>{ if(e.installPlan){ ensureInstallmentsForEntry(e); }});
    if(actor) { try{ syncInstallmentTasks(db, actor); }catch{} saveDB(db); }
  }catch(e){}
  __renderAll();
  try{
    if(qs('[data-view="installments"].active')) renderInstallmentsView();
  }catch(e){}
};

// Ensure view switch triggers render
const __showView = showView;
showView = function(view){
  __showView(view);
  if(view==="installments"){
    try{ renderInstallmentsView(); }catch(e){ console.error(e); toast("Erro", "Falha ao abrir Parcelamentos."); }
  }
};

// Bind filters events on DOM ready
document.addEventListener("DOMContentLoaded", ()=>{
  const mm = el("instMonth");
  const ss = el("instSearch");
  const ff = el("instFilter");
  mm?.addEventListener("change", ()=>renderInstallmentsView());
  ss?.addEventListener("input", ()=>renderInstallmentsView());
  ff?.addEventListener("change", ()=>renderInstallmentsView());
});

</script>
<script>
function getSmallLogoDataURI(){
  const img = qs("#brandIcon img");
  if(img && img.src) return img.src;
  // fallback: try header logo
  const im2 = qs(".brandMark img");
  if(im2 && im2.src) return im2.src;
  return "";
}
</script>


<!-- AUTH VIEW -->
<section id="authView" class="auth">
  <div class="authCard">
    <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
      <div class="logoBox" aria-hidden="true">
        <!-- Symbol: C + hourglass -->
        <svg viewBox="0 0 64 64" fill="none">
          <path d="M52 16c0-6.6-5.4-12-12-12H24C13 4 4 13 4 24v16c0 11 9 20 20 20h16c6.6 0 12-5.4 12-12V16Z" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <path d="M26 16h12M26 48h12" stroke="currentColor" stroke-width="5" stroke-linecap="round"/>
          <path d="M26 18c0 6 12 8 12 14s-12 8-12 14" stroke="currentColor" stroke-width="5" stroke-linecap="round"/>
        </svg>
      </div>
      <div>
        <div style="font-weight:900; font-size:16px; margin:0">Cronos CRM</div>
        <div class="muted" style="font-size:12px; margin-top:2px">Entrar ou criar clínica (Master)</div>
      </div>
      <div style="margin-left:auto">
        <button class="iconBtn" id="themeToggleAuth" title="Alternar tema"><small>🌞</small></button>
      </div>
    </div>

    <div class="twoCol">
      <div>
        <label>Modo</label>
        <select id="authMode">
          <option value="master">Master (Clínica)</option>
          <option value="user">Usuário interno</option>
        </select>
      </div>
      <div>
        <label>Master (clínica)</label>
        <select id="authMasterSelect"></select>
      </div>

      <div class="hidden" id="authMasterNameWrap">
        <label>Nome da clínica (novo Master)</label>
        <input id="authMasterName" placeholder="Ex: Mundo Odonto"/>
      </div>

      <div>
        <label>Login</label>
        <input id="authLogin" placeholder="E-mail (master) ou usuário/e-mail (interno)"/>
      </div>
      <div>
        <label>Senha</label>
        <input id="authPass" type="password" placeholder="••••••••"/>
      </div>
    </div>

    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
      <button class="btn ok" id="btnLogin" style="flex:1">Entrar</button>
      <button class="btn primary" id="btnCreateMaster">Criar Master</button>
    </div>

    <div class="muted" style="font-size:12px; margin-top:10px; line-height:1.35">
      Dica: multiusuário funciona neste navegador (fase 1). Em fase 2 vira nuvem/API.
    </div>
  </div>
</section>

<!-- APP VIEW -->
<section id="appView" class="app hidden">
  <aside class="sidebar">
    <div class="brand">
      <div class="logoBox" aria-hidden="true" title="Cronos">
        <!-- Symbol only -->
        <svg viewBox="0 0 64 64" fill="none">
          <path d="M52 16c0-6.6-5.4-12-12-12H24C13 4 4 13 4 24v16c0 11 9 20 20 20h16c6.6 0 12-5.4 12-12V16Z" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <path d="M26 16h12M26 48h12" stroke="currentColor" stroke-width="5" stroke-linecap="round"/>
          <path d="M26 18c0 6 12 8 12 14s-12 8-12 14" stroke="currentColor" stroke-width="5" stroke-linecap="round"/>
        </svg>
      </div>
      <div>
        <h1 id="brandName">Cronos CRM</h1>
        <p id="brandSub">—</p>
      </div>
      <div style="margin-left:auto">
        <button class="iconBtn" id="themeToggle" title="Alternar tema"><small>🌞</small></button>
      </div>
    </div>

    <div class="nav">
      <button data-view="dashboard" class="active">
        <span>〽︎ Dashboard</span><span class="pill" id="pillTotal">0</span>
      </button>
      <button data-view="leads">
        <span>📄 Leads</span><span class="pill" id="pillHot">0 hot</span>
      </button>

<button data-view="kanban">
  <span>📋 Funil (Kanban)</span><span class="pill" id="pillKanban">0</span>
</button>
<button data-view="tasks">
  <span>☑︎ Tarefas</span><span class="pill" id="pillTasks">0</span>
</button>

      

<button data-view="installments">
  <span>💸 Parcelamentos</span><span class="pill" id="pillInst">0</span>
</button>

<button data-view="users">
        <span>👤 Usuários</span><span class="pill" id="pillUsers">0</span>
      </button>
      <button data-view="settings">
        <span>⛭ Configurações</span><span class="pill">backup</span>
      </button>
    </div>

    <div class="sideFooter">
      <div><strong>Logado</strong></div>
      <div class="muted" id="whoami">—</div>
      <div class="row">
        <button id="btnNewLeadSide" class="btn primary">➕ Lead</button>
        <button id="btnLogout" class="btn danger">Sair</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <!-- Persistent filters -->
    <section class="stickyFilters" id="stickyFilters">
      <div class="filtersRow">
        <div>
          <label>Mês/Ano</label>
          <select id="fMonth"></select>
        </div>

        <div class="grow">
          <label>Busca</label>
          <input id="fSearch" placeholder="Nome, telefone, tag, cidade..." />
        </div>

        <div>
          <label>Status</label>
          <select id="fStatus">
            <option value="">Todos</option>
          </select>
        </div>

        <div>
          <label>Tratamento</label>
          <select id="fTreatment">
            <option value="">Todos</option>
          </select>
        </div>

        <div>
          <label>Origem</label>
          <select id="fOrigin">
            <option value="">Todos</option>
          </select>
        </div>

        <div>
          <label>Primeiro contato — De</label>
          <input id="fFirstFrom" type="date"/>
        </div>
        <div>
          <label>Até</label>
          <input id="fFirstTo" type="date"/>
        </div>

        <div>
          <label>Agendamento — De</label>
          <input id="fApptFrom" type="date"/>
        </div>
        <div>
          <label>Até</label>
          <input id="fApptTo" type="date"/>
        </div>

        <div style="min-width:220px; margin-left:auto; display:flex; gap:10px; align-items:end; justify-content:flex-end">
          <button class="btn small" id="btnClearFilters">Limpar</button>
          <button class="btn small" id="btnExportCSV">⬇️ CSV</button>
          <button class="btn small" id="btnExportPDF">🖨️ PDF</button>
        </div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="view-dashboard">
      <div class="topbar">
        <div class="titleBlock">
          <h2>📊 Dashboard</h2>
          <p>Resumo do mês selecionado + filtros (sempre visíveis).</p>
        </div>
        <div class="actions">
          <button class="btn primary" id="btnNewLeadTop">➕ Novo lead</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 10px">KPIs</h3>
        <div class="kpis">
          <div class="kpi" data-kpi="total">
            <div class="label">Total (filtro)</div>
            <div class="value" id="kpiTotal">0</div>
            <div class="hint">Leads do mês/critério</div>
          </div>
          <div class="kpi" data-kpi="pos">
            <div class="label">Positivos</div>
            <div class="value" id="kpiPositive">0</div>
            <div class="hint">Fechou</div>
          </div>
          <div class="kpi" data-kpi="bad">
            <div class="label">Desqualificados</div>
            <div class="value" id="kpiDQ">0</div>
            <div class="hint">Incorreto/sem interesse etc.</div>
          </div>
          <div class="kpi" data-kpi="sched">
            <div class="label">Agendados</div>
            <div class="value" id="kpiAppt">0</div>
            <div class="hint">Com data/hora</div>
          </div>


          <div class="kpi">
            <div class="label">Ticket médio (orçado)</div>
            <div class="value mono" id="kpiBudgetAvg">R$ 0,00</div>
            <div class="hint">Média do orçamento no filtro</div>
          </div>


          
          <div class="kpi">
            <div class="label">Valor orçado</div>
            <div class="value mono" id="kpiBudgetTotal">R$ 0,00</div>
            <div class="hint">Soma do “Orçamento total” no filtro</div>
          </div>

<div class="kpi">
            <div class="label">R$ Recebido</div>
            <div class="value mono" id="kpiClosedValue">R$ 0,00</div>
            <div class="hint">Soma do “Valor pago” no filtro</div>
          </div>

          <div class="kpi">
            <div class="label">R$ em aberto</div>
            <div class="value mono" id="kpiOpenValue">R$ 0,00</div>
            <div class="hint">Orçamento em aberto (orçado − pago)</div>
          </div>
        </div>
      </div>

      
      <div class="card" style="margin-top:12px">
        <h3>Gráficos</h3>
        <div class="grid cols2" style="margin-top:10px">
          <div>
            <div class="muted" style="font-size:12px; margin-bottom:6px">Receita (R$) por dia <span id="lineChartValue" class="chart-inline-value"></span> <span class="muted">(usa “Primeiro contato” como data do lançamento)</span></div>
            <canvas id="chartRevenueLine" style="width:100%; height:260px"></canvas>
          </div>
          <div>
            <div class="muted" style="font-size:12px; margin-bottom:6px">Leads por status (top 6)</div>
            <canvas id="chartStatusBars" style="width:100%; height:260px"></canvas>
          </div>
        </div>
      </div>

<div class="dashSplit" style="margin-top:12px">
        <div class="card" id="dashStatusCard">
          <h3>Resumo por Status</h3>
          <div class="tableWrap noX" style="margin-top:10px">
            <div class="statusGrid" id="dashByStatusGrid" role="table" aria-label="Resumo por Status">
              <div class="sgHead">Status</div>
              <div class="sgHead center">Total</div>
              <div class="sgHead right">Valor (R$)</div>
              <!-- rows injected here -->
            </div>
          </div>
        </div>

        <div class="card" id="dashLeadsCard">
          <h3>Leads filtrados</h3>
          <div class="muted" style="font-size:13px; margin-top:-6px">Clique pra abrir/editar.</div>
          <div id="dashPreview" style="margin-top:10px"></div>
        </div>
      </div>
    </section>

    <!-- LEADS -->
    <section id="view-leads" class="hidden">
      <div class="topbar">
        <div class="titleBlock">
          <h2>🧾 Leads</h2>
          <p>Cadastro principal do sistema (por mês). Sem duplicar: digite nome/telefone no modal.</p>
        </div>
        <div class="actions">
          <button class="btn primary" id="btnNewLeadList">➕ Novo lead</button>
        </div>
      </div>

      <div class="card">
                <div class="leadsCardsWrap" style="margin-top:10px">
          <div id="leadsCards" class="leadsCards"></div>
        </div>
      </div>
    </section>

    
<!-- KANBAN -->
<section id="view-kanban" class="hidden">
  <div class="topbar">
    <div class="titleBlock">
      <h2>Funil (Kanban)</h2>
      <p>Arraste os cards entre colunas para atualizar o status.</p>
    </div>
    <div class="actions">
      <button class="btn primary" id="btnNewLeadKanban">➕ Novo lead</button>
    </div>
  </div>

  <div class="card">
    <div class="muted" style="font-size:13px; margin-top:-4px">
      Dica: use os filtros (mês, busca, origem, tratamento...) no topo — o Kanban respeita o filtro atual.
    </div>
    <div id="kanbanBoard" class="kanbanWrap" style="margin-top:12px"></div>
  </div>
</section>

<!-- TASKS -->
<section id="view-tasks" class="hidden">
  <div class="topbar">
    <div class="titleBlock">
      <h2>✅ Tarefas</h2>
      <p>Controle de follow-up: atrasos, próximos passos e ações.</p>
    </div>
    <div class="actions">
      <button class="btn primary" id="btnNewTask">➕ Nova tarefa</button>
    </div>
  </div>

  <div class="card">
    <div class="tableWrap">
      <table class="tasksTable">
        <thead>
          <tr>
            <th>Status</th>
            <th>Tarefa</th>
            <th>Lead</th>
            <th class="nowrap">Vencimento</th>
            <th>Obs</th>
            <th class="nowrap">Ação</th>
          </tr>
        </thead>
        <tbody id="tasksTbody"></tbody>
      </table>
    </div>
  </div>
</section>


<!-- INSTALLMENTS -->
<section id="view-installments" class="hidden">
  <div class="topbar">
    <div class="titleBlock">
      <h2>💸 Parcelamentos</h2>
      <p>Controle de previsão do mês, atrasos e baixas por paciente.</p>
    </div>
    <div class="actions" style="display:flex; gap:10px; flex-wrap:wrap">
      <div style="min-width:170px">
        <label class="muted" style="font-size:12px; display:block; margin-bottom:6px">Mês</label>
        <input id="instMonth" type="month" class="input" />
      </div>
      <div class="grow" style="min-width:220px">
        <label class="muted" style="font-size:12px; display:block; margin-bottom:6px">Busca</label>
        <input id="instSearch" class="input" placeholder="Nome ou telefone..." />
      </div>
      <div style="min-width:180px">
        <label class="muted" style="font-size:12px; display:block; margin-bottom:6px">Filtro</label>
        <select id="instFilter" class="input">
          <option value="all">Todos</option>
          <option value="dueMonth">Vencendo no mês</option>
          <option value="late">Atrasados</option>
          <option value="open">Futuro</option>
        </select>
      </div>
      <button class="btn" id="btnInstRefresh">↻ Atualizar</button>
    </div>
  </div>

  <div class="kpiGrid">
    <div class="kpi">
      <div class="muted">Previsão do mês</div>
      <div class="kpiVal" id="kpiInstMonth">R$ 0,00</div>
      <div class="muted" id="kpiInstMonthN">0 parcelas</div>
    </div>
    <div class="kpi">
      <div class="muted">Atrasado</div>
      <div class="kpiVal" id="kpiInstLate">R$ 0,00</div>
      <div class="muted" id="kpiInstLateN">0 parcelas</div>
    </div>
    <div class="kpi">
      <div class="muted">Futuro</div>
      <div class="kpiVal" id="kpiInstFuture">R$ 0,00</div>
      <div class="muted" id="kpiInstFutureN">0 parcelas</div>
    </div>
  </div>

  <div class="card">
    <div id="instList"></div>
  </div>
</section>


<!-- USERS -->
    <section id="view-users" class="hidden">
      <div class="topbar">
        <div class="titleBlock">
          <h2>👤 Usuários</h2>
          <p>Somente Master pode criar/remover usuários e permissões.</p>
        </div>
        <div class="actions">
          <button class="btn primary" id="btnNewUser">➕ Novo usuário</button>
        </div>
      </div>

      <div class="card">
        <div class="tableWrap">
          <table style="min-width: 900px">
            <thead>
              <tr>
                <th>Usuário</th>
                <th>Login</th>
                <th>Nível</th>
                <th>Master</th>
                <th>Criado</th>
                <th class="nowrap">Ações</th>
              </tr>
            </thead>
            <tbody id="usersTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="view-settings" class="hidden">
      <div class="topbar">
        <div class="titleBlock">
          <h2>⚙️ Configurações</h2>
          <p>Preferências e backup.</p>
        </div>
        <div class="actions">
          <button class="btn" id="btnBackup">💾 Exportar JSON</button>
          <label class="btn">
            📥 Importar JSON
            <input id="fileImport" type="file" accept="application/json" style="display:none"/>
          </label>
          
        </div>
      </div>

      
      <div class="card">
        <h3>Preferências de mensagens</h3>
        <div class="muted" style="line-height:1.5; margin-bottom:10px">
          Mensagem padrão do WhatsApp (variáveis: <b>{nome}</b> e <b>{tratamento}</b>).
        </div>
        <textarea id="waTemplate" placeholder="Ex: Oi {nome}! Vi seu interesse em {tratamento}. Posso te ajudar com uma simulação?"></textarea>
        <div style="display:flex; gap:10px; margin-top:10px; align-items:center; flex-wrap:wrap">
          <button class="btn" id="btnSavePrefs">💾 Salvar preferências</button>
          <span class="muted" style="font-size:12px" id="prefsSavedHint"></span>
        </div>
      </div>

      <hr style="border:0; border-top:1px solid rgba(255,255,255,.10); margin:16px 0"/>

      <h3>Mensagem de cobrança (Parcelamentos)</h3>
      <div class="muted" style="line-height:1.5; margin-bottom:10px">
        Edita o texto do botão <b>Cobrar</b> em Parcelamentos. Variáveis: <b>{nome}</b>, <b>{parcela}</b>, <b>{total}</b>, <b>{valor}</b>, <b>{vencimento}</b>.
      </div>
      <textarea id="waChargeTemplate" placeholder="Ex: Oi {nome}! 😊 Sua parcela {parcela}/{total} de {valor} vence em {vencimento}. Quer que eu te mande o Pix?"></textarea>
      <div style="display:flex; gap:10px; margin-top:10px; align-items:center; flex-wrap:wrap">
        <button class="btn ok" id="btnSaveChargeTpl">Salvar cobrança</button>
        <button class="btn" id="btnResetChargeTpl">Restaurar padrão</button>
        <span class="muted" id="chargeTplSaved" style="font-size:12px"></span>
      </div>


    </section>


  </main>
</section>

<!-- MODAL -->
<div id="modalBg" class="modalBg" aria-hidden="true">
  <div class="modal">
    <div class="modalHead">
      <div>
        <h3 id="modalTitle">Modal</h3>
        <div id="modalSub" class="muted" style="font-size:12px;margin-top:4px"></div>
      </div>
      <button class="x" id="modalClose" title="Fechar">✕</button>
    </div>

    <div id="modalBody"></div>

    <div class="modalFoot" id="modalFoot"></div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* =========================
   Cronos CRM — Phase 1
   ========================= */

const DBKEY = "cronoscrm_phase1_db";
const SESSIONKEY = "cronoscrm_phase1_session";
const THEMEKEY = "cronoscrm_theme";
window.__KPI_ACTIVE = null; // filtro do KPI clicável

const ROLES = ["MASTER","GERENTE","SECRETARIA","DENTISTA"];

const STATUS_LIST = [
  "Agendado","Compareceu","Fechou","Remarcou","Conversando","Faltou","Sem resposta",
  "Número incorreto","Achou caro","Não tem interesse","Mora longe","Mora em outra cidade",
  "Fechou em outro lugar","Msg não entregue","Desmarcou"
, "Concluído"];

const ORIGINS = [
  "Instagram orgânico","Instagram patrocinado","Fachada da clínica","Pós-tratamento",
  "Follow-up","Paciente de retorno","Outros"
];

const TREATMENTS = [
  "Implante unitário","Prótese protocolo","HOF","Ortodontia","Endodontia","Clínica geral","Outros"
];

// Status groups for dashboard math
const POSITIVE = new Set(["Agendado","Compareceu","Fechou","Remarcou","Conversando","Concluído"]);
const DISQUALIFIED = new Set(["Número incorreto","Achou caro","Não tem interesse","Mora longe","Mora em outra cidade","Fechou em outro lugar","Msg não entregue","Mensagem não entregue"]);
// Permissions
const PERMS = {
  // MASTER (secundário): acesso alto, mas NÃO pode criar/remover outros masters
  MASTER:     {viewAll:true, edit:true, delete:true, manageUsers:true, manageMasters:false},
  GERENTE:    {viewAll:true, edit:true, delete:true, manageUsers:false, manageMasters:false},
  SECRETARIA: {viewAll:true, edit:true, delete:true, manageUsers:false, manageMasters:false},
  DENTISTA:   {viewAll:true, edit:false, delete:false, manageUsers:false, manageMasters:false},
};

const el = (id)=>document.getElementById(id);
const qs = (sel,root=document)=>root.querySelector(sel);
const qsa = (sel,root=document)=>Array.from(root.querySelectorAll(sel));

  // Safe value readers (avoid null.value crashes when elements are not present in current view)
  const qv = (sel, root=document, fallback="") => {
    const e = qs(sel, root);
    return e && typeof e.value !== "undefined" ? e.value : fallback;
  };

function val(id, fallback=""){
  const x = el(id);
  return x ? x.value : fallback;
}
function setVal(id, v){
  const x = el(id);
  if(x) x.value = v;
}


function toast(msg, sub=""){
  const t = el("toast");
  t.innerHTML = `<div>${escapeHTML(msg)}</div>${sub?`<div class="small">${escapeHTML(sub)}</div>`:""}`;
  t.classList.add("show");
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>t.classList.remove("show"), 2800);
}

function escapeHTML(s){
  return String(s??"").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;",
    "<":"&lt;",
    ">":"&gt;",
    "\"":"&quot;",
    "'":"&#039;"
  }[m]));
}

function uid(prefix="id"){ return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`; }

function todayISO(){
  const d = new Date();
  const tz = d.getTimezoneOffset()*60000;
  return new Date(d - tz).toISOString().slice(0,10);
}
function parseISO(s){ return s ? new Date(s+"T00:00:00") : null; }
function fmtBR(s){
  if(!s) return "—";
  const [y,m,d] = s.split("-");
  return `${d}/${m}/${y}`;
}
function moneyBR(v){
  const n = Number(v||0);
  return n.toLocaleString("pt-BR", {style:"currency", currency:"BRL"});
}

function normPhone(s){
  return String(s||"").replace(/\D/g,"");
}
function monthKeyFromDate(iso){
  if(!iso) return new Date().toISOString().slice(0,7);
  return iso.slice(0,7);
}
function monthLabel(key){
  const [y,m] = key.split("-");
  const nomes = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
  return `${nomes[Number(m)-1]} ${y}`;
}

/* -------- Theme -------- */
function applyTheme(theme){
  const root = document.documentElement;
  if(theme === "light"){
    root.classList.add("light");
    setThemeIcons("☾");
  }else{
    root.classList.remove("light");
    setThemeIcons("☼");
  }
  localStorage.setItem(THEMEKEY, theme);
}
function setThemeIcons(icon){
  const a = el("themeToggle"); const b = el("themeToggleAuth");
  if(a) a.innerHTML = `<small>${icon}</small>`;
  if(b) b.innerHTML = `<small>${icon}</small>`;
}
function toggleTheme(){
  const cur = localStorage.getItem(THEMEKEY) || "dark";
  applyTheme(cur === "dark" ? "light" : "dark");
}

/* -------- DB shape --------
db = {
  masters: [{id,name,email,passHash,createdAt}],
  users: [{id,masterId,name,username,email,passHash,role,createdAt}],
  contacts: [{id, masterId, name, phone, firstSeenAt, lastSeenAt}],
  entries: [{id, masterId, contactId, monthKey, firstContactAt, lastUpdateAt, status, origin, originOther,
            treatment, treatmentOther, city, notes, apptDate, apptTime, callAttempts, callResult,
            tags:[], statusLog:[{at,from,to,by}]}],
  settings: {}
}
*/
function freshDB(){
  return { masters:[], users:[], contacts:[], entries:[], tasks:[], payments:[], settings:{ waTemplate: "Oi {nome}! Vi seu interesse em {tratamento}. Posso te ajudar por aqui? 😊" }, version:"phase1", createdAt:new Date().toISOString() };
}
function loadDB(){
  const raw = localStorage.getItem(DBKEY);
  if(!raw){ const db=freshDB(); saveDB(db); return db; }
  try{ const db = JSON.parse(raw); if(!db.tasks) db.tasks=[]; if(!db.tasks) db.tasks=[]; if(!db.payments) db.payments=[]; if(!db.settings) db.settings={};
    return db; }catch{ const db=freshDB(); saveDB(db); return db; }
}
function saveDB(db){ localStorage.setItem(DBKEY, JSON.stringify(db)); 
}

function migrateDBValues(db){
  let changed = false;
  (db.entries||[]).forEach(e=>{
    if(e && e.valueBudget==null && e.valueEstimated!=null){
      e.valueBudget = e.valueEstimated;
      changed = true;
    }
    if(e && e.valuePaid==null && e.valueClosed!=null){
      e.valuePaid = e.valueClosed;
      changed = true;
    }
  });
  return changed;
}

function getPrefs(){
  const db = loadDB();
  if(!db.settings) db.settings = {};
  if(typeof db.settings.waTemplate !== "string" || !db.settings.waTemplate.trim()){
    db.settings.waTemplate = "Oi {nome}! Vi seu interesse em {tratamento}. Posso te ajudar por aqui? 😊";
    saveDB(db);
  }
  return db.settings;
}

function applyTemplate(tpl, vars){
  return String(tpl||"")
    .replaceAll("{nome}", vars.nome||"")
    .replaceAll("{tratamento}", vars.tratamento||"")
    .trim();
}

function normalizePhoneBR(phone){
  const digits = String(phone||"").replace(/\D+/g,"");
  if(!digits) return "";
  // If already has country code 55, keep; else assume BR.
  if(digits.startsWith("55")) return digits;
  return "55"+digits;
}

function openWhatsAppForEntry(entryId){
  const db = loadDB();
  const e = db.entries.find(x=>x.id===entryId);
  const c = db.contacts.find(x=>x.id===e?.contactId);
  const phone = normalizePhoneBR(c?.phone||"");
  if(!phone){
    toast("Sem telefone válido para WhatsApp.");
    return;
  }
  const treatment = (e?.treatment==="Outros") ? (e?.treatmentOther||"Outros") : (e?.treatment||"");
  const tpl = getPrefs().waTemplate;
  const msg = applyTemplate(tpl, { nome: c?.name||"", tratamento: treatment });
  const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
  window.open(url, "_blank");
}

function loadSession(){
  const raw = localStorage.getItem(SESSIONKEY);
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch{ return null; }
}
function saveSession(s){ localStorage.setItem(SESSIONKEY, JSON.stringify(s)); }
function clearSession(){ localStorage.removeItem(SESSIONKEY); }

async function hashPass(p){
  // robust for file:// + localhost
  try{
    if (window.crypto?.subtle){
      const enc = new TextEncoder().encode(p);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }
  }catch(e){}
  // fallback FNV-1a
  let h = 2166136261;
  for (let i=0;i<p.length;i++){ h ^= p.charCodeAt(i); h = Math.imul(h, 16777619); }
  return "fnv1a_" + (h>>>0).toString(16);
}

/* -------- Auth -------- */
function currentActor(){
  const s = loadSession();
  if(!s) return null;
  const db = loadDB();
  if(s.kind==="master"){
    const m = db.masters.find(x=>x.id===s.id);
    if(!m) return null;
    return {kind:"master", id:m.id, masterId:m.id, name:m.name, email:m.email, role:"MASTER", isPrimaryMaster:true, perms: {...PERMS.MASTER, manageMasters:true} };
  }
  if(s.kind==="user"){
    const u = db.users.find(x=>x.id===s.id);
    if(!u) return null;
    return {kind:"user", id:u.id, masterId:u.masterId, name:u.name, email:u.email, username:u.username, role:u.role, isPrimaryMaster:false, perms: (PERMS[u.role] || PERMS.DENTISTA)};
  }
  return null;
}

function refreshAuthMasters(){
  const db = loadDB();
  const sel = el("authMasterSelect");
  if(!sel) return;
  sel.innerHTML = db.masters.length
    ? db.masters.map(m=>`<option value="${m.id}">${escapeHTML(m.name)} (${escapeHTML(m.email)})</option>`).join("")
    : `<option value="">(Nenhum master cadastrado)</option>`;
  sel.disabled = (el("authMode").value === "master");
}

function showAuth(){
  el("authView").classList.remove("hidden");
  el("appView").classList.add("hidden");
  refreshAuthMasters();
  syncThemeButtons();
  window.__CRONOS_BOOTED = true;
}

function showApp(actor){
  el("authView").classList.add("hidden");
  el("appView").classList.remove("hidden");
  el("brandName").textContent = "Cronos CRM";
  el("brandSub").textContent = `Clínica: ${actor.kind==="master" ? actor.name : masterName(actor.masterId)}`;
  el("whoami").textContent = `${actor.name} • ${actor.role}`;
  syncThemeButtons();
  window.__CRONOS_BOOTED = true;
}

function syncThemeButtons(){
  const cur = localStorage.getItem(THEMEKEY) || "dark";
  applyTheme(cur);
}

function masterName(masterId){
  const db = loadDB();
  const m = db.masters.find(x=>x.id===masterId);
  return m ? m.name : "—";
}

/* -------- Filters (persist across views) -------- */
const FILTERKEY = "cronoscrm_phase1_filters";
function loadFilters(){
  const raw = localStorage.getItem(FILTERKEY);
  const def = {
    monthKey: new Date().toISOString().slice(0,7),
    search:"",
    status:"",
    treatment:"",
    origin:"",
    firstFrom:"",
    firstTo:"",
    apptFrom:"",
    apptTo:""
  };
  if(!raw) return def;
  try{ return {...def, ...JSON.parse(raw)}; }catch{ return def; }
}
function saveFilters(f){ localStorage.setItem(FILTERKEY, JSON.stringify(f)); }

function getUIFilters(){
  return {
    monthKey: val("fMonth", new Date().toISOString().slice(0,7)),
    search: val("fSearch","").trim(),
    status: val("fStatus",""),
    treatment: val("fTreatment",""),
    origin: val("fOrigin",""),
    firstFrom: val("fFirstFrom",""),
    firstTo: val("fFirstTo",""),
    apptFrom: val("fApptFrom",""),
    apptTo: val("fApptTo","")
  };
}
function setUIFilters(f){
  setVal("fMonth", f.monthKey || new Date().toISOString().slice(0,7));
  setVal("fSearch", f.search || "");
  setVal("fStatus", f.status || "");
  setVal("fTreatment", f.treatment || "");
  setVal("fOrigin", f.origin || "");
  setVal("fFirstFrom", f.firstFrom || "");
  setVal("fFirstTo", f.firstTo || "");
  setVal("fApptFrom", f.apptFrom || "");
  setVal("fApptTo", f.apptTo || "");
}

function ensureMonthOptions(){
  const db = loadDB();
  const actor = currentActor();

  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonthKey = `${currentYear}-${String(now.getMonth()+1).padStart(2,"0")}`;

  // keep current year months only (avoid infinite list), but always keep:
  // - current month
  // - currently selected month (if user is viewing history)
  const selected = (getUIFilters()?.monthKey) || currentMonthKey;

  const mkSet = new Set([currentMonthKey, selected]);

  if(actor){
    db.entries
      .filter(e=>e.masterId===actor.masterId)
      .forEach(e=>{
        const mk = (e.monthKey||"").slice(0,7);
        if(!mk) return;
        const y = Number(mk.slice(0,4));
        if(y===currentYear) mkSet.add(mk);
      });
  }

  const months = Array.from(mkSet).sort(); // ascending
  // Build labels as "Mês/Ano" but keep only the set above
  el("fMonth").innerHTML = months.map(mk=>`<option value="${mk}">${monthLabel(mk)}</option>`).join("");

  // keep selection
  if(el("fMonth").value !== selected) el("fMonth").value = selected;
}

function fillSelectOptions(){
  el("fStatus").innerHTML = `<option value="">Todos</option>` + STATUS_LIST.map(s=>`<option value="${s}">${s}</option>`).join("");
  el("fOrigin").innerHTML = `<option value="">Todos</option>` + ORIGINS.map(o=>`<option value="${o}">${o}</option>`).join("");
  el("fTreatment").innerHTML = `<option value="">Todos</option>` + TREATMENTS.map(t=>`<option value="${t}">${t}</option>`).join("");
}

/* -------- Data access -------- */
function filteredEntries(){
  const db = loadDB();
  const actor = currentActor();
  if(!actor) return [];
  const f = getUIFilters();
  const search = (f.search||"").toLowerCase();

  const firstFrom = parseISO(f.firstFrom);
  const firstTo = parseISO(f.firstTo);
  const apptFrom = parseISO(f.apptFrom);
  const apptTo = parseISO(f.apptTo);

  function inRange(d, a, b){
    if(!d) return false;
    const dt = parseISO(d);
    if(a && dt < a) return false;
    if(b && dt > b) return false;
    return true;
  }

  const rows = db.entries
    .filter(e=>e.masterId===actor.masterId)
    .filter(e=>e.monthKey === f.monthKey)
    .filter(e=> !f.status || e.status===f.status)
    .filter(e=> !f.treatment || e.treatment===f.treatment)
    .filter(e=> !f.origin || e.origin===f.origin)
    .filter(e=> !f.firstFrom && !f.firstTo ? true : inRange(e.firstContactAt, firstFrom, firstTo))
    .filter(e=> !f.apptFrom && !f.apptTo ? true : (e.apptDate ? inRange(e.apptDate, apptFrom, apptTo) : false))
    .filter(e=>{
      if(!search) return true;
      const c = db.contacts.find(x=>x.id===e.contactId);
      const hay = [
        c?.name, c?.phone, e.city, e.notes, e.originOther, e.treatmentOther,
        e.status, e.origin, e.treatment, ...(e.tags||[])
      ].filter(Boolean).join(" ").toLowerCase();
      return hay.includes(search);
    });


  // KPI clicável: quando ativo, aplica o bucket na lista/kanban
  try{
    const k = window.__KPI_ACTIVE;
    if(k && k!=="total") return __kpiBucket(k, rows);
  }catch(_){ }
  return rows;
}


function getContact(contactId){
  const db = loadDB();
  return db.contacts.find(c=>c.id===contactId) || null;
}

/* -------- UI Render -------- */
function updateSidebarPills(){
  const db = loadDB();
  const actor = currentActor();
  if(!actor) return;
  const allMonth = filteredEntries();
  const total = allMonth.length;
  const hotCount = allMonth.filter(e=>e.tags?.includes("Prioridade: Quente")).length;
  const usersCount = db.users.filter(u=>u.masterId===actor.masterId).length + 1; // master
  el("pillTotal").textContent = String(total);
  el("pillHot").textContent = `${hotCount} hot`;
  el("pillUsers").textContent = String(usersCount);

const tasksOpen = (db.tasks||[]).filter(t=>t.masterId===actor.masterId && t.done!==true).length;
const overdue = (db.tasks||[]).filter(t=>t.masterId===actor.masterId && t.done!==true && t.dueDate && (new Date(t.dueDate+"T00:00:00") < new Date(new Date().toISOString().slice(0,10)+"T00:00:00"))).length;
const pillK = el("pillKanban"); if(pillK) pillK.textContent = String(total);
const pillT = el("pillTasks"); if(pillT) pillT.textContent = overdue ? `${overdue} ⚠️` : String(tasksOpen);

}

function renderDashboard(){
  const rows = filteredEntries();
  const byStatus = new Map();
  const byStatusValue = new Map(); // soma R$ em aberto (orçado - pago) por status
  let totalPaid = 0;
  let totalBudget = 0;
  let totalOpen = 0;
  let positive = 0, dq = 0, appt = 0;

  rows.forEach(e=>{
    byStatus.set(e.status, (byStatus.get(e.status)||0) + 1);

    const budget = (e.valueBudget!=null && !isNaN(Number(e.valueBudget))) ? Number(e.valueBudget) : ((e.valueEstimated!=null && !isNaN(Number(e.valueEstimated))) ? Number(e.valueEstimated) : 0);
    totalBudget += (budget||0);
    const paid = (e.valuePaid!=null && !isNaN(Number(e.valuePaid))) ? Number(e.valuePaid) : ((e.valueClosed!=null && !isNaN(Number(e.valueClosed))) ? Number(e.valueClosed) : 0);

    totalPaid += paid||0;
    const open = Math.max(0, (budget||0) - (paid||0));
    byStatusValue.set(e.status, (byStatusValue.get(e.status)||0) + (open||0));
    if(open) totalOpen += open;

    if(POSITIVE.has(e.status)) positive++;
    if(DISQUALIFIED.has(e.status)) dq++;
    if(e && (e.status==='Agendado' || e.status==='Remarcou')) appt++;
  });

el("kpiTotal").textContent = rows.length;
  el("kpiPositive").textContent = positive;
  el("kpiDQ").textContent = dq;
  el("kpiAppt").textContent = appt;
  // Ticket médio (orçado): média do orçamento no filtro (considera apenas leads com orçamento > 0)
  try{
    const budgetCount = rows.reduce((acc,e)=>{
      const b = (e.valueBudget!=null && !isNaN(Number(e.valueBudget))) ? Number(e.valueBudget) : ((e.valueEstimated!=null && !isNaN(Number(e.valueEstimated))) ? Number(e.valueEstimated) : 0);
      return acc + ((b && b>0) ? 1 : 0);
    }, 0);
    const avg = budgetCount ? (totalBudget / budgetCount) : 0;
    const kpiAvg = el("kpiBudgetAvg");
    if(kpiAvg) kpiAvg.textContent = moneyBR(avg);
  }catch(_){}

  const kpiBudget = el("kpiBudgetTotal");
  if(kpiBudget) kpiBudget.textContent = moneyBR(totalBudget);
  const kpiClosed = el("kpiClosedValue");
  if(kpiClosed) kpiClosed.textContent = moneyBR(totalPaid);
  const kpiOpen = el("kpiOpenValue");
  if(kpiOpen) kpiOpen.textContent = moneyBR(totalOpen);

  const grid = el("dashByStatusGrid");
  const ordered = STATUS_LIST.map(s=>[s, byStatus.get(s)||0]).filter(([_,n])=>n>0);

  // Robust render (grid)
  grid.innerHTML = `
    <div class="sgHead">Status</div>
    <div class="sgHead center">Total</div>
    <div class="sgHead right">Valor (R$)</div>
  `;
  if(!ordered.length){
    const a=document.createElement("div"); a.className="muted"; a.style.gridColumn="1 / -1"; a.style.padding="12px";
    a.textContent="Sem leads no filtro atual.";
    grid.appendChild(a);
  } else {
    ordered.forEach(([s,n])=>{
      const row = document.createElement("div"); row.className="sgRow";
      const c1=document.createElement("div"); c1.textContent=String(s);
      const c2=document.createElement("div"); c2.className="center nowrap"; c2.innerHTML="<b>"+String(n)+"</b>";
      const c3=document.createElement("div"); c3.className="right nowrap"; c3.innerHTML="<b>"+moneyBR(byStatusValue.get(s)||0)+"</b>";
      row.appendChild(c1); row.appendChild(c2); row.appendChild(c3);
      grid.appendChild(row);
    });
  }
  try{ grid.dataset.rendered="1"; }catch(_){}




  // preview (max 8)
  const db = loadDB();
  const prev = rows.slice().sort((a,b)=> (b.lastUpdateAt||"").localeCompare(a.lastUpdateAt||"")).slice(0,8);
  const box = el("dashPreview");
  if(!prev.length){
    box.innerHTML = `<div class="muted">Nada aqui ainda. Crie seu primeiro lead.</div>`;
      return;
  }
  box.innerHTML = prev.map(e=>{
    const c = db.contacts.find(x=>x.id===e.contactId);
    const tagRes = e.tags?.includes("Resgatado") ? `<span class="tagPill">♻️ Resgatado</span>` : "";
    return `
      <div class="card" style="padding:10px; margin-bottom:10px">
        <div style="display:flex; justify-content:space-between; gap:10px">
          <div>
            <div style="font-weight:800">${escapeHTML(c?.name||"—")}</div>
            <div class="muted" style="font-size:12px; margin-top:2px">${escapeHTML(c?.phone||"—")} • ${escapeHTML(e.status||"—")}</div>
          </div>
          <div style="display:flex; gap:8px; align-items:start">
            ${tagRes}
            <button class="miniBtn" onclick="openLeadEntry('${e.id}')">Abrir</button>
          </div>
        </div>
      </div>
    `;
  }).join("");

  // charts
  requestAnimationFrame(()=>renderDashboardCharts(rows));
}

function statusDotClass(status){
  const s = (status||"").trim();
  // cores inspiradas no layout de referência
  const map = {
    "Conversando":"st-yellow",
    "Agendado":"st-blue",
    "Compareceu":"st-green",
    "Fechou":"st-purple",
    "Remarcou":"st-orange",
    "Faltou":"st-red",
    "Desmarcou":"st-red",
    "Sem resposta":"st-gray",
    "Msg não entregue":"st-gray",
    "Número incorreto":"st-gray",
    "Achou caro":"st-red",
    "Não tem interesse":"st-red",
    "Fechou em outro lugar":"st-red",
    "Concluído":"st-green"
  };
  return map[s] || "st-gray";
}
function chipStatus(e){
  const st = e.status||"—";
  const cls = statusDotClass(st);
  return `<span class="chip"><span class="dot ${cls}"></span>${escapeHTML(st)}</span>`;
}
function chipOrigin(e){
  const v = e.origin==="Outros" ? (e.originOther||"Outros") : e.origin;
  return `<span class="chip">${escapeHTML(v||"—")}</span>`;
}
function chipTreatment(e){
  const v = e.treatment==="Outros" ? (e.treatmentOther||"Outros") : e.treatment;
  return `<span class="chip">${escapeHTML(v||"—")}</span>`;
}



/* -------- Dashboard charts (Canvas, sem biblioteca) -------- */
function renderDashboardCharts(rows){
  const line = el("chartRevenueLine");
  const bar = el("chartStatusBars");
  if(!line || !bar) return;

  const actor = currentActor();
  const db = loadDB();

  const f = getUIFilters();
  const monthKey = f.monthKey || new Date().toISOString().slice(0,7);
  const daysInMonth = new Date(Number(monthKey.slice(0,4)), Number(monthKey.slice(5,7)), 0).getDate();
  const labels = Array.from({length: daysInMonth}, (_,i)=>String(i+1).padStart(2,"0"));

  // === Pagos por dia (preferência: db.payments) ===
  const rev = Array.from({length: daysInMonth}, ()=>0);

  // helper: pick date for fallback legacy (entries without payments log)
  const pickISO = (e)=>{
    const raw = e.firstContactAt || e.firstContact || e.createdAt || e.createdISO || e.lastUpdateAt || e.updatedAt || e.firstContact || e.appointmentAt || e.agendamentoAt || e.date || "";
    if(raw instanceof Date) return raw.toISOString().slice(0,10);
    if(typeof raw === "number") return new Date(raw).toISOString().slice(0,10);
    if(typeof raw === "string"){
      const s = raw.trim();
      if(/^[0-9]{4}-[0-9]{2}-[0-9]{2}/.test(s)) return s.slice(0,10);
      const mm = s.match(/^([0-3]?\d)\/([0-1]?\d)\/([12]\d{3})(?:\s+.*)?$/);
      if(mm){
        const dd = String(mm[1]).padStart(2,'0');
        const mo = String(mm[2]).padStart(2,'0');
        const yyyy = mm[3];
        return `${yyyy}-${mo}-${dd}`;
      }
      const d = new Date(s);
      if(!isNaN(d)) return d.toISOString().slice(0,10);
    }
    return "";
  };

  let usedPayments = false;
  const payments = (db.payments||[])
    .filter(p=>!actor || !p.masterId || p.masterId===actor.masterId)
    .filter(p=>p.date && String(p.date).slice(0,7)===monthKey);

  if(payments.length){
    usedPayments = true;
    payments.forEach(p=>{
      const d = String(p.date||"").slice(0,10);
      const day = Number(d.slice(8,10));
      if(day>=1 && day<=daysInMonth) rev[day-1] += Number(p.value||0);
    });
  }else{
    // fallback: usa valuePaid do lead no dia do último update (bem legado)
    rows.forEach(e=>{
      const paid = (e.valuePaid!=null && !isNaN(Number(e.valuePaid))) ? Number(e.valuePaid) : ((e.valueClosed!=null && !isNaN(Number(e.valueClosed))) ? Number(e.valueClosed) : 0);
      if(!paid) return;
      const d = pickISO(e);
      if(!d || d.slice(0,7)!==monthKey) return;
      const day = Number(d.slice(8,10));
      if(day>=1 && day<=daysInMonth) rev[day-1] += paid;
    });
  }

  // acumulado do mês (linha azul)
  const revCum = [];
  let acc = 0;
  for(let i=0;i<rev.length;i++){ acc += (rev[i]||0); revCum.push(acc); }

  // em aberto (linha vermelha) por dia: orçamento total - pagos acumulados até o dia
  let totalBudget = 0;
  rows.forEach(e=>{
    const b = (e.valueBudget!=null && !isNaN(Number(e.valueBudget))) ? Number(e.valueBudget) : ((e.valueEstimated!=null && !isNaN(Number(e.valueEstimated))) ? Number(e.valueEstimated) : 0);
    totalBudget += (b||0);
  });
  const openLine = revCum.map(v=>Math.max(0, totalBudget - v));

  // barras: contagem por status (top 6)
  const by = new Map();
  rows.forEach(e=> by.set(e.status||"—", (by.get(e.status||"—")||0)+1));
  const statusPairs = Array.from(by.entries()).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const barLabels = statusPairs.map(([s])=>s);
  const barValues = statusPairs.map(([_,n])=>n);

  const __doDrawDashCharts = () => {
    const __norm = (arr) => {
      const nums = (arr||[]).map(v => (typeof v === "number" && isFinite(v)) ? v : 0);
      if (!nums.length) return [];
      let mn = Math.min(...nums), mx = Math.max(...nums);
      if (mx === mn) return nums.map(_ => 50); // linha plana -> "pulso" neutro
      return nums.map(v => ((v - mn) / (mx - mn)) * 100);
    };
    const revN = __norm(rev);
    const openN = __norm(openLine);

    // Gráfico em escala relativa (0–100) para enxergar variações (batimentos), mesmo quando os valores absolutos são próximos.
    const __lineMax = drawMultiLineChart(line, labels, [
      {name:"Pago/dia (variação)", values: revN, color:"rgba(46,229,157,0.9)", fill:true},
      {name:"Em aberto (variação)", values: openN, color:"rgba(255,90,90,0.9)", dash:[6,6]}
    ], { yPrefix: "", showPoints: false, showMaxLabel: false });
    const __vEl = document.getElementById("lineChartValue");
    if(__vEl){ __vEl.textContent = moneyBR(__lineMax); }

    drawBarChart(bar, barLabels, barValues);
  };
  requestAnimationFrame(() => {
    __doDrawDashCharts();
    setTimeout(__doDrawDashCharts, 120);
  });
}

function clearCanvas(canvas){
  const ctx = canvas.getContext("2d");
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  let w = rect.width;
  let h = rect.height;

  // fallback quando o canvas está dentro de seção recém-exibida (ou ainda sem layout)
  if(w < 50) w = (canvas.parentElement?.getBoundingClientRect().width) || 600;
  if(h < 50) h = 180;

  canvas.width = Math.max(1, Math.floor(w * dpr));
  canvas.height = Math.max(1, Math.floor(h * dpr));
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,w,h);
  return {ctx, w, h};
}

function drawLineChart(canvas, labels, values, opt={}){
  const {ctx,w,h} = clearCanvas(canvas);
  const pad = 28;
  const top = 64;// reserva p/ legenda (mais espaço p/ não sobrepor)
  const maxV = Math.max(1, ...values);
  const minV = 0;

  // axes
  ctx.globalAlpha = 0.9;
  ctx.lineWidth = 1;
  ctx.strokeStyle = "rgba(120,120,120,0.35)";
  ctx.beginPath();
  ctx.moveTo(pad, top);
  ctx.lineTo(pad, h-pad);
  ctx.lineTo(w-10, h-pad);
  ctx.stroke();

  // line
  ctx.strokeStyle = "rgba(30,120,255,0.9)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  values.forEach((v,i)=>{
    const x = pad + (i*(w-pad-10))/Math.max(1, values.length-1);
    const y = (h-pad) - ((v-minV)*(h-pad-top))/Math.max(1, (maxV-minV));
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // labels (poucos pra não poluir)
  ctx.fillStyle = "rgba(160,160,160,0.95)";
  ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const step = Math.ceil(labels.length/8);
  for(let i=0;i<labels.length;i+=step){
    const x = pad + (i*(w-pad-10))/Math.max(1, labels.length-1);
    ctx.fillText(labels[i], x-8, h-10);
  }
  // max value
  ctx.fillText((opt.yPrefix||"")+moneyBR(maxV).replace(/R\$\s*/,""), 10, 18);
}

function drawMultiLineChart(canvas, labels, series, opt={}){
  if(!canvas) return;

  const w0 = canvas.clientWidth || canvas.width || 0;
  const h0 = canvas.clientHeight || canvas.height || 0;
  if(w0===0 || h0===0) return;

  // series: [{name, values, color, dash?, fill?}]
  const {ctx,w,h} = clearCanvas(canvas);

  // Premium spacing
  const padL = 34;
  const padR = 18;
  const padB = 30;
  const topBase = 64; // legenda + respiro

  // y scale (dinâmica p/ evitar "linha reta")
  const all = (series||[]).flatMap(s=>s.values||[]).filter(v=>typeof v==="number" && !isNaN(v));
  let minV = Math.min(...(all.length?all:[0]));
  let maxV = Math.max(...(all.length?all:[1]));
  if(!isFinite(minV)) minV = 0;
  if(!isFinite(maxV)) maxV = 1;
  if(maxV === minV) maxV = minV + 1;

  const range = Math.max(1, maxV - minV);
  const padRange = range * 0.12; // 12% de folga
  minV = Math.max(0, minV - padRange);
  maxV = maxV + padRange;

  const plotLeft = padL;
  const plotRight = w - padR;
  const plotTop = topBase;
  const plotBottom = h - padB;

  const X = (i,n) => plotLeft + (i*(plotRight-plotLeft))/Math.max(1, n-1);
  const Y = (v)   => plotBottom - ((v-minV)*(plotBottom-plotTop))/Math.max(1e-9, (maxV-minV));

  // grid (horizontal)
  ctx.save();
  ctx.globalAlpha = 1;
  ctx.lineWidth = 1;
  ctx.strokeStyle = "rgba(180,190,205,0.10)";
  const gridLines = 4;
  for(let g=0; g<=gridLines; g++){
    const yy = plotTop + (g*(plotBottom-plotTop))/gridLines;
    ctx.beginPath();
    ctx.moveTo(plotLeft, yy);
    ctx.lineTo(plotRight, yy);
    ctx.stroke();
  }
  // axis
  ctx.strokeStyle = "rgba(180,190,205,0.16)";
  ctx.beginPath();
  ctx.moveTo(plotLeft, plotTop);
  ctx.lineTo(plotLeft, plotBottom);
  ctx.lineTo(plotRight, plotBottom);
  ctx.stroke();
  ctx.restore();

  // helpers: smooth curve (Catmull-Rom -> Bezier)
  function drawSmoothPath(values){
    const n = values.length;
    if(n===0) return;
    const pts = values.map((v,i)=>({x:X(i,n), y:Y(v)}));
    if(n<3){
      ctx.beginPath();
      pts.forEach((p,i)=> i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));
      return pts;
    }
    ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y);
    for(let i=0;i<n-1;i++){
      const p0 = pts[i-1] || pts[i];
      const p1 = pts[i];
      const p2 = pts[i+1];
      const p3 = pts[i+2] || p2;

      const cp1x = p1.x + (p2.x - p0.x) / 6;
      const cp1y = p1.y + (p2.y - p0.y) / 6;
      const cp2x = p2.x - (p3.x - p1.x) / 6;
      const cp2y = p2.y - (p3.y - p1.y) / 6;

      ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, p2.x, p2.y);
    }
    return pts;
  }

  // draw series
  (series||[]).forEach((s, si)=>{
    const values = (s.values||[]).map(v=>Number(v)||0);
    if(values.length===0) return;

    // stroke
    ctx.save();
    ctx.lineWidth = 3;
    ctx.lineJoin = "round";
    ctx.lineCap = "round";
    ctx.strokeStyle = s.color || "rgba(30,120,255,0.9)";
    if(Array.isArray(s.dash)) ctx.setLineDash(s.dash); else ctx.setLineDash([]);

    const pts = drawSmoothPath(values);

    // soft shadow
    ctx.shadowColor = "rgba(0,0,0,0.25)";
    ctx.shadowBlur = 10;
    ctx.shadowOffsetY = 2;
    ctx.stroke();

    // fill (only if requested)
    if(s.fill){
      ctx.setLineDash([]);
      ctx.shadowBlur = 0;
      ctx.globalAlpha = 0.18;
      const grad = ctx.createLinearGradient(0, plotTop, 0, plotBottom);
      grad.addColorStop(0, (s.color||"rgba(46,229,157,0.9)").replace("0.9","0.22"));
      grad.addColorStop(1, "rgba(0,0,0,0)");
      ctx.fillStyle = grad;
      ctx.lineTo(pts[pts.length-1].x, plotBottom);
      ctx.lineTo(pts[0].x, plotBottom);
      ctx.closePath();
      ctx.fill();
    }

    // points
    ctx.globalAlpha = 1;
    ctx.fillStyle = "rgba(255,255,255,0.95)";
    ctx.strokeStyle = s.color || "rgba(46,229,157,0.9)";
    ctx.lineWidth = 2;
    if(opt.showPoints){
    pts.forEach((p,i)=>{
      const isLast = (i===pts.length-1);
      const r = isLast ? 6 : 4;
      ctx.beginPath();
      ctx.arc(p.x, p.y, r, 0, Math.PI*2);
      ctx.fill();
      ctx.stroke();
    });
  }
ctx.restore();
  });

  // x labels (few)
  ctx.save();
  ctx.fillStyle = "rgba(170,180,195,0.9)";
  ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const step = Math.ceil(labels.length/7);
  for(let i=0;i<labels.length;i+=step){
    const x = X(i, labels.length);
    ctx.fillText(labels[i], x-10, h-10);
  }

  // y max label (optional)
  if(opt.showMaxLabel !== false){
    ctx.fillStyle = "rgba(170,180,195,0.9)";
    ctx.fillText((opt.yPrefix||"")+moneyBR(maxV).replace(/R\$\s*/,""), 10, 18);
  }
  ctx.restore();
// legend (more padding, wrap)
  ctx.save();
  let x = plotLeft, y = 22;
  const maxX = plotRight;
  series.forEach(s=>{
    const name = s.name||"";
    ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
    const need = 18 + ctx.measureText(name).width + 18;
    if(x + need > maxX){ x = plotLeft; y += 18; }
    ctx.fillStyle = s.color || "rgba(30,120,255,0.9)";
    ctx.fillRect(x, y, 12, 3);
    if(Array.isArray(s.dash)){
      // dashed hint
      ctx.save();
      ctx.strokeStyle = s.color || "rgba(30,120,255,0.9)";
      ctx.setLineDash(s.dash);
      ctx.beginPath();
      ctx.moveTo(x, y+6);
      ctx.lineTo(x+12, y+6);
      ctx.stroke();
      ctx.restore();
    }
    ctx.fillStyle = "rgba(210,220,235,0.95)";
    ctx.fillText(name, x+16, y+7);
    x += need;
  });
  ctx.restore();

  // bind tooltip data
  try{
    canvas.__chartData = {
      type:"multiLine",
      labels: labels,
      series: (series||[]).map(s=>({
        name:s.name,
        values:(s.values||[]),
        color:(s.color||"rgba(30,120,255,0.9)"),
        dash:(Array.isArray(s.dash)?s.dash:null)
      })),
      pad: plotLeft, top: plotTop, w: w, h: h,
      yPrefix: (opt.yPrefix||"R$ "),
      plotLeft, plotRight, plotTop, plotBottom,
      minV, maxV
    };
    __bindChartHoverOnce(canvas);
    return maxV;
  }catch(_){}
  return 0;
}

function drawBarChart(canvas, labels, values){
  if(!canvas) return;
  // evita erro quando canvas está oculto/sem tamanho
  const w0 = canvas.clientWidth || canvas.width || 0;
  const h0 = canvas.clientHeight || canvas.height || 0;
  if(w0===0 || h0===0) return;

  const {ctx,w,h} = clearCanvas(canvas);
  const pad = 28;
  const top = 56;// mais área útil p/ barras
  const maxV = Math.max(1, ...values);
  const n = values.length || 1;
  const barW = (w - pad - 10) / n;
  const rects = [];

  // axes
  ctx.strokeStyle = "rgba(120,120,120,0.35)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(pad, top);
  ctx.lineTo(pad, h-pad);
  ctx.lineTo(w-10, h-pad);
  ctx.stroke();

  // bars
  for(let i=0;i<n;i++){
    const v = values[i]||0;
    const bh = ((v)* (h-pad-top)) / maxV;
    const x = pad + i*barW + 6;
    const y = (h-pad) - bh;
    ctx.fillStyle = "rgba(30,120,255,0.7)";
    ctx.fillRect(x, y, Math.max(6, barW-12), bh);
    rects.push({x:x, y:y, w:Math.max(6, barW-12), h:bh, label:labels[i]||"", value:values[i]||0});
    ctx.fillStyle = "rgba(160,160,160,0.95)";
    ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
    const lab = (labels[i]||"").slice(0,12);
    ctx.fillText(lab, x, h-10);
  }

  // bind tooltip data
  try{
    canvas.__chartData = { type:"bar", rects: rects };
    __bindChartHoverOnce(canvas);
  }catch(_){}

}


function renderLeadsTable(list){
  // Novo layout (cards) na aba Leads
  const cardsWrap = document.getElementById('leadsCards');
  const tbody = document.getElementById('leadsTbody'); // fallback antigo (se existir)
  const db = loadDB();
  const _contactsById = new Map((db.contacts||[]).map(c=>[String(c.id), c]));
  const _getContact = (cid)=> _contactsById.get(String(cid||''));

  const target = cardsWrap || tbody;
  if(!target) return;

  const cardsHtml = (list||[]).map((e)=>{
    const c = e?.contactId ? _getContact(e.contactId) : null;

    const name = escapeHTML(c?.name || e.name || e.lead || e.nome || '—');

    const phoneRaw = String(c?.phone || e.phone || e.contato || e.telefone || '').trim();
    const phoneDigits = phoneRaw.replace(/\D/g,'');
    const phonePretty = phoneDigits ? phoneDigits : '—';

    // Prioridade (normalizada)
    const prioridadeRaw = (e.priority || e.prioridade || e.temperature || e.temperatura || e.temp || e.pri || '').toString().trim();
    let prioridade = prioridadeRaw;
    const priNorm = String(prioridadeRaw).trim().toLowerCase();
    if (priNorm === '2' || priNorm === 'hot' || priNorm === 'quente' || priNorm === 'q') prioridade = 'Quente';
    else if (priNorm === '1' || priNorm === 'warm' || priNorm === 'morno' || priNorm === 'm') prioridade = 'Morno';
    else if (priNorm === '0' || priNorm === 'cold' || priNorm === 'frio' || priNorm === 'f') prioridade = 'Frio';

    // fallback: prioridade via tag "Prioridade: X"
    const tagsArr = ([] 
      .concat(Array.isArray(e.tags) ? e.tags : (Array.isArray(e.tag) ? e.tag : (e.tag ? [e.tag] : [])))
      .concat(Array.isArray(c?.tags) ? c.tags : (Array.isArray(c?.tag) ? c.tag : (c?.tag ? [c.tag] : [])))
      .map(String));
    if (!prioridade && tagsArr.length) {
      const tagPref = tagsArr.find(t => /^\s*prioridade\s*:/i.test(String(t || '')));
      if (tagPref) prioridade = String(tagPref).split(':').slice(1).join(':').trim();
    }

    const priClass = (() => {
      const p = (prioridade||'').toLowerCase();
      if (p.includes('quente')) return 'hot';
      if (p.includes('morno')) return 'warm';
      if (p.includes('frio')) return 'cold';
      return 'neutral';
    })();

    const priBadge = prioridade ? `<span class="badge ${priClass}">${escapeHTML(prioridade)}</span>` : '';

    const tratamento = escapeHTML((e.treatment || e.tratamento || e.procedimento || e.trat || c?.treatment || c?.tratamento || '')||'') || '—';
    const origem = escapeHTML((e.source || e.origem || e.origin || c?.source || c?.origem || c?.origin || '')||'') || '—';

    const apptDate = (e.apptDate || e.agendamentoData || e.appointmentDate || c?.apptDate || c?.agendamentoData || c?.appointmentDate || '').toString().trim();
    const apptTime = (e.apptTime || e.agendamentoHora || e.appointmentTime || c?.apptTime || c?.agendamentoHora || c?.appointmentTime || '').toString().trim();
    const apptText = (apptDate || apptTime) ? `${escapeHTML(apptDate)}${apptTime ? ' ' + escapeHTML(apptTime) : ''}` : '—';

    const budgetVal = Number((e.valueBudget ?? e.budget ?? e.orcamento ?? e.valorOrcamento ?? 0)) || 0;
    const paidVal   = Number((e.paid ?? e.valorPago ?? e.pago ?? e.valor_pago ?? 0)) || 0;
    const openVal   = Number((e.open ?? e.emAberto ?? e.aberto ?? (budgetVal - paidVal))) || 0;

    const statusPill = chipStatus(e);

    const id = e.id ?? e._id ?? '';
    const idAttr = escapeHTML(String(id));

    // Ações
    const btnEdit  = `<button class="iconBtn" title="Abrir" onclick="openLeadEntry('${idAttr}')">✏️</button>`;
    const btnOk    = `<button class="iconBtn" title="Marcar OK" onclick="markOK('${idAttr}')">✅</button>`;
    const btnMsg   = `<button class="iconBtn" title="WhatsApp" onclick="openWhats('${idAttr}')">💬</button>`;
    const btnDel   = `<button class="iconBtn danger" title="Excluir" onclick="deleteLead('${idAttr}')">🗑️</button>`;

    return `
      <div class="leadCard">
        <div class="leadCardTop">
          <div class="leadTitle">
            <div class="leadNameRow">
              <div class="name">${name}</div>
              ${priBadge}
            </div>
            <div class="leadMeta">
              <span>${escapeHTML(phonePretty)}</span>
              <span>•</span>
              <span>${statusPill}</span>
            </div>
          </div>

          <div class="leadActionsRow">
            ${btnEdit}${btnOk}${btnMsg}${btnDel}
          </div>
        </div>

        <div class="leadGrid">
          <div class="kv"><div class="k">Tratamento</div><div class="v">${tratamento}</div></div>
          <div class="kv"><div class="k">Agendamento</div><div class="v">${apptText}</div></div>
          <div class="kv"><div class="k">Origem</div><div class="v">${origem}</div></div>
          <div class="kv"><div class="k">Valores</div><div class="v">Pago: ${moneyBR(paidVal)}<br>Em aberto: ${moneyBR(Math.max(0, openVal))}</div></div>
        </div>
      </div>
    `;
  }).join('');

  if(cardsWrap){
    cardsWrap.innerHTML = cardsHtml || `<div class="muted">Nenhum lead encontrado.</div>`;
  }else{
    tbody.innerHTML = cardsHtml || `<tr><td colspan="6" class="emptyCell">Nenhum lead encontrado.</td></tr>`;
  }
}


function renderSettings(){
  const prefs = getPrefs();
  const ta = el("waTemplate");
  if(ta) ta.value = prefs.waTemplate || "";
}

function renderUsers(){
  const actor = currentActor();
  const db = loadDB();
  const tbody = el("usersTbody");
  const master = db.masters.find(m=>m.id===actor.masterId);
  const users = db.users.filter(u=>u.masterId===actor.masterId);

  const rows = [
    {
      kind:"MASTER",
      name: master?.name || "Master",
      login: master?.email || "—",
      role: "MASTER",
      master: master?.name || "—",
      createdAt: master?.createdAt || ""
    },
    ...users.map(u=>({
      kind:"USER",
      id: u.id,
      name: u.name,
      login: u.username ? `${u.username} / ${u.email||""}` : (u.email||""),
      role: u.role,
      master: master?.name || "—",
      createdAt: u.createdAt
    }))
  ];

  tbody.innerHTML = rows.map(r=>{
    const canManage = actor.perms.manageUsers;
    return `
      <tr>
        <td><b>${escapeHTML(r.name)}</b></td>
        <td class="mono">${escapeHTML(r.login)}</td>
        <td><span class="chip"><span class="dot ${r.role==="MASTER"?"ok":"warm"}"></span>${r.role}</span></td>
        <td>${escapeHTML(r.master)}</td>
        <td class="nowrap">${r.createdAt ? new Date(r.createdAt).toLocaleString("pt-BR") : "—"}</td>
        <td class="nowrap">
          ${r.kind==="USER" && canManage ? ( (r.role==="MASTER" && !actor.perms.manageMasters) ? `<span class="muted">—</span>` : `
            <button class="miniBtn" onclick="openUserEdit('${r.id}')">✏️</button>
            <button class="miniBtn danger" onclick="deleteUser('${r.id}')">🗑️</button>
          ` ) : `<span class="muted">—</span>`}
        </td>
      </tr>
    `;
  }).join("");
}

/* -------- Navigation -------- */
function setActiveView(view){
  qsa(".nav button").forEach(b=> b.classList.toggle("active", b.dataset.view===view));
  ["dashboard","leads","kanban","tasks","installments","users","settings"].forEach(v=>{
    el(`view-${v}`).classList.toggle("hidden", v!==view);
  });
  renderAll();
}

/* -------- Modal helpers -------- */
function openModal({title, sub="", bodyHTML="", footHTML="", onMount=null}){
  el("modalTitle").textContent = title;
  el("modalSub").textContent = sub;
  el("modalBody").innerHTML = bodyHTML;
  el("modalFoot").innerHTML = footHTML;
  el("modalBg").classList.add("show");
  el("modalBg").setAttribute("aria-hidden","false");
  if(typeof onMount==="function") onMount();
}
function closeModal(){
  el("modalBg").classList.remove("show");
  el("modalBg").setAttribute("aria-hidden","true");
}
el("modalClose").addEventListener("click", closeModal);
el("modalBg").addEventListener("click", (e)=>{ if(e.target===el("modalBg")) closeModal(); });

/* -------- Lead create/edit -------- */
function leadEntryFormHTML(entry, contact, mode, suggestHTML){
  const e = entry || {};
  const c = contact || {};
  const isNew = mode==="new";
  const actor = currentActor();
  const ro = !actor.perms.edit;

  function opt(list, cur){
    return list.map(v=>`<option ${cur===v?"selected":""} value="${escapeHTML(v)}">${escapeHTML(v)}</option>`).join("");
  }


  // Tags: aceitar legado (e.tag / c.tags) e garantir render estável
  const __toArr = (v)=> Array.isArray(v) ? v : (v ? [v] : []);
  const __uniq = (arr)=> Array.from(new Set((arr||[]).map(x=>String(x||"").trim()).filter(Boolean)));
  const __manualTagsForUI = __uniq([]
    .concat(__toArr(e.tags))
    .concat(__toArr(e.tag))
    .concat(__toArr(c.tags))
    .concat(__toArr(c.tag))
    .filter(t=>!String(t||"").startsWith("Prioridade:"))
  );

  return `
    <div class="twoCol">
      <div class="suggest">
        <label>Nome *</label>
        <input id="lf_name" ${ro?"disabled":""} value="${escapeHTML(c.name||"")}" placeholder="Ex: Jorge" autocomplete="off"/>
        <div class="suggestBox" id="leadSuggest">${suggestHTML||""}</div>
        <div class="help muted" style="font-size:12px">Se já existir, clique na sugestão pra carregar.</div>
      </div>

      <div class="suggest">
        <label>Telefone/WhatsApp *</label>
        <input id="lf_phone" ${ro?"disabled":""} value="${escapeHTML(c.phone||"")}" placeholder="Ex: 98999990000" autocomplete="off"/>
      </div>

      <div>
        <label>Data do 1º contato (mês)</label>
        <input id="lf_first" type="date" ${ro?"disabled":""} value="${escapeHTML(e.firstContactAt || todayISO())}"/>
      </div>

      <div>
        <label>Mês/Ano</label>
        <input id="lf_month" ${isNew?"":"disabled"} value="${escapeHTML(e.monthKey || val("fMonth"))}" class="mono"/>
        <div class="help muted" style="font-size:12px">Formato: YYYY-MM (ex: 2026-01).</div>
      </div>

      <div>
        <label>Status</label>
        <select id="lf_status" ${ro?"disabled":""}>${opt(STATUS_LIST, e.status || "Conversando")}</select>
      </div>

      
      

      <div>
        <label>Origem</label>
        <select id="lf_origin" ${ro?"disabled":""}>${opt(ORIGINS, e.origin || "Instagram orgânico")}</select>
      </div>

      <div id="originOtherWrap" class="${(e.origin==="Outros")?"":"hidden"}">
        <label>Qual origem?</label>
        <input id="lf_originOther" ${ro?"disabled":""} placeholder="Descreva a origem" value="${escapeHTML(e.originOther||"")}"/>
      </div>

      <div>
        <label>Tratamento</label>
        <select id="lf_treatment" ${ro?"disabled":""}>${opt(TREATMENTS, e.treatment || "Clínica geral")}</select>
      </div>

      <div id="treatOtherWrap" class="${(e.treatment==="Outros")?"":"hidden"}">
        <label>Qual tratamento?</label>
        <input id="lf_treatOther" ${ro?"disabled":""} placeholder="Descreva o tratamento" value="${escapeHTML(e.treatmentOther||"")}"/>
      </div>


<div>
        <label>Valor do orçamento (R$) <span class="muted" style="font-weight:400">(opcional)</span></label>
        <input id="lf_value_budget" type="number" step="0.01" min="0" ${ro?"disabled":""} placeholder="Ex: 12000" value="${(e.valueBudget!=null)?escapeHTML(e.valueBudget):((e.valueEstimated!=null)?escapeHTML(e.valueEstimated):"")}"/>
        <div class="help muted" style="font-size:12px">Quanto foi orçado/proposto.</div>
      </div>

      <div>
        <label>Valor pago (R$) <span class="muted" style="font-weight:400">(opcional)</span></label>
        <input id="lf_value_paid" type="number" step="0.01" min="0" ${ro?"disabled":""} placeholder="Ex: 3000" value="${(e.valuePaid!=null)?escapeHTML(e.valuePaid):((e.valueClosed!=null)?escapeHTML(e.valueClosed):"")}"/>
        <div class="help muted" style="font-size:12px">Quanto entrou de fato (pode ser parcial).</div>
        <div class="help" style="font-size:12px; margin-top:6px">
          Em aberto: <b class="mono" id="lf_open_value">—</b>
        </div>
      
      <div class="hr" style="margin:10px 0; opacity:.6"></div>

      <div class="twoCol" style="gap:14px">
        <div>
          <label>Forma de pagamento <span class="muted" style="font-weight:400">(parcelamento)</span></label>
          <select id="lf_pay_method">
            <option value="">—</option>
            <option value="Pix">Pix</option>
            <option value="Cartão de crédito">Cartão de crédito</option>
            <option value="Cartão de débito">Cartão de débito</option>
            <option value="Espécie">Espécie</option>
            <option value="Boleto">Boleto</option>
          </select>
          <div class="help muted" style="font-size:12px">Usado para priorizar cobrança (boleto = risco maior).</div>
        </div>
        <div>
          <label>Entrada (R$)</label>
          <input id="lf_entry_amount" type="number" step="0.01" min="0" placeholder="Ex: 1000" />
          <div class="help muted" style="font-size:12px">Se recebeu entrada e o restante vai parcelar.</div>
        </div>
        <div>
          <label>Valor para parcelar (R$)</label>
          <input id="lf_inst_amount" type="number" step="0.01" min="0" placeholder="Ex: 2000" />
        </div>
        <div>
          <label>Vezes</label>
          <input id="lf_inst_n" type="number" step="1" min="1" placeholder="Ex: 10" />
          <div class="help" style="font-size:12px; margin-top:6px">Parcela estimada: <b class="mono" id="lf_inst_each">—</b></div>
        </div>
        <div>
          <label>1º vencimento</label>
          <input id="lf_inst_firstdue" type="date" />
          <div class="help muted" style="font-size:12px">Se vazio, usa o mesmo dia no próximo mês.</div>
        </div>
      </div>

</div>
</div>

      <div>
        <label>Agendamento (data)</label>
        <input id="lf_apptDate" type="date" ${ro?"disabled":""} value="${escapeHTML(e.apptDate||"")}"/>
      </div>

      <div>
        <label>Agendamento (hora)</label>
        <input id="lf_apptTime" type="time" ${ro?"disabled":""} value="${escapeHTML(e.apptTime||"")}"/>
      </div>

      <div>
        <label>Tentativas de ligação</label>
        <select id="lf_calls" ${ro?"disabled":""}>
          ${["","1","2","3","Mais","Mensagem enviada"].map(v=>`<option value="${v}" ${(String(e.callAttempts||"")===v)?"selected":""}>${v||"—"}</option>`).join("")}
        </select>
      </div>

      <div>
        <label>Resultado da ligação</label>
        <select id="lf_callResult" ${ro?"disabled":""}>
          ${["","Atendeu na 1ª","Atendeu na 2ª","Atendeu na 3ª","Não atendeu","Respondeu mensagem"].map(v=>`<option value="${v}" ${(String(e.callResult||"")===v)?"selected":""}>${v||"—"}</option>`).join("")}
        </select>
      </div>

      <div class="twoCol" style="grid-column:1/-1">
        <div>
          <label>Tag manual</label>
          <input id="lf_tag" ${ro?"disabled":""} placeholder="Ex: ticket alto, retorno, resgate..." />
          <div class="help muted" style="font-size:12px">Enter adiciona tag.</div>
          <div id="lf_tag_list" class="tagList">${(__manualTagsForUI||[]).map(t=>`<span class="tagPill">${escapeHTML(t)}</span>`).join("")}</div>
        </div>
        <div>
          <label>Prioridade</label>
          <select id="lf_priority" ${ro?"disabled":""}>
            ${["Frio","Morno","Quente"].map(v=>`<option value="${v}" ${(e.tags||[]).includes("Prioridade: "+v)?"selected":""}>${v}</option>`).join("")}
          </select>
        </div>
      </div>

      <div style="grid-column:1/-1">
        <label>Observações</label>
        <textarea id="lf_notes" ${ro?"disabled":""} placeholder="Contexto, objeções, próximo passo...">${escapeHTML(e.notes||"")}</textarea>
      </div>

      <div style="grid-column:1/-1">
        <div class="muted" style="font-size:12px; display:flex; gap:10px; flex-wrap:wrap">
          <span class="tagPill">1º contato global: <b>${c.firstSeenAt ? fmtBR(c.firstSeenAt.slice(0,10)) : "—"}</b></span>
          <span class="tagPill">Últ. atualização (mês): <b>${e.lastUpdateAt ? fmtBR(e.lastUpdateAt.slice(0,10)) : "—"}</b></span>
          ${(e.tags||[]).includes("Resgatado") ? `<span class="tagPill">♻️ Resgatado</span>` : ``}
        </div>
      </div>

      <div style="grid-column:1/-1">
        <div class="muted" style="font-size:12px">Histórico (meses):</div>
        <div id="lf_history" class="muted" style="font-size:12px; margin-top:6px"></div>
      </div>
    </div>
  `;
}

function buildSuggestList(actor, typedName, typedPhone){
  const db = loadDB();
  const phoneN = normPhone(typedPhone);
  const nameN = (typedName||"").trim().toLowerCase();
  if(!phoneN && nameN.length < 2) return "";
  const contacts = db.contacts
    .filter(c=>c.masterId===actor.masterId)
    .filter(c=>{
      const byPhone = phoneN ? c.phone.includes(phoneN) : false;
      const byName = nameN ? (c.name||"").toLowerCase().includes(nameN) : false;
      return byPhone || byName;
    })
    .slice(0,10);

  if(!contacts.length) return "";
  return contacts.map(c=>{
    const entries = db.entries.filter(e=>e.contactId===c.id).sort((a,b)=>b.monthKey.localeCompare(a.monthKey));
    const last = entries[0];
    const lastTxt = last ? `${monthLabel(last.monthKey)} • ${last.status}` : "—";
    return `
      <div class="suggestItem" data-contact="${c.id}">
        <b>${escapeHTML(c.name)} • ${escapeHTML(c.phone)}</b>
        <small>${escapeHTML(lastTxt)}</small>
      </div>
    `;
  }).join("");
}

function openNewLead(){
  const actor = currentActor();
  if(!actor){ toast("Sessão expirada", "Faça login novamente."); showAuth(); return; }
  const monthKey = val("fMonth", new Date().toISOString().slice(0,7));
  const entry = { monthKey, firstContactAt: todayISO(), status:"Conversando", origin:"Instagram orgânico", treatment:"Clínica geral", tags:[] };
  const contact = { name:"", phone:"", firstSeenAt:"", lastSeenAt:"" };

  openModal({
    title: "Novo Lead",
    sub: "Se já existir, selecione a sugestão. Se existir e já tiver neste mês, ele abre pra editar.",
    bodyHTML: leadEntryFormHTML(entry, contact, "new", ""),
    footHTML: `
      <button class="btn" onclick="closeModal()">Cancelar</button>
      <button class="btn ok" id="btnSaveLead">Salvar</button>
    `,
    onMount: ()=>{
      wireLeadModal(actor, null, true);
      qs("#lf_name").focus();
    }
  });
}

function openLeadEntry(entryId){
  const actor = currentActor();
  if(!actor){ toast("Sessão expirada", "Faça login novamente."); showAuth(); return; }
  const db = loadDB();
  const entry = db.entries.find(e=>e.id===entryId);
  if(!entry) return toast("Lead não encontrado");
  const contact = db.contacts.find(c=>c.id===entry.contactId);

  openModal({
    title: "Editar Lead",
    sub: "Atualize o que precisar. Histórico fica salvo.",
    bodyHTML: leadEntryFormHTML(entry, contact, "edit", ""),
    footHTML: `
      <button class="btn" onclick="closeModal()">Fechar</button>
      ${actor.perms.edit ? `<button class="btn ok" id="btnSaveLead">Salvar</button>` : ``}
    `,
    onMount: ()=>{
      wireLeadModal(actor, entryId, false);
      fillHistory(contact.id);
    }
  });
}



function printLeadEntry(entryId){
  const actor = currentActor();
  const db = loadDB();
  const e = db.entries.find(x=>x.id===entryId);
  if(!e) return toast("Lead não encontrado");
  const c = db.contacts.find(x=>x.id===e.contactId);
  const master = db.masters.find(m=>m.id===actor.masterId);

  const logo = getSmallLogoDataURI ? getSmallLogoDataURI() : "";
  const title = `Ficha do Lead • ${escapeHTML(c?.name||"")}`;
  const htmlDoc = `
<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>${title}</title>
<style>
  body{font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 26px; color:#111;}
  .head{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px; border-bottom:1px solid #ddd; padding-bottom:12px;}
  .brand{display:flex; align-items:center; gap:10px;}
  .brand img{width:34px; height:34px;}
  h1{font-size:18px; margin:0;}
  .sub{font-size:12px; color:#555; margin-top:2px;}
  .grid{display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:14px;}
  .card{border:1px solid #ddd; border-radius:12px; padding:12px;}
  .label{font-size:11px; color:#555; text-transform:uppercase; letter-spacing:.04em;}
  .val{margin-top:6px; font-size:14px;}
  .mono{font-variant-numeric: tabular-nums;}
  .tags{margin-top:8px;}
  .pill{display:inline-block; padding:3px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; margin: 2px 4px 0 0;}
  table{width:100%; border-collapse:collapse; margin-top:10px;}
  th,td{border-bottom:1px solid #eee; text-align:left; padding:8px 6px; font-size:12px; vertical-align:top;}
  th{color:#444;}
  .muted{color:#666;}
  @media print{ body{margin: 16mm;} }
</style>
</head>
<body>
  <div class="head">
    <div class="brand">
      ${logo?`<img src="${logo}" alt="Cronos"/>`:``}
      <div>
        <h1>${escapeHTML(master?.name||"Clínica")} — Ficha do Lead</h1>
        <div class="sub">Gerado em ${new Date().toLocaleString("pt-BR")} • Mês: <span class="mono">${escapeHTML(e.monthKey||"")}</span></div>
      </div>
    </div>
    <div class="muted" style="font-size:12px">Cronos CRM</div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="label">Paciente/Lead</div>
      <div class="val"><b>${escapeHTML(c?.name||"—")}</b></div>
      <div class="val muted">${escapeHTML(c?.phone||"—")}</div>
      ${e.city?`<div class="val muted">${escapeHTML(e.city)}</div>`:``}
      <div class="tags">${(e.tags||[]).map(t=>`<span class="pill">${escapeHTML(t)}</span>`).join("")}</div>
    </div>
    <div class="card">
      <div class="label">Status</div>
      <div class="val"><b>${escapeHTML(e.status||"—")}</b></div>
      <div class="val muted">Origem: ${escapeHTML(e.originOther?`${e.origin} — ${e.originOther}`: (e.origin||"—"))}</div>
      <div class="val muted">Tratamento: ${escapeHTML(e.treatmentOther?`${e.treatment} — ${e.treatmentOther}`:(e.treatment||"—"))}</div>
    </div>

    <div class="card">
      <div class="label">Datas</div>
      <div class="val">1º contato: <span class="mono">${fmtBR(e.firstContactAt||"")}</span></div>
      <div class="val">Última atualização: <span class="mono">${fmtBR(e.lastUpdateAt||"")}</span></div>
      <div class="val">Agendamento: <span class="mono">${e.apptDate?`${fmtBR(e.apptDate)} ${e.apptTime||""}`.trim():"—"}</span></div>
    </div>

    <div class="card">
      <div class="label">Ligações</div>
      <div class="val">Tentativas: <span class="mono">${escapeHTML(e.callAttempts||"—")}</span></div>
      <div class="val">Resultado: <span class="mono">${escapeHTML(e.callResult||"—")}</span></div>
    </div>

    <div class="card">
      <div class="label">Valores</div>
      <div class="val">Orçamento: <span class="mono">${(e.valueBudget!=null)?moneyBR(Number(e.valueBudget)):( (e.valueEstimated!=null)?moneyBR(Number(e.valueEstimated)):"—")}</span></div>
      <div class="val">Pago: <span class="mono">${(e.valuePaid!=null)?moneyBR(Number(e.valuePaid)):( (e.valueClosed!=null)?moneyBR(Number(e.valueClosed)):"—")}</span></div>
      <div class="val">Em aberto: <span class="mono">${(()=>{ const b=(e.valueBudget!=null && !isNaN(Number(e.valueBudget)))?Number(e.valueBudget):((e.valueEstimated!=null && !isNaN(Number(e.valueEstimated)))?Number(e.valueEstimated):0); const p=(e.valuePaid!=null && !isNaN(Number(e.valuePaid)))?Number(e.valuePaid):((e.valueClosed!=null && !isNaN(Number(e.valueClosed)))?Number(e.valueClosed):0); const o=Math.max(0,(b||0)-(p||0)); return o?moneyBR(o):"—"; })()}</span></div>
    </div>

    <div class="card" style="grid-column:1/-1">
      <div class="label">Observações</div>
      <div class="val">${escapeHTML(e.notes||"—")}</div>
    </div>

    <div class="card" style="grid-column:1/-1">
      <div class="label">Histórico (por mês)</div>
      <table>
        <thead><tr><th>Mês</th><th>Status</th><th>Agendamento</th><th class="mono">Orçamento</th><th class="mono">Pago</th><th class="mono">Em aberto</th></tr></thead>
        <tbody>
          ${db.entries.filter(x=>x.masterId===actor.masterId && x.contactId===c?.id).sort((a,b)=>b.monthKey.localeCompare(a.monthKey)).map(x=>`
            <tr>
              <td class="mono">${escapeHTML(x.monthKey||"")}</td>
              <td>${escapeHTML(x.status||"")}</td>
              <td class="mono">${x.apptDate?`${fmtBR(x.apptDate)} ${x.apptTime||""}`.trim():"—"}</td>
              <td class="mono">${(x.valueBudget!=null && !isNaN(Number(x.valueBudget)))?moneyBR(Number(x.valueBudget)):( (x.valueEstimated!=null && !isNaN(Number(x.valueEstimated)))?moneyBR(Number(x.valueEstimated)):"—")}</td><td class="mono">${(x.valuePaid!=null && !isNaN(Number(x.valuePaid)))?moneyBR(Number(x.valuePaid)):( (x.valueClosed!=null && !isNaN(Number(x.valueClosed)))?moneyBR(Number(x.valueClosed)):"—")}</td><td class="mono">${(()=>{ const b=(x.valueBudget!=null && !isNaN(Number(x.valueBudget)))?Number(x.valueBudget):((x.valueEstimated!=null && !isNaN(Number(x.valueEstimated)))?Number(x.valueEstimated):0); const p=(x.valuePaid!=null && !isNaN(Number(x.valuePaid)))?Number(x.valuePaid):((x.valueClosed!=null && !isNaN(Number(x.valueClosed)))?Number(x.valueClosed):0); const o=Math.max(0,(b||0)-(p||0)); return o?moneyBR(o):"—"; })()}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  </div>

<script>window.onload=()=>{ setTimeout(()=>window.print(), 250); };<\/script>

<div id="chartTooltip" aria-hidden="true"></div>

<div id="kpiModal" class="modal hidden" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modalInner" style="max-width:720px">
    <div class="modalHeader">
      <div>
        <div class="muted" style="font-size:12px">KPIs</div>
        <div id="kpiModalTitle" style="font-size:18px; font-weight:800">Detalhes</div>
      </div>
      <button class="btn" id="kpiModalClose">Fechar</button>
    </div>
    <div class="modalBody" style="padding-top:10px">
      <div class="muted" id="kpiModalSub" style="margin-bottom:10px"></div>
      <div id="kpiModalList" class="stack" style="gap:10px"></div>
    </div>
  </div>
</div>

</body>
</html>`;
  const w = window.open("", "_blank");
  if(!w) return toast("Popup bloqueado", "Permita popups para imprimir.");
  w.document.open();
  w.document.write(htmlDoc);
  w.document.close();
}

function fillHistory(contactId){
  const db = loadDB();
  const entries = db.entries.filter(e=>e.contactId===contactId).sort((a,b)=>b.monthKey.localeCompare(a.monthKey));
  const box = qs("#lf_history");
  if(!box) return;
  box.innerHTML = entries.map(e=>{
    const s = `${monthLabel(e.monthKey)} • ${e.status} • 1º ${fmtBR(e.firstContactAt)}`;
    return `<span class="tagPill">${escapeHTML(s)}</span>`;
  }).join(" ");
}

function wireLeadModal(actor, editingEntryId, isNew){
  const db = loadDB();
  const suggestBox = el("leadSuggest");

  // toggle others
  const originSel = el("lf_origin");
  const treatSel = el("lf_treatment");
  const toggleOrigin = ()=> el("originOtherWrap").classList.toggle("hidden", originSel.value!=="Outros");
  const toggleTreat = ()=> el("treatOtherWrap").classList.toggle("hidden", treatSel.value!=="Outros");
  originSel?.addEventListener("change", toggleOrigin);
  treatSel?.addEventListener("change", toggleTreat);

  // valores: em aberto (orçamento - pago)
  const budgetInp = el("lf_value_budget");
  const paidInp = el("lf_value_paid");
  const openEl = el("lf_open_value");
  const updateOpen = ()=>{
    if(!openEl) return;
    const b = (budgetInp && budgetInp.value!=="") ? Number(budgetInp.value) : null;
    const p = (paidInp && paidInp.value!=="") ? Number(paidInp.value) : null;
    if(b==null && p==null){ openEl.textContent = "—"; return; }
    const open = Math.max(0, (b||0) - (p||0));
    openEl.textContent = moneyBR(open);
  };
  budgetInp?.addEventListener("input", updateOpen);
  paidInp?.addEventListener("input", updateOpen);
  updateOpen();


  // parcelamento: pré-preencher + cálculo de parcela estimada
  const pmSel = el("lf_pay_method");
  const entryAmt = el("lf_entry_amount");
  const instAmt = el("lf_inst_amount");
  const instN = el("lf_inst_n");
  const instEach = el("lf_inst_each");
  const instFirst = el("lf_inst_firstdue");

  const fillPlan = ()=>{
    try{
      const db2 = loadDB();
      let curEntry = null;
      if(editingEntryId) curEntry = db2.entries.find(e=>e.id===editingEntryId);
      if(curEntry && curEntry.installPlan){
        pmSel && (pmSel.value = curEntry.installPlan.payMethod||"");
        entryAmt && (entryAmt.value = curEntry.installPlan.entryAmount!=null ? curEntry.installPlan.entryAmount : "");
        instAmt && (instAmt.value = curEntry.installPlan.amount!=null ? curEntry.installPlan.amount : "");
        instN && (instN.value = curEntry.installPlan.n!=null ? curEntry.installPlan.n : "");
        instFirst && (instFirst.value = curEntry.installPlan.firstDue||"");
      }
    }catch(e){}
  };

  const calcEach = ()=>{
    if(!instEach) return;
    const a = instAmt && instAmt.value!=="" ? Number(instAmt.value) : 0;
    const n = instN && instN.value!=="" ? Math.max(1, parseInt(instN.value,10)) : 0;
    if(a>0 && n>0) instEach.textContent = moneyBR(a/n);
    else instEach.textContent = "—";
  };
  instAmt?.addEventListener("input", calcEach);
  instN?.addEventListener("input", calcEach);
  calcEach();
  fillPlan();


  // suggestions
  const nameInp = el("lf_name");
  const phoneInp = el("lf_phone");
  const showSuggest = ()=>{
    const html = buildSuggestList(actor, nameInp.value, phoneInp.value);
    if(!html){ suggestBox.classList.remove("show"); suggestBox.innerHTML=""; return; }
    suggestBox.innerHTML = html;
    suggestBox.classList.add("show");
    qsa(".suggestItem", suggestBox).forEach(it=>{
      it.addEventListener("click", ()=>{
        const cid = it.getAttribute("data-contact");
        loadExistingContactIntoModal(cid, actor, isNew);
      });
    });
  };
  nameInp?.addEventListener("input", ()=>{ showSuggest(); });
  phoneInp?.addEventListener("input", ()=>{ showSuggest(); });

  // hide suggest on blur (small delay for click)
  [nameInp, phoneInp].forEach(inp=>{
    inp?.addEventListener("blur", ()=>setTimeout(()=>suggestBox.classList.remove("show"), 180));
    inp?.addEventListener("focus", ()=>showSuggest());
  });

  // tag adding (persistente)
  const tagInp = el("lf_tag");
  const tagListEl = el("lf_tag_list");

  const __uniqTags = (arr)=> Array.from(new Set((arr||[]).map(x=>String(x||"").trim()).filter(Boolean)));

  const __renderTagList = ()=>{
    if(!tagListEl) return;
    const cur = __uniqTags(JSON.parse(tagInp?.dataset.tags||"[]"));
    if(cur.length===0){
      tagListEl.innerHTML = "";
      return;
    }
    tagListEl.innerHTML = cur.map((t,i)=>`<span class="tagPill" data-i="${i}">${escapeHTML(t)}<button type="button" class="tagRemove" data-i="${i}" aria-label="Remover tag">×</button></span>`).join("");
  };

  // remover tag (clicando no ×)
  if(tagListEl){
    tagListEl.addEventListener("click", (e)=>{
      const btn = e.target?.closest?.(".tagRemove");
      if(!btn) return;
      e.preventDefault();
      const i = parseInt(btn.dataset.i, 10);
      let cur = [];
      try{ cur = __uniqTags(JSON.parse(tagInp?.dataset.tags||"[]")); }catch(_){ cur = []; }
      if(Number.isNaN(i) || i<0 || i>=cur.length) return;
      cur.splice(i,1);
      if(tagInp) tagInp.dataset.tags = JSON.stringify(cur);
      __renderTagList();
    });
  }



  // init: puxa tags já salvas (sem "Prioridade:")
  try{
    const db3 = loadDB();
    let ent = null;
    let cont = null;
    if(editingEntryId){
      ent = db3.entries.find(x=>x.id===editingEntryId) || null;
      cont = ent ? db3.contacts.find(cc=>cc.id===ent.contactId) : null;
    }
    const saved = ([])
      .concat(Array.isArray(ent?.tags)?ent.tags:(ent?.tags?[ent.tags]:[]))
      .concat(Array.isArray(ent?.tag)?ent.tag:(ent?.tag?[ent.tag]:[]))
.map(x=>String(x||"").trim())
      .filter(Boolean)
      .filter(t=>!t.startsWith("Prioridade:"));
    if(tagInp){
      tagInp.dataset.tags = JSON.stringify(__uniqTags(saved));
    }
  }catch(_){}
  __renderTagList();

  tagInp?.addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){
      e.preventDefault();
      const v = (tagInp.value||"").trim();
      if(!v) return;
      tagInp.value="";
      const cur = __uniqTags(JSON.parse(tagInp.dataset.tags||"[]").concat([v]));
      tagInp.dataset.tags = JSON.stringify(cur);
      __renderTagList();
      toast("Tag adicionada", v);
    }
  });

// Save
  const btn = el("btnSaveLead");
  btn?.addEventListener("click", async ()=>{
    if(!actor.perms.edit) return toast("Sem permissão", "Seu nível não permite editar.");

    const name = val("lf_name").trim();
    const phone = normPhone(val("lf_phone"));
    if(!name || !phone) return toast("Nome e telefone são obrigatórios");

    const monthKey = (val("lf_month","") || val("fMonth", new Date().toISOString().slice(0,7))).trim();
    if(!/^\d{4}-\d{2}$/.test(monthKey)) return toast("Mês inválido", "Use YYYY-MM (ex: 2026-01)");

    // find or create contact (unique by phone)
    let contact = db.contacts.find(c=>c.masterId===actor.masterId && c.phone===phone);
    const now = new Date().toISOString();
    if(!contact){
      contact = { id: uid("c"), masterId: actor.masterId, name, phone, firstSeenAt: val("lf_first") || todayISO(), lastSeenAt: val("lf_first") || todayISO() };
      db.contacts.push(contact);
    }else{
      contact.name = name; // update name
      contact.lastSeenAt = (val("lf_first") || todayISO());
    }

    const status = val("lf_status");
    const origin = val("lf_origin");
    const originOther = origin==="Outros" ? val("lf_originOther").trim() : "";
    const treatment = val("lf_treatment");
    const treatmentOther = treatment==="Outros" ? val("lf_treatOther").trim() : "";
    const city = val("lf_city").trim();
    const firstContactAt = val("lf_first") || todayISO();
    const apptDate = val("lf_apptDate") || "";
    const apptTime = val("lf_apptTime") || "";
    const callAttempts = val("lf_calls") || "";
    const callResult = val("lf_callResult") || "";
    const notes = val("lf_notes").trim();

    const valueBudgetRaw = el("lf_value_budget")?.value;
    const valueBudget = (valueBudgetRaw!==undefined && valueBudgetRaw!==null && valueBudgetRaw!=="") ? Number(valueBudgetRaw) : null;
    const valuePaidRaw = el("lf_value_paid")?.value;
    const valuePaid = (valuePaidRaw!==undefined && valuePaidRaw!==null && valuePaidRaw!=="") ? Number(valuePaidRaw) : null;

    let manualTags = [];
    try{ manualTags = JSON.parse((tagInp?.dataset.tags)||"[]") || []; }catch(_){ manualTags = []; }
    // Se o usuário digitou uma tag e clicou em "Salvar" sem dar Enter, não vamos perder.
    const pendingTag = (tagInp?.value||"").trim();
    if(pendingTag){
      manualTags = Array.from(new Set([...(manualTags||[]), pendingTag]));
      if(tagInp){ tagInp.value=""; tagInp.dataset.tags = JSON.stringify(manualTags); }
    }
    const prio = val("lf_priority");
    let tags = [];
    if(prio) tags.push("Prioridade: " + prio);
    tags.push(...manualTags);

    // resgatado rule: if contact existed before and new month entry being created
    const hadBefore = db.entries.some(e=>e.masterId===actor.masterId && e.contactId===contact.id && e.monthKey !== monthKey);
    const existingThisMonth = db.entries.find(e=>e.masterId===actor.masterId && e.contactId===contact.id && e.monthKey === monthKey);

    if(isNew && existingThisMonth){
      // instead of duplicate, open existing entry and update it
      saveDB(db);
      toast("Esse lead já existe neste mês", "Abrindo pra editar.");
      closeModal();
      openLeadEntry(existingThisMonth.id);
      return;
    }

    let entry;
    if(editingEntryId){
      entry = db.entries.find(e=>e.id===editingEntryId);
      if(!entry) return toast("Erro", "Entrada não encontrada");
    }else{
      entry = { id: uid("e"), masterId: actor.masterId, contactId: contact.id, monthKey, statusLog: [], tags: [] };
      db.entries.push(entry);
    }

    const fromStatus = entry.status || "";
    const toStatus = status;

    // update entry fields
    entry.monthKey = monthKey;
    entry.firstContactAt = firstContactAt;
    entry.lastUpdateAt = now;
    entry.status = status;
    entry.origin = origin;
    entry.originOther = originOther;
    entry.treatment = treatment;
    entry.treatmentOther = treatmentOther;
    entry.city = city;
    entry.notes = notes;
    entry.valueBudget = valueBudget;
    entry.valuePaid = valuePaid;
    // legacy fields (compat): mantêm relatórios antigos funcionando
    entry.valueEstimated = valueBudget;
    entry.valueClosed = (status==="Fechou") ? valuePaid : null;
    entry.apptDate = apptDate;
    entry.apptTime = apptTime;
    entry.callAttempts = callAttempts;
    entry.callResult = callResult;

    // tags: sobrescreve tags manuais (permite remover), preservando tags de sistema
const preserved = (entry.tags||[]).filter(t=>String(t)==="Resgatado");
entry.tags = Array.from(new Set([...preserved, ...tags]));
// add "Resgatado" if hadBefore and this is new entry
if(!editingEntryId && hadBefore){
  entry.tags = Array.from(new Set([...(entry.tags||[]), "Resgatado"]));
}


    // status log
    if(fromStatus !== toStatus){
      entry.statusLog = entry.statusLog || [];
      entry.statusLog.push({ at: now, from: fromStatus, to: toStatus, by: actor.name });
    }


    /* ===== Parcelamento: captura e gera parcelas ===== */
    const payMethod = val("lf_pay_method","").trim();
    const entryAmtRaw = el("lf_entry_amount")?.value;
    const entryAmount = (entryAmtRaw!==undefined && entryAmtRaw!==null && entryAmtRaw!=="") ? Number(entryAmtRaw) : 0;
    const instAmtRaw = el("lf_inst_amount")?.value;
    const instAmount = (instAmtRaw!==undefined && instAmtRaw!==null && instAmtRaw!=="") ? Number(instAmtRaw) : 0;
    const instNRaw = el("lf_inst_n")?.value;
    const instN = (instNRaw!==undefined && instNRaw!==null && instNRaw!=="") ? parseInt(instNRaw,10) : 0;
    const firstDue = val("lf_inst_firstdue","").trim();

    // Se tiver entrada, soma no valuePaid automaticamente (sem tirar do que você digitou, só se valuePaid estiver vazio)
    if(entryAmount>0 && (valuePaid==null || isNaN(valuePaid))){
      entry.valuePaid = entryAmount;
      entry.valueClosed = (status==="Fechou") ? entry.valuePaid : null;
    }

    if(instAmount>0 && instN>0){
      entry.installPlan = { amount: instAmount, n: instN, firstDue: firstDue, payMethod: payMethod, entryAmount: entryAmount, each: Number((instAmount/instN).toFixed(2)) };
      buildInstallments(entry);
    }else{
      // se zerou os campos, remove plano
      entry.installPlan = null;
      entry.installments = [];
    }

    saveDB(db);
    closeModal();
    ensureMonthOptions(); // in case new month
    toast("Lead salvo ✅", `${name} • ${monthLabel(monthKey)}`);
    renderAll();
  });
}

function loadExistingContactIntoModal(contactId, actor, isNew){
  const db = loadDB();
  const c = db.contacts.find(x=>x.id===contactId);
  if(!c) return;
  // If entry exists for selected month, open it
  const monthKey = (val("lf_month","") || val("fMonth", new Date().toISOString().slice(0,7))).trim();
  const existing = db.entries.find(e=>e.masterId===actor.masterId && e.contactId===c.id && e.monthKey===monthKey);
  if(existing){
    closeModal();
    openLeadEntry(existing.id);
    return;
  }
  // Fill name/phone fields, keep rest
  el("lf_name").value = c.name || "";
  el("lf_phone").value = c.phone || "";
  fillHistory(c.id);
  toast("Cadastro carregado", "Agora você cria a entrada do mês.");
}

/* -------- Delete -------- */

function toggleLeadDone(entryId){
  const db = loadDB();
  const e = db.entries.find(x=>x.id===entryId);
  if(!e) return;
  // simple toggle: status between "Concluído" and previous
  if(e.status==="Concluído"){
    e.status = e._prevStatus || "Conversando";
    delete e._prevStatus;
  }else{
    e._prevStatus = e.status || "Conversando";
    e.status = "Concluído";
  }
  e.lastUpdateAt = new Date().toISOString();
  saveDB(db);
  renderAll();
}


/* ===== Ações rápidas (aba Leads em cards) =====
   ✅ markOK: marca como "Fechou"
   💬 openWhats: abre WhatsApp do lead (template simples)
   🗑️ deleteLead: wrapper para deleteEntry
*/
function markOK(entryId){
  try{
    const actor = currentActor();
    if(!actor){ toast("Sessão expirada", "Faça login novamente."); showAuth(); return; }
    if(!actor.perms.edit) return toast("Sem permissão", "Seu nível não permite editar.");
    const db = loadDB();
    const entry = (db.entries||[]).find(e=>String(e.id)===String(entryId));
    if(!entry) return toast("Erro", "Lead não encontrado.");

    const fromStatus = String(entry.status||"");
    let toStatus = "Concluído";

    // Toggle: se já estiver Concluído, volta pro status anterior (quando existir)
    if(fromStatus === "Concluído"){
      const back = entry._prevStatus || entry.prevStatus || "";
      if(back && back !== "Concluído"){
        toStatus = back;
      }else{
        // fallback seguro
        toStatus = "Sem resposta";
      }
      entry._prevStatus = null;
      entry.prevStatus = null;
    }else{
      entry._prevStatus = fromStatus;
      entry.prevStatus = fromStatus;
      toStatus = "Concluído";
    }

    entry.status = toStatus;
    entry.lastUpdateAt = new Date().toISOString();

    // compat
    const vp = parseMoney(entry.valuePaid);
    entry.valueClosed = vp || null;

    // log
    entry.statusLog = entry.statusLog || [];
    if(fromStatus !== toStatus){
      entry.statusLog.push({ at: entry.lastUpdateAt, from: fromStatus, to: toStatus, by: actor.name });
    }

    saveDB(db);
    toast("Status atualizado", (toStatus==="Concluído") ? "Marcado como Concluído ✅" : `Voltou para: ${toStatus}`);
    renderAll();
  }catch(e){
    console.error(e);
    toast("Erro", "Não foi possível marcar OK.");
  }
}


function openWhats(entryId){
  try{
    const actor = currentActor();
    if(!actor){ toast("Sessão expirada", "Faça login novamente."); showAuth(); return; }
    const db = loadDB();
    const entry = (db.entries||[]).find(e=>String(e.id)===String(entryId));
    if(!entry) return toast("Erro", "Lead não encontrado.");
    const contact = (db.contacts||[]).find(c=>c.id===entry.contactId) || {};
    const phone = String(contact.phone||entry.phone||"").replace(/\D/g,'');
    if(!phone) return toast("Sem telefone", "Esse lead não tem telefone.");
    // template simples (pode evoluir depois)
    const tpl = (db.settings && db.settings.waTemplate) ? String(db.settings.waTemplate) : "Oi {nome}! Vi seu interesse. Posso te ajudar?";
    const msg = tpl
      .replaceAll("{nome}", String(contact.name||entry.name||""))
      .replaceAll("{tratamento}", String(entry.treatment==="Outros" ? (entry.treatmentOther||"") : (entry.treatment||"")));
    const url = `https://wa.me/55${phone}?text=${encodeURIComponent(msg)}`;
    window.open(url, "_blank");
  }catch(e){
    console.error(e);
    toast("Erro", "Não foi possível abrir o WhatsApp.");
  }
}

function deleteLead(entryId){
  return deleteEntry(entryId);
}

function deleteEntry(entryId){
  const actor = currentActor();
  if(!actor.perms.delete) return toast("Sem permissão", "Seu nível não permite excluir.");
  const db = loadDB();
  const e = db.entries.find(x=>x.id===entryId);
  if(!e) return;
  const c = db.contacts.find(x=>x.id===e.contactId);
  if(!confirm(`Excluir lead do mês ${monthLabel(e.monthKey)}? (${c?.name||"—"})`)) return;
  db.entries = db.entries.filter(x=>x.id!==entryId);
  saveDB(db);
  toast("Excluído", "Entrada removida.");
  renderAll();
}

/* -------- Users CRUD -------- */
function userFormHTML(user){
  const u = user || {name:"", username:"", email:"", role:"SECRETARIA"};
  return `
    <div class="twoCol">
      <div>
        <label>Nome</label>
        <input id="uf_name" value="${escapeHTML(u.name||"")}" placeholder="Ex: Ana"/>
      </div>
      <div>
        <label>Nível</label>
        <select id="uf_role">
          ${( (currentActor()?.perms?.manageMasters) ? ROLES : ROLES.filter(r=>r!=="MASTER") ).map(r=>`<option value="${r}" ${u.role===r?"selected":""}>${r}</option>`).join("")}
        </select>
      </div>
      <div>
        <label>Usuário (opcional)</label>
        <input id="uf_username" value="${escapeHTML(u.username||"")}" placeholder="Ex: secretaria1"/>
      </div>
      <div>
        <label>E-mail</label>
        <input id="uf_email" value="${escapeHTML(u.email||"")}" placeholder="email@clinica.com"/>
      </div>
      <div style="grid-column:1/-1">
        <label>Senha</label>
        <input id="uf_pass" type="password" placeholder="defina uma senha"/>
      </div>
      <div class="muted" style="font-size:12px; grid-column:1/-1">
        Login do interno pode ser <b>usuário</b> ou <b>e-mail</b>.
      </div>
    </div>
  `;
}

function openNewUser(){
  const actor = currentActor();
  if(!actor.perms.manageUsers) return toast("Sem permissão", "Somente Master pode gerenciar usuários.");
  openModal({
    title: "Novo usuário",
    sub: "Usuário interno vinculado ao Master.",
    bodyHTML: userFormHTML(null),
    footHTML: `
      <button class="btn" onclick="closeModal()">Cancelar</button>
      <button class="btn ok" id="btnSaveUser">Salvar</button>
    `,
    onMount: ()=>{
      el("btnSaveUser").addEventListener("click", async ()=>{
        const db = loadDB();
        const name = val("uf_name").trim();
        const role = val("uf_role");
        if(role==="MASTER" && !actor.perms.manageMasters) return toast("Bloqueado", "Só o Master principal pode criar outros masters.");

        const username = val("uf_username").trim();
        const email = val("uf_email").trim().toLowerCase();
        const pass = val("uf_pass");
        if(!name) return toast("Nome obrigatório");
        if(!email && !username) return toast("Informe e-mail ou usuário");
        if(!pass) return toast("Senha obrigatória");

        // uniqueness within master
        if(username && db.users.some(u=>u.masterId===actor.masterId && u.username===username)) return toast("Usuário já existe");
        if(email && db.users.some(u=>u.masterId===actor.masterId && u.email===email)) return toast("E-mail já existe");

        const passHash = await hashPass(pass);
        db.users.push({ id: uid("u"), masterId: actor.masterId, name, username, email, role, passHash, createdAt: new Date().toISOString() });
        saveDB(db);
        closeModal();
        toast("Usuário criado ✅", name);
        renderAll();
      });
    }
  });
}

function openUserEdit(userId){
  const actor = currentActor();
  if(!actor.perms.manageUsers) return toast("Sem permissão");
  const db = loadDB();
  const u = db.users.find(x=>x.id===userId);
  if(!u) return toast("Usuário não encontrado");
  openModal({
    title: "Editar usuário",
    sub: "Altere nível e login. (Senha opcional)",
    bodyHTML: userFormHTML(u),
    footHTML: `
      <button class="btn" onclick="closeModal()">Cancelar</button>
      <button class="btn ok" id="btnSaveUser">Salvar</button>
    `,
    onMount: ()=>{
      el("uf_pass").placeholder = "deixe vazio para manter";
      el("btnSaveUser").addEventListener("click", async ()=>{
        const name = val("uf_name").trim();
        const role = val("uf_role");
        if(role==="MASTER" && !actor.perms.manageMasters) return toast("Bloqueado", "Só o Master principal pode promover para MASTER.");

        const username = val("uf_username").trim();
        const email = val("uf_email").trim().toLowerCase();
        const pass = val("uf_pass");
        if(!name) return toast("Nome obrigatório");
        if(!email && !username) return toast("Informe e-mail ou usuário");

        // uniqueness
        if(username && db.users.some(x=>x.masterId===actor.masterId && x.username===username && x.id!==u.id)) return toast("Usuário já existe");
        if(email && db.users.some(x=>x.masterId===actor.masterId && x.email===email && x.id!==u.id)) return toast("E-mail já existe");

        u.name = name;
        u.role = role;
        u.username = username;
        u.email = email;
        if(pass){
          u.passHash = await hashPass(pass);
        }
        saveDB(db);
        closeModal();
        toast("Usuário atualizado ✅");
        renderAll();
      });
    }
  });
}

function deleteUser(userId){
  const actor = currentActor();
  if(!actor.perms.manageUsers) return toast("Sem permissão");
  const db = loadDB();
  const u = db.users.find(x=>x.id===userId);
  if(!u) return;
  if(u.role==="MASTER" && !actor.perms.manageMasters) return toast("Bloqueado", "Só o Master principal pode remover outros masters.");
  if(!confirm(`Excluir usuário ${u.name}?`)) return;
  db.users = db.users.filter(x=>x.id!==userId);
  saveDB(db);
  toast("Usuário excluído");
  renderAll();
}

/* -------- CSV Export -------- */
function exportCSV(){
  const actor = currentActor();
  if(!actor) return;
  const f = getUIFilters();
  const db = loadDB();
  const rows = filteredEntries();

  const headers = ["Nome","Número","Status","Origem","Tratamento","Primeiro contato","Agendamento data","Agendamento hora","Tentativas","Resultado ligação","Cidade","Mês","Orçamento (R$)","Pago (R$)","Em aberto (R$)"];
  const lines = [headers.join(",")];

  rows.forEach(e=>{
    const c = db.contacts.find(x=>x.id===e.contactId);
    const origin = e.origin==="Outros" ? (e.originOther||"Outros") : e.origin;
    const treat = e.treatment==="Outros" ? (e.treatmentOther||"Outros") : e.treatment;
    const arr = [
      csvSafe(c?.name||""),
      csvSafe(c?.phone||""),
      csvSafe(e.status||""),
      csvSafe(origin||""),
      csvSafe(treat||""),
      csvSafe(e.firstContactAt||""),
      csvSafe(e.apptDate||""),
      csvSafe(e.apptTime||""),
      csvSafe(e.callAttempts||""),
      csvSafe(e.callResult||""),
      csvSafe(e.city||""),
      csvSafe(monthLabel(e.monthKey)),
      csvSafe(((e.valueBudget!=null)?Number(e.valueBudget):((e.valueEstimated!=null)?Number(e.valueEstimated):""))),
      csvSafe(((e.valuePaid!=null)?Number(e.valuePaid):((e.valueClosed!=null)?Number(e.valueClosed):""))),
      csvSafe((()=>{ const b=(e.valueBudget!=null)?Number(e.valueBudget):((e.valueEstimated!=null)?Number(e.valueEstimated):0); const p=(e.valuePaid!=null)?Number(e.valuePaid):((e.valueClosed!=null)?Number(e.valueClosed):0); const o=Math.max(0,(b||0)-(p||0)); return o?o:""; })())
    ];
    lines.push(arr.join(","));
  });

  const title = `Leads do mês de ${monthLabel(f.monthKey)}`;
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${title.replaceAll(" ","_")}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(a.href);
  toast("CSV exportado ✅", title);

}

function exportPDFFiltered(){
  const actor = currentActor();
  if(!actor) return;
  const f = getUIFilters();
  const db = loadDB();
  const rows = filteredEntries();

  const title = `Relatório • ${monthLabel(f.monthKey)}`;
  const logo = getSmallLogoDataURI ? getSmallLogoDataURI() : "";
  const master = db.masters.find(m=>m.id===actor.masterId);

  const tableRows = rows.map(e=>{
    const c = db.contacts.find(x=>x.id===e.contactId);
    const origin = e.origin==="Outros" ? (e.originOther||"Outros") : e.origin;
    const treat = e.treatment==="Outros" ? (e.treatmentOther||"Outros") : e.treatment;
    const budget = (e.valueBudget!=null && !isNaN(Number(e.valueBudget))) ? Number(e.valueBudget) : ((e.valueEstimated!=null && !isNaN(Number(e.valueEstimated))) ? Number(e.valueEstimated) : 0);
    const paid = (e.valuePaid!=null && !isNaN(Number(e.valuePaid))) ? Number(e.valuePaid) : ((e.valueClosed!=null && !isNaN(Number(e.valueClosed))) ? Number(e.valueClosed) : 0);
    const open = Math.max(0, (budget||0)-(paid||0));
    const appt = e.apptDate ? `${fmtBR(e.apptDate)} ${e.apptTime||""}`.trim() : "—";
    return `
      <tr>
        <td><b>${escapeHTML(c?.name||"—")}</b><div class="muted">${escapeHTML(c?.phone||"—")}</div></td>
        <td>${escapeHTML(e.status||"—")}</td>
        <td>${escapeHTML(origin||"—")}</td>
        <td>${escapeHTML(treat||"—")}</td>
        <td class="mono">${escapeHTML(appt)}</td>
        <td class="mono">${budget?moneyBR(budget):"—"}</td>
        <td class="mono">${paid?moneyBR(paid):"—"}</td>
        <td class="mono">${open?moneyBR(open):"—"}</td>
      </tr>
    `;
  }).join("");

  const totalPaid = rows.reduce((acc,e)=>{
    const v = (e.valuePaid!=null && !isNaN(Number(e.valuePaid))) ? Number(e.valuePaid) : ((e.valueClosed!=null && !isNaN(Number(e.valueClosed))) ? Number(e.valueClosed) : 0);
    return acc + (v||0);
  },0);

  const htmlDoc = `
<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>${escapeHTML(title)}</title>
<style>
  body{font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; color:#111;}
  .head{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px; border-bottom:1px solid #ddd; padding-bottom:12px;}
  .brand{display:flex; align-items:center; gap:10px;}
  .brand img{width:34px; height:34px;}
  h1{font-size:18px; margin:0;}
  .sub{font-size:12px; color:#555; margin-top:2px;}
  .muted{color:#666;}
  table{width:100%; border-collapse:collapse; margin-top:12px;}
  th,td{border-bottom:1px solid #eee; text-align:left; padding:8px 6px; font-size:12px; vertical-align:top;}
  th{color:#444;}
  .mono{font-variant-numeric: tabular-nums;}
  .footer{margin-top:10px; font-size:12px; color:#444;}
  @media print{ body{margin: 14mm;} }
</style>
</head>
<body>
  <div class="head">
    <div class="brand">
      ${logo?`<img src="${logo}" alt="Cronos"/>`:``}
      <div>
        <h1>${escapeHTML(master?.name||"Clínica")} — Relatório</h1>
        <div class="sub">${escapeHTML(monthLabel(f.monthKey))} • Gerado em ${new Date().toLocaleString("pt-BR")}</div>
      </div>
    </div>
    <div class="mono"><b>Total recebido:</b> ${moneyBR(totalPaid)}</div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Paciente</th>
        <th>Status</th>
        <th>Origem</th>
        <th>Tratamento</th>
        <th>Agendamento</th>
        <th class="mono">Orçamento</th>
        <th class="mono">Pago</th>
        <th class="mono">Em aberto</th>
      </tr>
    </thead>
    <tbody>
      ${tableRows || `<tr><td colspan="8" class="muted">Sem leads no filtro atual.</td></tr>`}
    </tbody>
  </table>

  <div class="footer muted">Dica: ao imprimir, selecione “Salvar como PDF”.</div>

<script>window.onload=()=>{ setTimeout(()=>window.print(), 250); };<\/script>

<div id="chartTooltip" aria-hidden="true"></div>

<div id="kpiModal" class="modal hidden" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modalInner" style="max-width:720px">
    <div class="modalHeader">
      <div>
        <div class="muted" style="font-size:12px">KPIs</div>
        <div id="kpiModalTitle" style="font-size:18px; font-weight:800">Detalhes</div>
      </div>
      <button class="btn" id="kpiModalClose">Fechar</button>
    </div>
    <div class="modalBody" style="padding-top:10px">
      <div class="muted" id="kpiModalSub" style="margin-bottom:10px"></div>
      <div id="kpiModalList" class="stack" style="gap:10px"></div>
    </div>
  </div>
</div>

</body>
</html>`;

  const w = window.open("", "_blank");
  if(!w) return toast("Popup bloqueado", "Permita popups pra gerar PDF.");
  w.document.open();
  w.document.write(htmlDoc);
  w.document.close();
  toast("PDF pronto ✅", title);
}

function csvSafe(s){
  const v = String(s??"").replaceAll('"','""');
  return `"${v}"`;
}

/* -------- Backup / Import -------- */
function exportJSON(){
  const db = loadDB();
  const blob = new Blob([JSON.stringify(db,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `cronoscrm_backup_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(a.href);
  toast("Backup exportado ✅");
}
function importJSON(file){
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const data = JSON.parse(r.result);
      if(!data || typeof data!=="object") throw new Error("invalid");
      // basic shape check
      if(!Array.isArray(data.masters) || !Array.isArray(data.entries)) throw new Error("invalid");
      saveDB(data);
      toast("Backup importado ✅");
      boot();
    }catch(e){
      toast("Falha ao importar", "Arquivo inválido.");
    }
  };
  r.readAsText(file);
}
function wipeAll(){
  if(!confirm("Zerar TUDO? (usuários, leads, masters)")) return;
  localStorage.removeItem(DBKEY);
  localStorage.removeItem(SESSIONKEY);
  localStorage.removeItem(FILTERKEY);
  toast("Zerado 🧨");
  location.reload();
}

/* -------- Render all -------- */

/* -------- Kanban -------- */
const KANBAN_COLUMNS = [
  {title:"Conversando", status:"Conversando"},
  {title:"Agendado", status:"Agendado"},
  {title:"Compareceu", status:"Compareceu"},
  {title:"Fechou", status:"Fechou"},
  {title:"Sem resposta", status:"Sem resposta"},
];

function renderKanban(){
  const actor = currentActor();
  if(!actor) return;
  const rows = filteredEntries().slice(); // respects filters + month
  const db = loadDB();
  const board = el("kanbanBoard");
  if(!board) return;

  const groups = new Map(KANBAN_COLUMNS.map(c=>[c.status, []]));
  rows.forEach(e=>{
    const key = groups.has(e.status) ? e.status : "Conversando";
    groups.get(key).push(e);
  });

  board.innerHTML = KANBAN_COLUMNS.map(col=>{
    const list = groups.get(col.status) || [];
    return `
      <div class="kanCol" data-kan-status="${escapeHTML(col.status)}">
        <div class="kanHead">
          <b>${escapeHTML(col.title)}</b>
          <span class="pill">${list.length}</span>
        </div>
        <div class="kanList" data-dropzone="${escapeHTML(col.status)}">
          ${list.length ? list
            .sort((a,b)=>(b.lastUpdateAt||"").localeCompare(a.lastUpdateAt||""))
            .map(e=>{
              const c = db.contacts.find(x=>x.id===e.contactId);
              const paid = (e.valuePaid!=null && !isNaN(Number(e.valuePaid))) ? Number(e.valuePaid) : 0;
              const budget = (e.valueBudget!=null && !isNaN(Number(e.valueBudget))) ? Number(e.valueBudget) : 0;
              const open = Math.max(0, budget - paid);
              return `
                <div class="kanCard" draggable="true" data-entry="${e.id}">
                  <div style="display:flex; justify-content:space-between; gap:10px">
                    <div>
                      <div style="font-weight:900">${escapeHTML(c?.name||"—")}</div>
                      <div class="muted" style="font-size:12px; margin-top:2px">${escapeHTML(c?.phone||"—")}</div>
                      <div class="muted" style="font-size:12px; margin-top:6px">${escapeHTML(e.treatment||"—")} • ${escapeHTML(e.origin||"—")}</div>
                      ${(budget||paid)?`<div class="muted mono" style="font-size:12px; margin-top:6px">Pago: <b>${moneyBR(paid)}</b> • Em aberto: <b>${moneyBR(open)}</b></div>`:""}
                    </div>
                    <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end">
                      <button class="miniBtn" onclick="openLeadEntry('${e.id}')">Abrir</button>
                      <button class="miniBtn" onclick="printLeadEntry('${e.id}')">🖨️</button>
                    </div>
                  </div>
                </div>
              `;
            }).join("")
          : `<div class="muted" style="font-size:13px">—</div>`}
        </div>
      </div>
    `;
  }).join("");

  // Wire drag & drop (robust: desktop + touch)
  window.__KANBAN_DRAG_ID = null;

  qsa(".kanCard", board).forEach(card=>{
    const id = card.dataset.entry;

    // Desktop HTML5 drag
    card.addEventListener("dragstart", (ev)=>{
      window.__KANBAN_DRAG_ID = id;
      try{
        if(ev.dataTransfer){
          ev.dataTransfer.effectAllowed = "move";
          ev.dataTransfer.setData("text/plain", id);
        }
      }catch(e){}
      setTimeout(()=>card.classList.add("kanDragging"), 0);
    });

    card.addEventListener("dragend", ()=>{
      card.classList.remove("kanDragging");
      window.__KANBAN_DRAG_ID = null;
      qsa(".kanDropHint", board).forEach(x=>x.classList.remove("kanDropHint"));
    });

    // Touch/pointer fallback: tap a card, then tap a column to move
    card.addEventListener("pointerdown", (ev)=>{
      if(ev.pointerType === "mouse") return;
      const t = ev.target;
      if(t && (t.tagName === "BUTTON" || t.closest("button"))) return;
      window.__KANBAN_DRAG_ID = id;
      qsa(".kanCard", board).forEach(c=>c.classList.remove("kanSelected"));
      card.classList.add("kanSelected");
      toast("Toque na coluna para mover");
    });
  });

  function kanbanMoveTo(status){
    const entryId = window.__KANBAN_DRAG_ID;
    window.__KANBAN_DRAG_ID = null;
    qsa(".kanCard", board).forEach(c=>c.classList.remove("kanSelected"));
    if(entryId && status) quickUpdateStatus(entryId, status);
  }

  qsa("[data-dropzone], .kanCol", board).forEach(zone=>{
    const status = zone.dataset.dropzone || zone.dataset.kanStatus;

    zone.addEventListener("dragover", (ev)=>{
      ev.preventDefault();
      zone.classList.add("kanDropHint");
    });

    zone.addEventListener("dragleave", ()=>zone.classList.remove("kanDropHint"));

    zone.addEventListener("drop", (ev)=>{
      ev.preventDefault();
      zone.classList.remove("kanDropHint");

      let entryId = null;
      try{
        entryId = ev.dataTransfer && ev.dataTransfer.getData("text/plain");
      }catch(e){}

      if(entryId) window.__KANBAN_DRAG_ID = entryId;
      kanbanMoveTo(status);
    });

    // Tap-to-move fallback (mobile)
    zone.addEventListener("click", ()=>{
      if(window.__KANBAN_DRAG_ID) kanbanMoveTo(status);
    });
  });


  function quickUpdateStatus(entryId, newStatus){
  const actor = currentActor();
  if(!actor?.perms?.edit) return toast("Sem permissão para editar");
  const db = loadDB();
  const e = db.entries.find(x=>x.id===entryId);
  if(!e) return;
  const old = e.status;
  if(old===newStatus) return;
  e.status = newStatus;
  e.lastUpdateAt = todayISO();
  e.statusLog = e.statusLog || [];
  e.statusLog.push({at: new Date().toISOString(), from: old, to: newStatus, by: actor.name});
  saveDB(db);
  renderAll();
}

}

/* -------- Tasks -------- */
const TASK_ACTIONS = ["Ligar","WhatsApp","Enviar orçamento","Confirmar agendamento","Follow-up","Outros"];

function taskStatusLabel(t){
  const due = t.dueDate ? new Date(t.dueDate+"T00:00:00") : null;
  const today = new Date(new Date().toISOString().slice(0,10)+"T00:00:00");
  const overdue = due && due < today && !t.done;
  if(t.done) return `<span class="chip"><span class="dot ok"></span>Feito</span>`;
  if(overdue) return `<span class="chip"><span class="dot hot"></span>Atrasado</span>`;
  return `<span class="chip"><span class="dot warm"></span>Pendente</span>`;
}

function renderTasks(){
  const actor = currentActor();
  if(!actor) return;
  const db = loadDB();
  const tbody = el("tasksTbody");
  if(!tbody) return;

  const f = getUIFilters();
  const monthKey = f.monthKey;
  const tasks = (db.tasks||[])
    .filter(t=>!t.masterId || t.masterId===actor.masterId)
        .sort((a,b)=> String(a.dueDate||"9999-12-31").localeCompare(String(b.dueDate||"9999-12-31")));

  if(!tasks.length){
    tbody.innerHTML = `<tr><td colspan="6" class="muted">Sem tarefas pendentes no momento.</td></tr>`;
    return;
  }

  const today = new Date(new Date().toISOString().slice(0,10)+"T00:00:00");

  tbody.innerHTML = tasks.map(t=>{
    const e = db.entries.find(x=>x.id===t.entryId);
    const c = e ? db.contacts.find(x=>x.id===e.contactId) : null;
    const due = t.dueDate ? new Date(t.dueDate+"T00:00:00") : null;
    const overdue = due && due < today && !t.done;
    const cls = t.done ? "taskOk" : (overdue ? "taskBad" : "");
    return `
      <tr class="${cls}">
        <td class="nowrap">${taskStatusLabel(t)}</td>
        <td><b>${escapeHTML(t.title||"—")}</b><div class="muted" style="font-size:12px">${escapeHTML(t.action||"")}</div></td>
        <td>${escapeHTML(c?.name||"—")}<div class="muted" style="font-size:12px">${escapeHTML(c?.phone||"")}</div></td>
        <td class="nowrap">${t.dueDate?fmtBR(t.dueDate):"—"}</td>
        <td>${escapeHTML(t.notes||"")}</td>
        <td>
          <div class="taskActionsCell">
            <div class="taskActionsRow">
              <button class="miniBtn" onclick="openTaskEdit('${t.id}')" title="Editar">✏️</button>
              ${`<button class="miniBtn ok" onclick="toggleTaskDone(\'${t.id}\')" title="${t.done?'Reabrir':'Concluir'}">${t.done?'↩️':'✔️'}</button>`}
              <button class="miniBtn danger" onclick="deleteTask('${t.id}')" title="Apagar">🗑️</button>
            </div>
            ${e?`<button class="miniBtn taskOpenLead" onclick="openLeadEntry('${e.id}')">Abrir lead</button>`:""}
          </div>
        </td>
      </tr>
    `;
  }).join("");
}

function openNewTask(){
  const actor = currentActor();
  if(!actor) return;
  const db = loadDB();
  const monthKey = val("fMonth") || new Date().toISOString().slice(0,7);

  // choices from current filtered entries
  const entries = filteredEntries();
  const opts = entries.map(e=>{
    const c = db.contacts.find(x=>x.id===e.contactId);
    return `<option value="${e.id}">${escapeHTML(c?.name||"—")} • ${escapeHTML(c?.phone||"")}</option>`;
  }).join("");

  openModal({
    title:"Nova tarefa",
    sub:"Crie um follow-up com vencimento. O mês do filtro é usado como referência.",
    bodyHTML: `
      <div class="twoCol">
        <div>
          <label>Lead *</label>
          <select id="tf_entry">${opts || `<option value="">(Sem leads no filtro)</option>`}</select>
        </div>
        <div>
          <label>Vencimento *</label>
          <input id="tf_due" type="date" value="${todayISO()}"/>
        </div>
        <div style="grid-column:1/-1">
          <label>Tarefa *</label>
          <input id="tf_title" placeholder="Ex: Ligar e passar valor do orçamento"/>
        </div>
        <div>
          <label>Ação</label>
          <select id="tf_action">${TASK_ACTIONS.map(a=>`<option value="${a}">${a}</option>`).join("")}</select>
        </div>
        <div style="grid-column:1/-1">
          <label>Obs</label>
          <textarea id="tf_notes" placeholder="Contexto, detalhes, objeções..."></textarea>
        </div>
      </div>
    `,
    footHTML: `
      <button class="btn" onclick="closeModal()">Cancelar</button>
      <button class="btn ok" id="btnSaveTask">Salvar</button>
    `,
    onMount: ()=>{
      const btn = el("btnSaveTask");
      btn.addEventListener("click", ()=>{
        const entryId = val("tf_entry");
        const dueDate = val("tf_due");
        const title = val("tf_title").trim();
        const action = val("tf_action");
        const notes = val("tf_notes").trim();
        if(!entryId) return toast("Selecione um lead");
        if(!dueDate) return toast("Informe o vencimento");
        if(!title) return toast("Informe a tarefa");

        const t = {id: uid("task"), masterId: actor.masterId, entryId, dueDate, title, action, notes, done:false, createdAt:new Date().toISOString()};
        db.tasks = db.tasks || [];
        db.tasks.push(t);
        saveDB(db);
        closeModal();
        toast("Tarefa criada");
        renderAll();
      });
    }
  });
}

function openTaskEdit(taskId){
  const actor = currentActor();
  const db = loadDB();
  const t = (db.tasks||[]).find(x=>x.id===taskId);
  if(!t) return toast("Tarefa não encontrada");
  const entry = db.entries.find(e=>e.id===t.entryId);
  const c = entry ? db.contacts.find(x=>x.id===entry.contactId) : null;

  openModal({
    title:"Editar tarefa",
    sub:`Lead: ${c?.name||"—"}`,
    bodyHTML: `
      <div class="twoCol">
        <div>
          <label>Vencimento</label>
          <input id="tf_due" type="date" value="${escapeHTML(t.dueDate||"")}"/>
        </div>
        <div>
          <label>Status</label>
          <select id="tf_done">
            <option value="0" ${t.done?"":"selected"}>Pendente</option>
            <option value="1" ${t.done?"selected":""}>Feito</option>
          </select>
        </div>
        <div style="grid-column:1/-1">
          <label>Tarefa</label>
          <input id="tf_title" value="${escapeHTML(t.title||"")}"/>
        </div>
        <div>
          <label>Ação</label>
          <select id="tf_action">${TASK_ACTIONS.map(a=>`<option value="${a}" ${(t.action===a)?"selected":""}>${a}</option>`).join("")}</select>
        </div>
        <div style="grid-column:1/-1">
          <label>Obs</label>
          <textarea id="tf_notes">${escapeHTML(t.notes||"")}</textarea>
        </div>
      </div>
    `,
    footHTML: `
      <button class="btn" onclick="closeModal()">Fechar</button>
      <button class="btn ok" id="btnSaveTask">Salvar</button>
    `,
    onMount: ()=>{
      el("btnSaveTask").addEventListener("click", ()=>{
        t.dueDate = val("tf_due");
        t.done = el("tf_done").value ==="1";
        t.title = val("tf_title").trim();
        t.action = val("tf_action");
        t.notes = val("tf_notes").trim();
        saveDB(db);
        closeModal();
        toast("Tarefa atualizada");
        renderAll();
      });
    }
  });
}

function toggleTaskDone(taskId){
  const db = loadDB();
  const t = (db.tasks||[]).find(x=>x.id===taskId);
  if(!t) return;
  // toggle done and keep a memory of previous state if you want future audits
  t.done = !t.done;
  saveDB(db);
  toast(t.done ? "Tarefa marcada como feita" : "Tarefa reaberta");
  renderAll();
}
// compat
function markTaskDone(taskId){ return toggleTaskDone(taskId); }
function deleteTask(taskId){
  const actor = currentActor();
  if(!actor?.perms?.edit) return toast("Sem permissão");
  const db = loadDB();
  db.tasks = (db.tasks||[]).filter(t=>t.id!==taskId);
  saveDB(db);
  toast("Tarefa removida");
  renderAll();
}

function renderAll(){
  updateSidebarPills();
  renderDashboard();
  renderLeadsTable(filteredEntries());
renderKanban();
  renderTasks();
  renderInstallmentsView();
  renderUsers();
  renderSettings();
}

/* -------- Boot & bindings -------- */
function bindNav(){
  qsa(".nav button").forEach(b=>{
    b.addEventListener("click", ()=>setActiveView(b.dataset.view));
  });

const bKan = el("btnNewLeadKanban"); if(bKan) bKan.addEventListener("click", openNewLead);
const bTask = el("btnNewTask"); if(bTask) bTask.addEventListener("click", openNewTask);

  // Parcelamentos bindings
  const instMonth = el("instMonth");
  const instSearch = el("instSearch");
  const instFilter = el("instFilter");
  const instRefresh = el("btnInstRefresh");
  if(instMonth) instMonth.addEventListener("change", renderInstallmentsView);
  if(instSearch) instSearch.addEventListener("input", debounce(renderInstallmentsView, 150));
  if(instFilter) instFilter.addEventListener("change", renderInstallmentsView);
  if(instRefresh) instRefresh.addEventListener("click", renderInstallmentsView);

}
function bindActions(){
  el("btnLogout").onclick = ()=>{ clearSession(); toast("Saiu"); showAuth(); };
  el("btnNewLeadSide").onclick = openNewLead;
  el("btnNewLeadTop").onclick = openNewLead;
  el("btnNewLeadList").onclick = openNewLead;

  el("themeToggle").onclick = toggleTheme;
  el("themeToggleAuth").onclick = toggleTheme;

  el("btnClearFilters").onclick = ()=>{
    const f = loadFilters();
    f.search=""; f.status=""; f.treatment=""; f.origin=""; f.firstFrom=""; f.firstTo=""; f.apptFrom=""; f.apptTo="";
    saveFilters(f);
    setUIFilters(f);
    renderAll();
  };

  el("btnExportCSV").onclick = exportCSV;
  el("btnExportPDF").onclick = exportPDFFiltered;

  ["fMonth","fSearch","fStatus","fTreatment","fOrigin","fFirstFrom","fFirstTo","fApptFrom","fApptTo"].forEach(id=>{
    el(id).addEventListener("input", ()=>{
      const f = getUIFilters();
      saveFilters(f);
      renderAll();
    });
    el(id).addEventListener("change", ()=>{
      const f = getUIFilters();
      saveFilters(f);
      // update month options pill etc
      renderAll();
    });
  });

  // Users
  el("btnNewUser").onclick = openNewUser;

  // Settings
  el("btnBackup").onclick = exportJSON;
  el("fileImport").addEventListener("change", (e)=>{
    const f = e.target.files?.[0]; if(f) importJSON(f);
    e.target.value="";
  });
  const dbInitPrefs = loadDB();
  if(el("waTemplate")) el("waTemplate").value = (dbInitPrefs.settings && dbInitPrefs.settings.waTemplate) ? String(dbInitPrefs.settings.waTemplate) : "";
  if(el("waChargeTemplate")) el("waChargeTemplate").value = (dbInitPrefs.settings && dbInitPrefs.settings.waChargeTemplate) ? String(dbInitPrefs.settings.waChargeTemplate) : "";
  const btnPrefs = el("btnSavePrefs");
  if(btnPrefs) btnPrefs.onclick = ()=>{
    const db = loadDB();
    if(!db.settings) db.settings = {};
    db.settings.waTemplate = (val("waTemplate")||"").trim();
    saveDB(db);
    const hint = el("prefsSavedHint");
    if(hint){ hint.textContent = "Salvo."; setTimeout(()=>hint.textContent="", 2000); }
    toast("Preferências salvas.");
  };

  // Parcelamentos: template de cobrança
  const taCharge = el("waChargeTemplate");
  const hintCharge = el("chargeTplSaved");
  const btnSaveCharge = el("btnSaveChargeTpl");
  const btnResetCharge = el("btnResetChargeTpl");
  // carregar valores atuais
  try{
    const db0 = loadDB();
    if(taCharge){
      taCharge.value = (db0.settings && db0.settings.waChargeTemplate) ? String(db0.settings.waChargeTemplate) : "";
    }
  }catch(e){}
  if(btnSaveCharge) btnSaveCharge.onclick = ()=>{
    const db = loadDB();
    if(!db.settings) db.settings = {};
    db.settings.waChargeTemplate = (val("waChargeTemplate")||"").trim();
    saveDB(db);
    if(hintCharge){ hintCharge.textContent = "Salvo."; setTimeout(()=>hintCharge.textContent="", 2000); }
    toast("Cobrança salva.");
  };
  if(btnResetCharge) btnResetCharge.onclick = ()=>{
    const db = loadDB();
    if(!db.settings) db.settings = {};
    db.settings.waChargeTemplate = "";
    saveDB(db);
    if(taCharge) taCharge.value = "";
    if(hintCharge){ hintCharge.textContent = "Padrão restaurado."; setTimeout(()=>hintCharge.textContent="", 2000); }
    toast("Padrão restaurado.");
  };
  // wipe removed for production
}

function bindAuth(){
  el("authMode").addEventListener("change", ()=>{
    const mode = val("authMode");
    const sel = el("authMasterSelect");
    const wrap = el("authMasterNameWrap");
    if(mode==="master"){
      sel.disabled = true;
      wrap.classList.remove("hidden");
      el("authLogin").placeholder = "E-mail do Master";
    }else{
      sel.disabled = false;
      wrap.classList.add("hidden");
      el("authLogin").placeholder = "Usuário ou e-mail";
    }
    refreshAuthMasters();
  });

  el("btnCreateMaster").addEventListener("click", async ()=>{
    const db = loadDB();
    const name = val("authMasterName").trim();
    const email = val("authLogin").trim().toLowerCase();
    const pass = val("authPass");
    if(!name) return toast("Nome da clínica obrigatório");
    if(!email) return toast("E-mail do master obrigatório");
    if(!pass) return toast("Senha obrigatória");
    if(db.masters.some(m=>m.email===email)) return toast("E-mail já existe");

    const passHash = await hashPass(pass);
    const m = { id: uid("m"), name, email, passHash, createdAt: new Date().toISOString() };
    db.masters.push(m);
    saveDB(db);
    saveSession({kind:"master", id:m.id});
    toast("Master criado ✅", name);
    boot();
  });

  el("btnLogin").addEventListener("click", async ()=>{
    const db = loadDB();
    const mode = val("authMode");
    const login = val("authLogin").trim();
    const pass = val("authPass");
    if(!login || !pass) return toast("Preencha login e senha");

    const passHash = await hashPass(pass);

    if(mode==="master"){
      const email = login.toLowerCase();
      const m = db.masters.find(x=>x.email===email && x.passHash===passHash);
      if(!m) return toast("Login inválido");
      saveSession({kind:"master", id:m.id});
      toast("Bem-vindo ✅", m.name);
      boot();
      return;
    }

    // user internal needs selected master
    const masterId = val("authMasterSelect");
    if(!masterId) return toast("Selecione um Master");
    const u = db.users.find(x=>x.masterId===masterId && (x.username===login || (x.email||"").toLowerCase()===login.toLowerCase()) && x.passHash===passHash);
    if(!u) return toast("Login inválido");
    saveSession({kind:"user", id:u.id});
    toast("Bem-vindo ✅", u.name);
    boot();
  });
}

function boot(){
  fillSelectOptions();
  ensureMonthOptions();

  // migração (valores antigos -> novos)
  try{ const db=loadDB(); if(migrateDBValues(db)) saveDB(db); }catch(e){}

  const f = loadFilters();
  if(!f.monthKey) f.monthKey = new Date().toISOString().slice(0,7);
  saveFilters(f);
  setUIFilters(f);

  const actor = currentActor();
  if(!actor){
    showAuth();
    // auth defaults
    el("authMode").value = "master";
    refreshAuthMasters();
    el("authMasterNameWrap").classList.remove("hidden");
    return;
  }

  showApp(actor);

  // disable Users view if not allowed
  const usersBtn = qs('.nav button[data-view="users"]');
  usersBtn.classList.toggle("hidden", !actor.perms.manageUsers);
  el("btnNewUser").classList.toggle("hidden", !actor.perms.manageUsers);

  bindNav();
  renderAll();
  setActiveView("dashboard");
}

/* One-time bindings */
(function init(){
  // theme at start
  applyTheme(localStorage.getItem(THEMEKEY) || "dark");

  bindActions();
  bindAuth();

  boot();
})();

function setupLeadsTopScrollbar(){
  return; // desativado (sem scroll horizontal)
  const card = document.querySelector('.leadsTableWrap');
  if(!card) return;
  const wrap = card.querySelector('.tableWrap');
  const top = card.querySelector('.hscrollTop');
  const inner = card.querySelector('.hscrollTopInner');
  if(!wrap || !top || !inner) return;

  const table = wrap.querySelector('table');
  const width = table ? table.scrollWidth : wrap.scrollWidth;
  inner.style.width = Math.max(width, wrap.clientWidth) + 'px';

  if(!top.dataset.bound){
    top.dataset.bound = '1';
    top.addEventListener('scroll', ()=>{ if(wrap.scrollLeft !== top.scrollLeft) wrap.scrollLeft = top.scrollLeft; }, {passive:true});
    wrap.addEventListener('scroll', ()=>{ if(top.scrollLeft !== wrap.scrollLeft) top.scrollLeft = wrap.scrollLeft; }, {passive:true});
  }
  top.scrollLeft = wrap.scrollLeft;
}


// === PATCH: sincroniza a rolagem horizontal dos Leads (top bar) ===
(function(){
  function setupTopScroll(){
    const leadsView = document.getElementById('view-leads');
    if(!leadsView) return;
    const wrap = leadsView.querySelector('.tableWrap');
    const top = document.getElementById('leadsTopScroll');
    if(!wrap || !top) return;

    const inner = top.querySelector('.inner');
    const table = wrap.querySelector('table');
    if(!inner || !table) return;

    function refresh(){
      // faz o "inner" ter a mesma largura do conteúdo real (table scrollWidth)
      inner.style.width = table.scrollWidth + "px";
      // mantém sincronizado caso alguém tenha mexido no outro
      top.scrollLeft = wrap.scrollLeft;
    }
    // sync listeners (evita loop com flag simples)
    let lock=false;
    top.addEventListener('scroll', ()=>{ if(lock) return; lock=true; wrap.scrollLeft = top.scrollLeft; lock=false; });
    wrap.addEventListener('scroll', ()=>{ if(lock) return; lock=true; top.scrollLeft = wrap.scrollLeft; lock=false; });

    window.addEventListener('resize', refresh);
    // quando tabela re-renderizar, tenta de novo
    const mo = new MutationObserver(()=>refresh());
    mo.observe(wrap, {childList:true, subtree:true});
    refresh();
  }
  // espera DOM pronto
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', setupTopScroll);
  else setupTopScroll();
})();


/* =========================
   Tooltips (Canvas charts)
========================= */
function __ensureChartTooltip(){
  let tip = document.getElementById("chartTooltip");
  if(!tip){
    tip = document.createElement("div");
    tip.id = "chartTooltip";
    document.body.appendChild(tip);
  }
  return tip;
}
function __hideChartTooltip(){
  const tip = document.getElementById("chartTooltip");
  if(tip) tip.style.display = "none";
}
function __showChartTooltip(html, clientX, clientY){
  const tip = __ensureChartTooltip();
  tip.innerHTML = html;
  tip.style.left = clientX + "px";
  tip.style.top = clientY + "px";
  tip.style.display = "block";
}
function __bindChartHoverOnce(canvas){
  if(!canvas || canvas.__ttBound) return;
  canvas.__ttBound = true;

  const rel = (ev)=>{
    const r = canvas.getBoundingClientRect();
    return {x: ev.clientX - r.left, y: ev.clientY - r.top, r};
  };

  canvas.addEventListener("mouseleave", ()=>__hideChartTooltip(), {passive:true});
  canvas.addEventListener("mousemove", (ev)=>{
    const data = canvas.__chartData;
    if(!data){ __hideChartTooltip(); return; }
    const {x, y, r} = rel(ev);

    if(data.type === "multiLine"){
      const {labels, series, pad, top, w, h} = data;
      const innerW = (w - pad - 10);
      if(x < pad || x > pad + innerW || y < top-6 || y > h-8){ __hideChartTooltip(); return; }
      const idx = Math.max(0, Math.min(labels.length-1, Math.round(((x - pad) / innerW) * Math.max(1, labels.length-1))));
      const title = labels[idx] ? `Dia ${labels[idx]}` : `Ponto ${idx+1}`;
      let body = `<div class="ttTitle">${title}</div>`;
      series.forEach(s=>{
        const v = (s.values && s.values[idx]!=null) ? s.values[idx] : 0;
        const val = (data.yPrefix||"") + moneyBR(v);
        body += `<div class="ttRow"><span style="display:flex; gap:8px; align-items:flex-start">
          <span class="ttDot" style="background:${s.color||'rgba(30,120,255,0.9)'}"></span>
          <span>${escapeHTML(s.name||'')}</span>
        </span><b>${val}</b></div>`;
      });
      __showChartTooltip(body, ev.clientX, ev.clientY);
      return;
    }

    if(data.type === "bar"){
      const hit = (data.rects||[]).find(rc => x>=rc.x && x<=rc.x+rc.w && y>=rc.y && y<=rc.y+rc.h);
      if(!hit){ __hideChartTooltip(); return; }
      const title = escapeHTML(hit.label||"");
      const body = `<div class="ttTitle">${title}</div>
        <div class="ttRow"><span>Qtd</span><b>${hit.value||0}</b></div>`;
      __showChartTooltip(body, ev.clientX, ev.clientY);
      return;
    }
  }, {passive:true});
}

/* helper */
function escapeHTML(str){
  return String(str??"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

/* =========================
   KPI click → modal (lista de leads)
========================= */
const KPI_RULES = {
  positive: new Set(["Agendado","Compareceu","Fechou","Remarcou","Conversando"]),
  disqualified: new Set(["Número incorreto","Achou caro","Não tem interesse","Mora longe","Fechou em outro lugar","Mensagem não entregue"])
};
function __kpiBucket(key, rows){
  const list = (rows||[]).slice();
  if(key==="total") return list;
  if(key==="pos") return list.filter(e => KPI_RULES.positive.has((e.status||"").trim()));
  if(key==="bad") return list.filter(e => KPI_RULES.disqualified.has((e.status||"").trim()));
  if(key==="sched") return list.filter(e => ["Agendado","Remarcou"].includes((e.status||"").trim()));
  // dinheiro: mostra tudo (modal informativa) – útil p/ auditoria rápida
  if(key==="budget"||key==="received"||key==="open") return list;
  return list;
}
function __kpiTitle(key){
  return ({
    total:"Total (no filtro atual)",
    pos:"Resultado positivo",
    bad:"Desqualificados",
    sched:"Agendados/Remarcou",
    budget:"Valor orçado (leads no filtro)",
    received:"R$ recebido (leads no filtro)",
    open:"Em aberto (leads no filtro)"
  })[key] || "Detalhes";
}

function __updateKpiActiveUI(){
  try{
    document.querySelectorAll(".kpi[data-kpi]").forEach(k=>{
      const key = k.getAttribute("data-kpi");
      const active = window.__KPI_ACTIVE && window.__KPI_ACTIVE===key && key!=="total";
      k.classList.toggle("kpiActive", !!active);
    });
  }catch(_){}
}
function __applyKpiClick(key){
  // total limpa o filtro; clicar no mesmo KPI alterna on/off
  if(key==="total"){
    window.__KPI_ACTIVE = null;
  } else {
    window.__KPI_ACTIVE = (window.__KPI_ACTIVE===key) ? null : key;
  }
  __updateKpiActiveUI();

  // Vai direto pra lista (sem modal) e re-renderiza com filtro real
  try{ showView("leads"); }catch(_){}
  try{ renderAll(); }catch(_){}
}


// KPI clique instantâneo (delegação): não depende de renderDashboard, nem perde listener ao re-render
(function(){
  if(window.__kpiDelegated) return;
  window.__kpiDelegated = true;
  document.addEventListener("click", (ev)=>{
    const k = ev.target && ev.target.closest ? ev.target.closest(".kpi[data-kpi]") : null;
    if(!k) return;
    const key = k.getAttribute("data-kpi");
    try{ __applyKpiClick(key); }catch(_){}
  }, true);
})();
function __openKpiModal(key){
  const rows = window.__lastDashRows || [];
  const list = __kpiBucket(key, rows);

  const modal = document.getElementById("kpiModal");
  const title = document.getElementById("kpiModalTitle");
  const sub = document.getElementById("kpiModalSub");
  const box = document.getElementById("kpiModalList");
  if(!modal || !title || !sub || !box) return;

  title.textContent = __kpiTitle(key);
  sub.textContent = `${list.length} lead(s)`;
  box.innerHTML = "";

  if(list.length===0){
    box.innerHTML = `<div class="muted">Nada aqui por enquanto.</div>`;
  } else {
    list
      .sort((a,b)=> String(a.name||"").localeCompare(String(b.name||""), "pt-BR"))
      .forEach(e=>{
        const card = document.createElement("div");
        card.className = "leadCard";
        const phone = (e.phone||e.tel||e.whatsapp||"").toString();
        const st = (e.status||"—");
        card.innerHTML = `
          <div class="leadCardMain">
            <div class="leadCardTitle">${escapeHTML(e.name||"Sem nome")}</div>
            <div class="leadCardSub muted">${escapeHTML(phone)} • ${escapeHTML(st)}</div>
          </div>
          <div class="leadCardActions">
            <button class="btn btnSmall">Abrir</button>
          </div>
        `;
        card.querySelector("button").addEventListener("click", ()=>{
          try{ closeModal("kpiModal"); }catch(_){}
          try{ openLead(e.id); }catch(_){}
        });
        box.appendChild(card);
      });
  }

  openModal("kpiModal");
}
function __bindKpiClicks(){
  document.querySelectorAll(".kpi[data-kpi]").forEach(elm=>{
    if(elm.__kpiBound) return;
    elm.__kpiBound = true;
    const key = elm.getAttribute("data-kpi");
    elm.addEventListener("click", ()=>{
      // apenas KPIs "de status" abrem lista; os financeiros também abrem (pra auditoria)
      __applyKpiClick(key);
    });
  });

  const closeBtn = document.getElementById("kpiModalClose");
  if(closeBtn && !closeBtn.__bound){
    closeBtn.__bound = true;
    closeBtn.addEventListener("click", ()=>closeModal("kpiModal"));
  }
  try{ __updateKpiActiveUI(); }catch(_){ }
}

// KPI clicks (delegação): funciona mesmo se os cards forem re-renderizados
(function(){
  if(window.__KPI_DELEGATE_BOUND) return;
  window.__KPI_DELEGATE_BOUND = true;
  document.addEventListener("click", (ev)=>{
    const kpiEl = ev.target && ev.target.closest ? ev.target.closest(".kpi[data-kpi]") : null;
    if(!kpiEl) return;
    // evita conflito com botões internos (ex.: "Abrir" dentro de lista)
    if(ev.target.closest("button, a")) return;

    const key = kpiEl.getAttribute("data-kpi");
    if(!key) return;

    // alterna filtro
    try{
      if(!window.__KPI_ACTIVE || window.__KPI_ACTIVE==="total"){
        window.__KPI_ACTIVE = key;
      }else if(window.__KPI_ACTIVE===key){
        window.__KPI_ACTIVE = "total";
      }else{
        window.__KPI_ACTIVE = key;
      }
    }catch(_){ window.__KPI_ACTIVE = key; }

    // marca visual
    try{
      document.querySelectorAll(".kpi[data-kpi]").forEach(x=>x.classList.toggle("kpiActive", x.getAttribute("data-kpi")===window.__KPI_ACTIVE && window.__KPI_ACTIVE!=="total"));
      if(window.__KPI_ACTIVE==="total") document.querySelectorAll(".kpi[data-kpi]").forEach(x=>x.classList.remove("kpiActive"));
    }catch(_){}

    // re-render geral
    try{ renderAll(); }catch(_){}
  }, true);
})();



/* garante que, sempre que o dashboard renderizar, o clique funcione */
(function(){
  const _origRenderDashboard = window.renderDashboard;
  if(typeof _origRenderDashboard === "function" && !_origRenderDashboard.__wrappedKpi){
    const wrapped = function(...args){
      const ret = _origRenderDashboard.apply(this, args);
      try{ __bindKpiClicks(); }catch(_){}
      return ret;
    };
    wrapped.__wrappedKpi = true;
    window.renderDashboard = wrapped;
  }
})();

</script>

<div id="chartTooltip" aria-hidden="true"></div>

<div id="kpiModal" class="modal hidden" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modalInner" style="max-width:720px">
    <div class="modalHeader">
      <div>
        <div class="muted" style="font-size:12px">KPIs</div>
        <div id="kpiModalTitle" style="font-size:18px; font-weight:800">Detalhes</div>
      </div>
      <button class="btn" id="kpiModalClose">Fechar</button>
    </div>
    <div class="modalBody" style="padding-top:10px">
      <div class="muted" id="kpiModalSub" style="margin-bottom:10px"></div>
      <div id="kpiModalList" class="stack" style="gap:10px"></div>
    </div>
  </div>
</div>

</body>
</html>
